<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.12 Documentation: User-defined Functions</title>
    <link rel="shortcut icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="//ci.apache.org/projects/flink/flink-docs-stable/dev/table/functions/udfs.html">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/flink.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/syntax.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/codetabs.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/font-awesome/css/font-awesome.min.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    

    <!-- Main content. -->
    <div class="container">
      
      <div class="row">
        <div class="col-lg-3" id="sidenavcol">
          <div class="sidenav-logo">
  <p><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/"><img class="bottom" alt="Apache Flink" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/img/navbar-brand-logo.jpg"></a> v1.12</p>
</div>
<ul id="sidenav">
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/"><i class="fa fa-home title" aria-hidden="true"></i> Home</a></li><hr class="section-break"></hr>
<li><a href="#collapse-2" data-toggle="collapse"><i class="fa fa-rocket title appetizer" aria-hidden="true"></i> Try Flink<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-2"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/local_installation.html">Local Installation</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/datastream_api.html">Fraud Detection with the DataStream API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/table_api.html">Real Time Reporting with the Table API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/flink-operations-playground.html">Flink Operations Playground</a></li>
</ul></div></li>
<li><a href="#collapse-8" data-toggle="collapse"><i class="fa fa-hand-paper-o title appetizer" aria-hidden="true"></i> Learn Flink<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-8"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/datastream_api.html">Intro to the DataStream API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/etl.html">Data Pipelines & ETL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/streaming_analytics.html">Streaming Analytics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/event_driven.html">Event-driven Applications</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/fault_tolerance.html">Fault Tolerance</a></li>
</ul></div></li>
<li><a href="#collapse-15" data-toggle="collapse"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i> Concepts<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-15"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/index.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/stateful-stream-processing.html">Stateful Stream Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/timely-stream-processing.html">Timely Stream Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/flink-architecture.html">Flink Architecture</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/glossary.html">Glossary</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-21" data-toggle="collapse"class="active"><i class="fa fa-code title maindish" aria-hidden="true"></i> Application Development</a><div class="collapse in" id="collapse-21"><ul>
<li><a href="#collapse-22" data-toggle="collapse">DataStream API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-22"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/datastream_api.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/datastream_execution_mode.html">Execution Mode (Batch/Streaming)</a></li>
<li><a href="#collapse-24" data-toggle="collapse">Event Time<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-24"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_time.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html">Generating Watermarks</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamp_extractors.html">Builtin Watermark Generators</a></li>
</ul></div></li>
<li><a href="#collapse-28" data-toggle="collapse">State & Fault Tolerance<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-28"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/state.html">Working with State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/broadcast_state.html">The Broadcast State Pattern</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/checkpointing.html">Checkpointing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/queryable_state.html">Queryable State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/schema_evolution.html">State Schema Evolution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/custom_serialization.html">Custom State Serialization</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/user_defined_functions.html">User-Defined Functions</a></li>
<li><a href="#collapse-38" data-toggle="collapse">Operators<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-38"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/windows.html">Windows</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/joining.html">Joining</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/process_function.html">Process Function</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/asyncio.html">Async I/O</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/sources.html">Data Sources</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/side_output.html">Side Outputs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/application_parameters.html">Handling Application Parameters</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/testing.html">Testing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/experimental.html">Experimental Features</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/scala_api_extensions.html">Scala API Extensions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/java_lambdas.html">Java Lambda Expressions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/project-configuration.html">Project Configuration</a></li>
</ul></div></li>
<li><a href="#collapse-53" data-toggle="collapse">DataSet API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-53"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/dataset_transformations.html">Transformations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/iterations.html">Iterations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/zip_elements_guide.html">Zipping Elements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/hadoop_compatibility.html">Hadoop Compatibility</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/local_execution.html">Local Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/cluster_execution.html">Cluster Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/examples.html">Batch Examples</a></li>
</ul></div></li>
<li><a href="#collapse-62" data-toggle="collapse"class="active">Table API & SQL</a><div class="collapse in" id="collapse-62"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/common.html">Concepts & Common API</a></li>
<li><a href="#collapse-64" data-toggle="collapse">Streaming Concepts<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-64"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/dynamic_tables.html">Dynamic Tables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/time_attributes.html">Time Attributes</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/joins.html">Joins in Continuous Queries</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/temporal_tables.html">Temporal Tables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/match_recognize.html">Detecting Patterns</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/query_configuration.html">Query Configuration</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/tableApi.html">Table API</a></li>
<li><a href="#collapse-74" data-toggle="collapse">SQL<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-74"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/queries.html">Queries</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/create.html">CREATE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/drop.html">DROP Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/alter.html">ALTER Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/insert.html">INSERT Statement</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/hints.html">SQL Hints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/describe.html">DESCRIBE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/explain.html">EXPLAIN Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/use.html">USE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/show.html">SHOW Statements</a></li>
</ul></div></li>
<li><a href="#collapse-86" data-toggle="collapse"class="active">Functions</a><div class="collapse in" id="collapse-86"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/systemFunctions.html">System (Built-in) Functions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/udfs.html" class="active">User-defined Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/modules.html">Modules</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sqlClient.html">SQL Client</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/config.html">Configuration</a></li>
<li><a href="#collapse-94" data-toggle="collapse">Performance Tuning<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-94"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/tuning/streaming_aggregation_optimization.html">Streaming Aggregation</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sourceSinks.html">User-defined Sources & Sinks</a></li>
</ul></div></li>
<li><a href="#collapse-99" data-toggle="collapse">Python API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-99"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/installation.html">Installation</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table_api_tutorial.html">Table API Tutorial</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream_tutorial.html">DataStream API Tutorial</a></li>
<li><a href="#collapse-103" data-toggle="collapse">Table API User's Guide<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-103"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/intro_to_table_api.html">Intro to the Python Table API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/table_environment.html">TableEnvironment</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/operations.html">Operations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/python_types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/built_in_functions.html">System (Built-in) Functions</a></li>
<li><a href="#collapse-109" data-toggle="collapse">User Defined Functions<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-109"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html">General User-defined Functions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/vectorized_python_udfs.html">Vectorized User-defined Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/conversion_of_pandas.html">Conversions between PyFlink Table and Pandas DataFrame</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/dependency_management.html">Dependency Management</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/sql.html">SQL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/metrics.html">Metrics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/python_table_api_connectors.html">Connectors</a></li>
</ul></div></li>
<li><a href="#collapse-120" data-toggle="collapse">DataStream API User's Guide<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-120"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/data_types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/operators.html">Operators</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/dependency_management.html">Dependency Management</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/python_config.html">Configuration</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/environment_variables.html">Environment Variables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/faq.html">FAQ</a></li>
</ul></div></li>
<li><a href="#collapse-129" data-toggle="collapse">Data Types & Serialization<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-129"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/types_serialization.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/custom_serializers.html">Custom Serializers</a></li>
</ul></div></li>
<li><a href="#collapse-132" data-toggle="collapse">Managing Execution<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-132"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/execution_configuration.html">Execution Configuration</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/packaging.html">Program Packaging</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/parallel.html">Parallel Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/execution_plans.html">Execution Plans</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/task_failure_recovery.html">Task Failure Recovery</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/migration.html">API Migration Guides</a></li>
</ul></div></li>
<li><a href="#collapse-141" data-toggle="collapse"><i class="fa fa-book title maindish" aria-hidden="true"></i> Libraries<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-141"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/cep.html">Event Processing (CEP)</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/state_processor_api.html">State Processor API</a></li>
<li><a href="#collapse-144" data-toggle="collapse">Graphs: Gelly<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-144"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_api.html">Graph API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/iterative_graph_processing.html">Iterative Graph Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/library_methods.html">Library Methods</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_algorithms.html">Graph Algorithms</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_generators.html">Graph Generators</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/bipartite_graph.html">Bipartite Graph</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-153" data-toggle="collapse"><i class="fa fa-random title maindish" aria-hidden="true"></i> Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-153"><ul>
<li><a href="#collapse-154" data-toggle="collapse">DataStream Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-154"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/guarantees.html">Fault Tolerance Guarantees</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/cassandra.html">Cassandra</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/file_sink.html">File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/streamfile_sink.html">Streaming File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/rabbitmq.html">RabbitMQ</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/nifi.html">NiFi</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/pubsub.html">Google Cloud PubSub</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/twitter.html">Twitter</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/jdbc.html">JDBC</a></li>
</ul></div></li>
<li><a href="#collapse-168" data-toggle="collapse">Table & SQL Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-168"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/">Overview</a></li>
<li><a href="#collapse-169" data-toggle="collapse">Formats<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-169"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/csv.html">CSV</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/json.html">JSON</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/avro-confluent.html">Confluent Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/avro.html">Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/debezium.html">Debezium</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/canal.html">Canal</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/maxwell.html">Maxwell</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/parquet.html">Parquet</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/orc.html">Orc</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/raw.html">Raw</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/upsert-kafka.html">Upsert Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/jdbc.html">JDBC</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/filesystem.html">FileSystem</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hbase.html">HBase</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/datagen.html">DataGen</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/print.html">Print</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/blackhole.html">BlackHole</a></li>
<li><a href="#collapse-191" data-toggle="collapse">Hive<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-191"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_catalog.html">Hive Catalog</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_dialect.html">Hive Dialect</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_read_write.html">Hive Read & Write</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_functions.html">Hive Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/downloads.html">Download</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/connectors.html">DataSet Connectors</a></li>
</ul></div></li>
<li><a href="#collapse-201" data-toggle="collapse"><i class="fa fa-sliders title maindish" aria-hidden="true"></i> Deployment<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-201"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/">Overview</a></li>
<li><a href="#collapse-202" data-toggle="collapse">Resource Providers<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-202"><ul>
<li><a href="#collapse-203" data-toggle="collapse">Standalone<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-203"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/local.html">Local Cluster</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/docker.html">Docker</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/kubernetes.html">Kubernetes</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/native_kubernetes.html">Native Kubernetes</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/yarn.html">YARN</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/mesos.html">Mesos</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/config.html">Configuration</a></li>
<li><a href="#collapse-213" data-toggle="collapse">Memory Configuration<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-213"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup.html">Set up Flink's Process Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup_tm.html">Set up TaskManager Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup_jobmanager.html">Set up JobManager Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_tuning.html">Memory tuning guide</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_trouble.html">Troubleshooting</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_migration.html">Migration Guide</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/cli.html">Command-Line Interface</a></li>
<li><a href="#collapse-222" data-toggle="collapse">File Systems<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-222"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/common.html">Common Configurations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/s3.html">Amazon S3</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/oss.html">Aliyun OSS</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/azure.html">Azure Blob Storage</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/plugins.html">Plugins</a></li>
</ul></div></li>
<li><a href="#collapse-229" data-toggle="collapse">High Availability (HA)<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-229"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/zookeeper_ha.html">ZooKeeper HA Services</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/kubernetes_ha.html">Kubernetes HA Services</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/metric_reporters.html">Metric Reporters</a></li>
<li><a href="#collapse-234" data-toggle="collapse">Security<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-234"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/security/security-ssl.html">SSL Setup</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/security/security-kerberos.html">Kerberos</a></li>
</ul></div></li>
<li><a href="#collapse-238" data-toggle="collapse">REPLs<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-238"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/repls/python_shell.html">Python REPL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/repls/scala_shell.html">Scala REPL</a></li>
</ul></div></li>
<li><a href="#collapse-242" data-toggle="collapse">Advanced<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-242"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/external_resources.html">External Resources</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/historyserver.html">History Server</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/logging.html">Logging</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-248" data-toggle="collapse"><i class="fa fa-cogs title maindish" aria-hidden="true"></i> Operations<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-248"><ul>
<li><a href="#collapse-249" data-toggle="collapse">State & Fault Tolerance<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-249"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/checkpoints.html">Checkpoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/savepoints.html">Savepoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/large_state_tuning.html">Tuning Checkpoints and Large State</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html">Metrics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/rest_api.html">REST API</a></li>
<li><a href="#collapse-257" data-toggle="collapse">Debugging<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-257"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/debugging_event_time.html">Debugging Windows & Event Time</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/debugging_classloading.html">Debugging Classloading</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/application_profiling.html">Application Profiling & Debugging</a></li>
</ul></div></li>
<li><a href="#collapse-262" data-toggle="collapse">Monitoring<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-262"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/monitoring/checkpoint_monitoring.html">Monitoring Checkpointing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/monitoring/back_pressure.html">Monitoring Back Pressure</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/upgrading.html">Upgrading Applications and Flink Versions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/production_ready.html">Production Readiness Checklist</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-269" data-toggle="collapse"><i class="fa fa-cogs title dessert" aria-hidden="true"></i> Flink Development<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-269"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/flinkDev/ide_setup.html">Importing Flink into an IDE</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/flinkDev/building.html">Building Flink from Source</a></li>
</ul></div></li>
<li><a href="#collapse-273" data-toggle="collapse"><i class="fa fa-book title dessert" aria-hidden="true"></i> Internals<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-273"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/job_scheduling.html">Jobs and Scheduling</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/task_lifecycle.html">Task Lifecycle</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/filesystems.html">File Systems</a></li>
</ul></div></li>
  <li class="divider"></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/java"><i class="fa fa-external-link title" aria-hidden="true"></i> Javadocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/scala/index.html#org.apache.flink.api.scala.package"><i class="fa fa-external-link title" aria-hidden="true"></i> Scaladocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/python"><i class="fa fa-external-link title" aria-hidden="true"></i> Pythondocs</a></li>
  <li><a href="http://flink.apache.org"><i class="fa fa-external-link title" aria-hidden="true"></i> Project Page</a></li>
</ul>

<div class="sidenav-search-box">
  <form class="navbar-form" role="search" action="//ci.apache.org/projects/flink/flink-docs-release-1.12/search-results.html">
    <div class="form-group">
      <input type="text" class="form-control" size="16px" name="q" placeholder="Search">
    </div>
    <button type="submit" class="btn btn-default">Go</button>
  </form>
</div>

<div class="sidenav-versions">
  <div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Pick Docs Version<span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.11">v1.11</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.10">v1.10</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.9">v1.9</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.8">v1.8</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.7">v1.7</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.6">v1.6</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.5">v1.5</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.4">v1.4</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.3">v1.3</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.2">v1.2</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.1">v1.1</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0">v1.0</a></li>
    </ul>
  </div>
</div>

<div class="sidenav-languages"><!-- link to the Chinese home page when current is blog page -->
    <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html">
      <button type="submit" class="btn btn-default">中文版</button>
    </a>
</div>

        </div>
        <div class="col-lg-9 content" id="contentcol">

          

<ol class="breadcrumb">
  
    <li><i class="fa fa-code title maindish" aria-hidden="true"></i> Application Development</li>
  
    <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/">Table API & SQL</a></li>
  
    <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/">Functions</a></li>
  
    <li class="active">User-defined Functions</li>
</ol>

<h1>User-defined Functions</h1>




<p>User-defined functions (UDFs) are extension points to call frequently used logic or custom logic that cannot be expressed otherwise in queries.</p>

<p>User-defined functions can be implemented in a JVM language (such as Java or Scala) or Python.
An implementer can use arbitrary third party libraries within a UDF.
This page will focus on JVM-based languages, please refer to the PyFlink documentation
for details on writing <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html">general</a> 
 and <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/vectorized_python_udfs.html">vectorized</a> UDFs in Python.</p>

<ul id="markdown-toc">
  <li><a href="#overview" id="markdown-toc-overview">Overview</a></li>
  <li><a href="#implementation-guide" id="markdown-toc-implementation-guide">Implementation Guide</a>    <ul>
      <li><a href="#function-class" id="markdown-toc-function-class">Function Class</a></li>
      <li><a href="#evaluation-methods" id="markdown-toc-evaluation-methods">Evaluation Methods</a></li>
      <li><a href="#type-inference" id="markdown-toc-type-inference">Type Inference</a></li>
      <li><a href="#determinism" id="markdown-toc-determinism">Determinism</a></li>
      <li><a href="#runtime-integration" id="markdown-toc-runtime-integration">Runtime Integration</a></li>
    </ul>
  </li>
  <li><a href="#scalar-functions" id="markdown-toc-scalar-functions">Scalar Functions</a></li>
  <li><a href="#table-functions" id="markdown-toc-table-functions">Table Functions</a></li>
  <li><a href="#aggregate-functions" id="markdown-toc-aggregate-functions">Aggregate Functions</a>    <ul>
      <li><a href="#mandatory-and-optional-methods" id="markdown-toc-mandatory-and-optional-methods">Mandatory and Optional Methods</a></li>
    </ul>
  </li>
  <li><a href="#table-aggregate-functions" id="markdown-toc-table-aggregate-functions">Table Aggregate Functions</a>    <ul>
      <li><a href="#mandatory-and-optional-methods-1" id="markdown-toc-mandatory-and-optional-methods-1">Mandatory and Optional Methods</a></li>
      <li><a href="#retraction-example" id="markdown-toc-retraction-example">Retraction Example</a></li>
    </ul>
  </li>
</ul>

<h2 id="overview">Overview</h2>

<p>Currently, Flink distinguishes between the following kinds of functions:</p>

<ul>
  <li><em>Scalar functions</em> map scalar values to a new scalar value.</li>
  <li><em>Table functions</em> map scalar values to new rows.</li>
  <li><em>Aggregate functions</em> map scalar values of multiple rows to a new scalar value.</li>
  <li><em>Table aggregate functions</em> map scalar values of multiple rows to new rows.</li>
  <li><em>Async table functions</em> are special functions for table sources that perform a lookup.</li>
</ul>

<p>The following example shows how to create a simple scalar function and how to call the function in both Table API and SQL.</p>

<p>For SQL queries, a function must always be registered under a name. For Table API, a function can be registered or directly used <em>inline</em>.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// define function logic</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="nc">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// call registered function in SQL</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT SubstringFunction(myField, 5, 12) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="c1">// define function logic</span>
<span class="k">class</span> <span class="nc">SubstringFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">])</span>

<span class="c1">// call registered function in Table API</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// call registered function in SQL</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT SubstringFunction(myField, 5, 12) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>For interactive sessions, it is also possible to parameterize functions before using or
registering them. In this case, function <em>instances</em> instead of function <em>classes</em> can be
used as temporary functions.</p>

<p>It requires that the parameters are serializable for shipping
function instances to the cluster.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// define parameterizable function logic</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SubstringFunction</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">endInclusive</span> <span class="o">=</span> <span class="n">endInclusive</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">end</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="c1">// define parameterizable function logic</span>
<span class="k">class</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="k">val</span> <span class="nv">endInclusive</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">substring</span><span class="o">(</span><span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">:</span> <span class="kt">end</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span></code></pre></figure>

  </div>

</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="implementation-guide">Implementation Guide</h2>

<p>Independent of the kind of function, all user-defined functions follow some basic implementation principles.</p>

<h3 id="function-class">Function Class</h3>

<p>An implementation class must extend from one of the available base classes (e.g. <code class="highlighter-rouge">org.apache.flink.table.functions.ScalarFunction</code>).</p>

<p>The class must be declared <code class="highlighter-rouge">public</code>, not <code class="highlighter-rouge">abstract</code>, and should be globally accessible. Thus, non-static inner or anonymous classes are not allowed.</p>

<p>For storing a user-defined function in a persistent catalog, the class must have a default constructor and must be instantiable during runtime.</p>

<h3 id="evaluation-methods">Evaluation Methods</h3>

<p>The base class provides a set of methods that can be overridden such as <code class="highlighter-rouge">open()</code>, <code class="highlighter-rouge">close()</code>, or <code class="highlighter-rouge">isDeterministic()</code>.</p>

<p>However, in addition to those declared methods, the main runtime logic that is applied to every incoming record must be implemented through specialized <em>evaluation methods</em>.</p>

<p>Depending on the function kind, evaluation methods such as <code class="highlighter-rouge">eval()</code>, <code class="highlighter-rouge">accumulate()</code>, or <code class="highlighter-rouge">retract()</code> are called by code-generated operators during runtime.</p>

<p>The methods must be declared <code class="highlighter-rouge">public</code> and take a well-defined set of arguments.</p>

<p>Regular JVM method calling semantics apply. Therefore, it is possible to:</p>
<ul>
  <li>implement overloaded methods such as <code class="highlighter-rouge">eval(Integer)</code> and <code class="highlighter-rouge">eval(LocalDateTime)</code>,</li>
  <li>use var-args such as <code class="highlighter-rouge">eval(Integer...)</code>,</li>
  <li>use object inheritance such as <code class="highlighter-rouge">eval(Object)</code> that takes both <code class="highlighter-rouge">LocalDateTime</code> and <code class="highlighter-rouge">Integer</code>,</li>
  <li>and combinations of the above such as <code class="highlighter-rouge">eval(Object...)</code> that takes all kinds of arguments.</li>
</ul>

<p>If you intend to implement functions in Scala, please add the <code class="highlighter-rouge">scala.annotation.varargs</code> annotation in
case of variable arguments. Furthermore, it is recommended to use boxed primitives (e.g. <code class="highlighter-rouge">java.lang.Integer</code>
instead of <code class="highlighter-rouge">Int</code>) to support <code class="highlighter-rouge">NULL</code>.</p>

<p>The following snippets shows an example of an overloaded function:</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SumFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">a</span><span class="o">,</span> <span class="nc">String</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Double</span><span class="o">...</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">value</span> <span class="o">:</span> <span class="n">d</span><span class="o">)</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
<span class="k">import</span> <span class="nn">java.lang.Integer</span>
<span class="k">import</span> <span class="nn">java.lang.Double</span>
<span class="k">import</span> <span class="nn">scala.annotation.varargs</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="k">class</span> <span class="nc">SumFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">Integer</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">b</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="nd">@varargs</span> <span class="c1">// generate var-args like Java</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">d</span><span class="o">.</span><span class="py">sum</span><span class="o">.</span><span class="py">toInt</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h3 id="type-inference">Type Inference</h3>

<p>The table ecosystem (similar to the SQL standard) is a strongly typed API. Therefore, both function parameters and return types must be mapped to a <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/types.html">data type</a>.</p>

<p>From a logical perspective, the planner needs information about expected types, precision, and scale. From a JVM perspective, the planner needs information about how internal data structures are represented as JVM objects when calling a user-defined function.</p>

<p>The logic for validating input arguments and deriving data types for both the parameters and the result of a function is summarized under the term <em>type inference</em>.</p>

<p>Flink’s user-defined functions implement an automatic type inference extraction that derives data types from the function’s class and its evaluation methods via reflection. If this implicit reflective extraction approach is not successful, the extraction process can be supported by annotating affected parameters, classes, or methods with <code class="highlighter-rouge">@DataTypeHint</code> and <code class="highlighter-rouge">@FunctionHint</code>. More examples on how to annotate functions are shown below.</p>

<p>If more advanced type inference logic is required, an implementer can explicitly override the <code class="highlighter-rouge">getTypeInference()</code> method in every user-defined function. However, the annotation approach is recommended because it keeps custom type inference logic close to the affected locations and falls back to the default behavior for the remaining implementation.</p>

<h4 id="automatic-type-inference">Automatic Type Inference</h4>

<p>The automatic type inference inspects the function’s class and evaluation methods to derive data types for the arguments and result of a function. <code class="highlighter-rouge">@DataTypeHint</code> and <code class="highlighter-rouge">@FunctionHint</code> annotations support the automatic extraction.</p>

<p>For a full list of classes that can be implicitly mapped to a data type, see the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/types.html#data-type-extraction">data type extraction section</a>.</p>

<p><strong><code class="highlighter-rouge">@DataTypeHint</code></strong></p>

<p>In many scenarios, it is required to support the automatic extraction <em>inline</em> for paramaters and return types of a function</p>

<p>The following example shows how to use data type hints. More information can be found in the documentation of the annotation class.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// no hint required</span>
  <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">long</span> <span class="n">a</span><span class="o">,</span> <span class="kt">long</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// define the precision and scale of a decimal</span>
  <span class="kd">public</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"DECIMAL(12, 3)"</span><span class="o">)</span> <span class="nc">BigDecimal</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// define a nested data type</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, t TIMESTAMP(3) WITH LOCAL TIME ZONE&gt;"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Row</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// allow wildcard input and customly serialized output</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"RAW"</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">ByteBuffer</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">MyUtils</span><span class="o">.</span><span class="na">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>
<span class="k">import</span> <span class="nn">scala.annotation.varargs</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// no hint required</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
  <span class="o">}</span>

  <span class="c1">// define the precision and scale of a decimal</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"DECIMAL(12, 3)"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">double</span> <span class="n">a</span><span class="o">,</span> <span class="n">double</span> <span class="n">b</span><span class="o">)</span><span class="k">:</span> <span class="kt">BigDecimal</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">java</span><span class="o">.</span><span class="py">lang</span><span class="o">.</span><span class="py">BigDecimal</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// define a nested data type</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, t TIMESTAMP(3) WITH LOCAL TIME ZONE&gt;"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Int</span> <span class="n">i</span><span class="o">)</span><span class="k">:</span> <span class="kt">Row</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">java</span><span class="o">.</span><span class="py">lang</span><span class="o">.</span><span class="py">String</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="nv">java</span><span class="o">.</span><span class="py">time</span><span class="o">.</span><span class="py">Instant</span><span class="o">.</span><span class="py">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="c1">// allow wildcard input and customly serialized output</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="k">=</span> <span class="s">"RAW"</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="k">=</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">java.nio.ByteBuffer</span><span class="o">])</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nv">InputGroup</span><span class="o">.</span><span class="py">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span><span class="k">:</span> <span class="kt">java.nio.ByteBuffer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">MyUtils</span><span class="o">.</span><span class="py">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">@FunctionHint</code></strong></p>

<p>In some scenarios, it is desirable that one evaluation method handles multiple different data types at the same time. Furthermore, in some scenarios, overloaded evaluation methods have a common result type that should be declared only once.</p>

<p>The <code class="highlighter-rouge">@FunctionHint</code> annotation can provide a mapping from argument data types to a result data type. It enables annotating entire function classes or evaluation methods for input, accumulator, and result data types. One or more annotations can be declared on top of a class or individually for each evaluation method for overloading function signatures. All hint parameters are optional. If a parameter is not defined, the default reflection-based extraction is used. Hint parameters defined on top of a function class are inherited by all evaluation methods.</p>

<p>The following example shows how to use function hints. More information can be found in the documentation of the annotation class.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="c1">// but globally defined output type</span>
<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, i INT&gt;"</span><span class="o">))</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Sum"</span><span class="o">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// overloading of arguments is still possible</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Empty args"</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// decouples the type inference from evaluation methods,</span>
<span class="c1">// the type inference is entirely determined by the function hints</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BOOLEAN"</span><span class="o">)</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// an implementer just needs to make sure that a method exists</span>
  <span class="c1">// that can be called by the JVM</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">collect</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">collect</span><span class="o">(</span><span class="n">o</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="c1">// but globally defined output type</span>
<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, i INT&gt;"</span><span class="o">))</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"Sum"</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)))</span>
  <span class="o">}</span>

  <span class="c1">// overloading of arguments is still possible</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"Empty args"</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(-</span><span class="mi">1</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// decouples the type inference from evaluation methods,</span>
<span class="c1">// the type inference is entirely determined by the function hints</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BOOLEAN"</span><span class="o">)</span>
<span class="o">)</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">AnyRef</span><span class="o">]</span> <span class="o">{</span>

  <span class="c1">// an implementer just needs to make sure that a method exists</span>
  <span class="c1">// that can be called by the JVM</span>
  <span class="nd">@varargs</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef*</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">o</span><span class="o">.</span><span class="py">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">collect</span><span class="o">(</span><span class="nv">Boolean</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nf">o</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h4 id="custom-type-inference">Custom Type Inference</h4>

<p>For most scenarios, <code class="highlighter-rouge">@DataTypeHint</code> and <code class="highlighter-rouge">@FunctionHint</code> should be sufficient to model user-defined functions. However, by overriding the automatic type inference defined in <code class="highlighter-rouge">getTypeInference()</code>, implementers can create arbitrary functions that behave like built-in system functions.</p>

<p>The following example implemented in Java illustrates the potential of a custom type inference logic. It uses a string literal argument to determine the result type of a function. The function takes two string arguments: the first argument represents the string to be parsed, the second argument represents the target type.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.DataTypes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.catalog.DataTypeFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.types.inference.TypeInference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LiteralFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"INT"</span><span class="o">:</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="k">case</span> <span class="s">"DOUBLE"</span><span class="o">:</span>
        <span class="k">return</span> <span class="nc">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="k">case</span> <span class="s">"STRING"</span><span class="o">:</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// the automatic, reflection-based type inference is disabled and</span>
  <span class="c1">// replaced by the following logic</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">TypeInference</span> <span class="nf">getTypeInference</span><span class="o">(</span><span class="nc">DataTypeFactory</span> <span class="n">typeFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">TypeInference</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
      <span class="c1">// specify typed arguments</span>
      <span class="c1">// parameters will be casted implicitly to those types if necessary</span>
      <span class="o">.</span><span class="na">typedArguments</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">(),</span> <span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">())</span>
      <span class="c1">// specify a strategy for the result data type of the function</span>
      <span class="o">.</span><span class="na">outputTypeStrategy</span><span class="o">(</span><span class="n">callContext</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentLiteral</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentNull</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">callContext</span><span class="o">.</span><span class="na">newValidationError</span><span class="o">(</span><span class="s">"Literal expected for second argument."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// return a data type based on a literal</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">literal</span> <span class="o">=</span> <span class="n">callContext</span><span class="o">.</span><span class="na">getArgumentValue</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="s">"STRING"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">literal</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="s">"INT"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">INT</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
          <span class="k">case</span> <span class="s">"DOUBLE"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">DOUBLE</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
          <span class="k">case</span> <span class="s">"STRING"</span><span class="o">:</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">());</span>
        <span class="o">}</span>
      <span class="o">})</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h3 id="determinism">Determinism</h3>

<p>Every user-defined function class can declare whether it produces deterministic results or not by overriding
the <code class="highlighter-rouge">isDeterministic()</code> method. If the function is not purely functional (like <code class="highlighter-rouge">random()</code>, <code class="highlighter-rouge">date()</code>, or <code class="highlighter-rouge">now()</code>),
the method must return <code class="highlighter-rouge">false</code>. By default, <code class="highlighter-rouge">isDeterministic()</code> returns <code class="highlighter-rouge">true</code>.</p>

<p>Furthermore, the <code class="highlighter-rouge">isDeterministic()</code> method might also influence the runtime behavior. A runtime
implementation might be called at two different stages:</p>

<p><strong>During planning (i.e. pre-flight phase)</strong>: If a function is called with constant expressions
or constant expressions can be derived from the given statement, a function is pre-evaluated
for constant expression reduction and might not be executed on the cluster anymore. Unless
<code class="highlighter-rouge">isDeterministic()</code> is used to disable constant expression reduction in this case. For example,
the following calls to <code class="highlighter-rouge">ABS</code> are executed during planning: <code class="highlighter-rouge">SELECT ABS(-1) FROM t</code> and
<code class="highlighter-rouge">SELECT ABS(field) FROM t WHERE field = -1</code>; whereas <code class="highlighter-rouge">SELECT ABS(field) FROM t</code> is not.</p>

<p><strong>During runtime (i.e. cluster execution)</strong>: If a function is called with non-constant expressions
or <code class="highlighter-rouge">isDeterministic()</code> returns <code class="highlighter-rouge">false</code>.</p>

<h3 id="runtime-integration">Runtime Integration</h3>

<p>Sometimes it might be necessary for a user-defined function to get global runtime information or do some setup/clean-up work before the actual work. User-defined functions provide <code class="highlighter-rouge">open()</code> and <code class="highlighter-rouge">close()</code> methods that can be overridden and provide similar functionality as the methods in <code class="highlighter-rouge">RichFunction</code> of DataStream API.</p>

<p>The <code class="highlighter-rouge">open()</code> method is called once before the evaluation method. The <code class="highlighter-rouge">close()</code> method after the last call to the evaluation method.</p>

<p>The <code class="highlighter-rouge">open()</code> method provides a <code class="highlighter-rouge">FunctionContext</code> that contains information about the context in which user-defined functions are executed, such as the metric group, the distributed cache files, or the global job parameters.</p>

<p>The following information can be obtained by calling the corresponding methods of <code class="highlighter-rouge">FunctionContext</code>:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Method</th>
      <th style="text-align: left">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getMetricGroup()</code></td>
      <td style="text-align: left">Metric group for this parallel subtask.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getCachedFile(name)</code></td>
      <td style="text-align: left">Local temporary file copy of a distributed cache file.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getJobParameter(name, defaultValue)</code></td>
      <td style="text-align: left">Global job parameter value associated with given key.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getExternalResourceInfos(resourceName)</code></td>
      <td style="text-align: left">Returns a set of external resource infos associated with the given key.</td>
    </tr>
  </tbody>
</table>

<p><strong>Note</strong>: Depending on the context in which the function is executed, not all methods from above might be available. For example,
during constant expression reduction adding a metric is a no-op operation.</p>

<p>The following example snippet shows how to use <code class="highlighter-rouge">FunctionContext</code> in a scalar function for accessing a global job parameter:</p>

<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashCodeFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">FunctionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// access the global "hashcode_factor" parameter</span>
        <span class="c1">// "12" would be the default value if the parameter does not exist</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"12"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">*</span> <span class="n">factor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// add job parameter</span>
<span class="n">env</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">addJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"31"</span><span class="o">);</span>

<span class="c1">// register the function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">,</span> <span class="nc">HashCodeFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// use the function</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT myField, hashCode(myField) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="k">class</span> <span class="nc">HashCodeFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">factor</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">open</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">FunctionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// access the global "hashcode_factor" parameter</span>
    <span class="c1">// "12" would be the default value if the parameter does not exist</span>
    <span class="n">factor</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">getJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"12"</span><span class="o">).</span><span class="py">toInt</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">hashCode</span> <span class="o">*</span> <span class="n">factor</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// add job parameter</span>
<span class="nv">env</span><span class="o">.</span><span class="py">getConfig</span><span class="o">.</span><span class="py">addJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"31"</span><span class="o">)</span>

<span class="c1">// register the function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashCodeFunction</span><span class="o">])</span>

<span class="c1">// use the function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT myField, hashCode(myField) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="scalar-functions">Scalar Functions</h2>

<p>A user-defined scalar function maps zero, one, or multiple scalar values to a new scalar value. Any data type listed in the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/types.html">data types section</a> can be used as a parameter or return type of an evaluation method.</p>

<p>In order to define a scalar function, one has to extend the base class <code class="highlighter-rouge">ScalarFunction</code> in <code class="highlighter-rouge">org.apache.flink.table.functions</code> and implement one or more evaluation methods named <code class="highlighter-rouge">eval(...)</code>.</p>

<p>The following example shows how to define your own hash code function and call it in a query. See the <a href="#implementation-guide">Implementation Guide</a> for more details.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// take any data type and return INT</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="nc">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)));</span>

<span class="c1">// call registered function in SQL</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT HashFunction(myField) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="k">class</span> <span class="nc">HashFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// take any data type and return INT</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nv">InputGroup</span><span class="o">.</span><span class="py">ANY</span><span class="o">)</span> <span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">o</span><span class="o">.</span><span class="py">hashCode</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">])</span>

<span class="c1">// call registered function in Table API</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>

<span class="c1">// call registered function in SQL</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT HashFunction(myField) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>If you intend to implement or call functions in Python, please refer to the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html#scalar-functions">Python Scalar Functions</a> documentation for more details.</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="table-functions">Table Functions</h2>

<p>Similar to a user-defined scalar function, a user-defined table function (<em>UDTF</em>) takes zero, one, or multiple scalar values as input arguments. However, it can return an arbitrary number of rows (or structured types) as output instead of a single value. The returned record may consist of one or more fields. If an output record consists of only a single field, the structured record can be omitted, and a scalar value can be emitted that will be implicitly wrapped into a row by the runtime.</p>

<p>In order to define a table function, one has to extend the base class <code class="highlighter-rouge">TableFunction</code> in <code class="highlighter-rouge">org.apache.flink.table.functions</code> and implement one or more evaluation methods named <code class="highlighter-rouge">eval(...)</code>. Similar to other functions, input and output data types are automatically extracted using reflection. This includes the generic argument <code class="highlighter-rouge">T</code> of the class for determining an output data type. In contrast to scalar functions, the evaluation method itself must not have a return type, instead, table functions provide a <code class="highlighter-rouge">collect(T)</code> method that can be called within every evaluation method for emitting zero, one, or more records.</p>

<p>In the Table API, a table function is used with <code class="highlighter-rouge">.joinLateral(...)</code> or <code class="highlighter-rouge">.leftOuterJoinLateral(...)</code>. The <code class="highlighter-rouge">joinLateral</code> operator (cross) joins each row from the outer table (table on the left of the operator) with all rows produced by the table-valued function (which is on the right side of the operator). The <code class="highlighter-rouge">leftOuterJoinLateral</code> operator joins each row from the outer table (table on the left of the operator) with all rows produced by the table-valued function (which is on the right side of the operator) and preserves outer rows for which the table function returns an empty table.</p>

<p>In SQL, use <code class="highlighter-rouge">LATERAL TABLE(&lt;TableFunction&gt;)</code> with <code class="highlighter-rouge">JOIN</code> or <code class="highlighter-rouge">LEFT JOIN</code> with an <code class="highlighter-rouge">ON TRUE</code> join condition.</p>

<p>The following example shows how to define your own split function and call it in a query. See the <a href="#implementation-guide">Implementation Guide</a> for more details.</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;word STRING, length INT&gt;"</span><span class="o">))</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplitFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">str</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// use collect(...) to emit a row</span>
      <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>

<span class="c1">// rename fields of the function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">,</span> <span class="s">"newLength"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"newLength"</span><span class="o">));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>

<span class="c1">// call registered function in SQL</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable, LATERAL TABLE(SplitFunction(myField))"</span><span class="o">);</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE"</span><span class="o">);</span>

<span class="c1">// rename fields of the function in SQL</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, newWord, newLength "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>

<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;word STRING, length INT&gt;"</span><span class="o">))</span>
<span class="k">class</span> <span class="nc">SplitFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// use collect(...) to emit a row</span>
    <span class="nv">str</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="py">foreach</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">length</span><span class="o">))))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">joinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>

<span class="c1">// rename fields of the function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">).</span><span class="py">as</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">,</span> <span class="s">"newLength"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"newWord"</span><span class="o">,</span> <span class="n">$</span><span class="s">"newLength"</span><span class="o">)</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">])</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">joinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>

<span class="c1">// call registered function in SQL</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable, LATERAL TABLE(SplitFunction(myField))"</span><span class="o">)</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE"</span><span class="o">)</span>

<span class="c1">// rename fields of the function in SQL</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, newWord, newLength "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>If you intend to implement functions in Scala, do not implement a table function as a Scala <code class="highlighter-rouge">object</code>. Scala <code class="highlighter-rouge">object</code>s are singletons and will cause concurrency issues.</p>

<p>If you intend to implement or call functions in Python, please refer to the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html#table-functions">Python Table Functions</a> documentation for more details.</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="aggregate-functions">Aggregate Functions</h2>

<p>A user-defined aggregate function (<em>UDAGG</em>) maps scalar values of multiple rows to a new scalar value.</p>

<p>The behavior of an aggregate function is centered around the concept of an accumulator. The <em>accumulator</em>
is an intermediate data structure that stores the aggregated values until a final aggregation result
is computed.</p>

<p>For each set of rows that needs to be aggregated, the runtime will create an empty accumulator by calling
<code class="highlighter-rouge">createAccumulator()</code>. Subsequently, the <code class="highlighter-rouge">accumulate(...)</code> method of the function is called for each input
row to update the accumulator. Once all rows have been processed, the <code class="highlighter-rouge">getValue(...)</code> method of the
function is called to compute and return the final result.</p>

<p>The following example illustrates the aggregation process:</p>

<center>
<img alt="UDAGG mechanism" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/fig/udagg-mechanism.png" width="80%" />
</center>

<p>In the example, we assume a table that contains data about beverages. The table consists of three columns (<code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">name</code>,
and <code class="highlighter-rouge">price</code>) and 5 rows. We would like to find the highest price of all beverages in the table, i.e., perform
a <code class="highlighter-rouge">max()</code> aggregation. We need to consider each of the 5 rows. The result is a single numeric value.</p>

<p>In order to define an aggregate function, one has to extend the base class <code class="highlighter-rouge">AggregateFunction</code> in
<code class="highlighter-rouge">org.apache.flink.table.functions</code> and implement one or more evaluation methods named <code class="highlighter-rouge">accumulate(...)</code>.
An accumulate method must be declared publicly and not static. Accumulate methods can also be overloaded
by implementing multiple methods named <code class="highlighter-rouge">accumulate</code>.</p>

<p>By default, input, accumulator, and output data types are automatically extracted using reflection. This
includes the generic argument <code class="highlighter-rouge">ACC</code> of the class for determining an accumulator data type and the generic
argument <code class="highlighter-rouge">T</code> for determining an accumulator data type. Input arguments are derived from one or more
<code class="highlighter-rouge">accumulate(...)</code> methods. See the <a href="#implementation-guide">Implementation Guide</a> for more details.</p>

<p>If you intend to implement or call functions in Python, please refer to the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html">Python Functions</a>
documentation for more details.</p>

<p>The following example shows how to define your own aggregate function and call it in a query.</p>

<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.AggregateFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// mutable accumulator of structured type for the aggregate function</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvgAccumulator</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// function that takes (value BIGINT, weight INT), stores intermediate results in a structured</span>
<span class="c1">// type of WeightedAvgAccumulator, and returns the weighted average as BIGINT</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvg</span> <span class="kd">extends</span> <span class="nc">AggregateFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">WeightedAvgAccumulator</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">WeightedAvgAccumulator</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">WeightedAvgAccumulator</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getValue</span><span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">/</span> <span class="n">acc</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">iValue</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">iWeight</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">iValue</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">-=</span> <span class="n">iWeight</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">WeightedAvgAccumulator</span><span class="o">&gt;</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">a</span> <span class="o">:</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">sum</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="nc">WeightedAvgAccumulator</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="n">call</span><span class="o">(</span><span class="nc">WeightedAvg</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"weight"</span><span class="o">)));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"WeightedAvg"</span><span class="o">,</span> <span class="nc">WeightedAvg</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="n">call</span><span class="o">(</span><span class="s">"WeightedAvg"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"weight"</span><span class="o">)));</span>

<span class="c1">// call registered function in SQL</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, WeightedAvg(value, weight) FROM MyTable GROUP BY myField"</span>
<span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.AggregateFunction</span>

<span class="c1">// mutable accumulator of structured type for the aggregate function</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">WeightedAvgAccumulator</span><span class="o">(</span>
  <span class="k">var</span> <span class="n">sum</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span>
  <span class="k">var</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">)</span>

<span class="c1">// function that takes (value BIGINT, weight INT), stores intermediate results in a structured</span>
<span class="c1">// type of WeightedAvgAccumulator, and returns the weighted average as BIGINT</span>
<span class="k">class</span> <span class="nc">WeightedAvg</span> <span class="k">extends</span> <span class="nc">AggregateFunction</span><span class="o">[</span><span class="kt">java.lang.Long</span>, <span class="kt">WeightedAvgAccumulator</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">WeightedAvgAccumulator</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span><span class="o">)</span><span class="k">:</span> <span class="kt">java.lang.Long</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="kc">null</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">/</span> <span class="nv">acc</span><span class="o">.</span><span class="py">count</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">java.lang.Long</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">java.lang.Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">+=</span> <span class="n">iWeight</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">java.lang.Long</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">java.lang.Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">-=</span> <span class="n">iWeight</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span><span class="o">,</span> <span class="n">it</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">WeightedAvgAccumulator</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">iter</span> <span class="k">=</span> <span class="nv">it</span><span class="o">.</span><span class="py">iterator</span><span class="o">()</span>
    <span class="nf">while</span> <span class="o">(</span><span class="nv">iter</span><span class="o">.</span><span class="py">hasNext</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="nv">iter</span><span class="o">.</span><span class="py">next</span><span class="o">()</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">+=</span> <span class="nv">a</span><span class="o">.</span><span class="py">count</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">+=</span> <span class="nv">a</span><span class="o">.</span><span class="py">sum</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccumulator</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="k">=</span> <span class="mi">0</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="k">=</span> <span class="mi">0L</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">WeightedAvg</span><span class="o">],</span> <span class="n">$</span><span class="s">"value"</span><span class="o">,</span> <span class="n">$</span><span class="s">"weight"</span><span class="o">))</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"WeightedAvg"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">WeightedAvg</span><span class="o">])</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="nf">call</span><span class="o">(</span><span class="s">"WeightedAvg"</span><span class="o">,</span> <span class="n">$</span><span class="s">"value"</span><span class="o">,</span> <span class="n">$</span><span class="s">"weight"</span><span class="o">))</span>

<span class="c1">// call registered function in SQL</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, WeightedAvg(value, weight) FROM MyTable GROUP BY myField"</span>
<span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>The <code class="highlighter-rouge">accumulate(...)</code> method of our <code class="highlighter-rouge">WeightedAvg</code> class takes three inputs. The first one is the accumulator
and the other two are user-defined inputs. In order to calculate a weighted average value, the accumulator
needs to store the weighted sum and count of all the data that has been accumulated. In our example, we
define a class <code class="highlighter-rouge">WeightedAvgAccumulator</code> to be the accumulator. Accumulators are automatically managed
by Flink’s checkpointing mechanism and are restored in case of a failure to ensure exactly-once semantics.</p>

<h3 id="mandatory-and-optional-methods">Mandatory and Optional Methods</h3>

<p><strong>The following methods are mandatory for each <code class="highlighter-rouge">AggregateFunction</code>:</strong></p>

<ul>
  <li><code class="highlighter-rouge">createAccumulator()</code></li>
  <li><code class="highlighter-rouge">accumulate(...)</code></li>
  <li><code class="highlighter-rouge">getValue(...)</code></li>
</ul>

<p>Additionally, there are a few methods that can be optionally implemented. While some of these methods
allow the system more efficient query execution, others are mandatory for certain use cases. For instance,
the <code class="highlighter-rouge">merge(...)</code> method is mandatory if the aggregation function should be applied in the context of a
session group window (the accumulators of two session windows need to be joined when a row is observed
that “connects” them).</p>

<p><strong>The following methods of <code class="highlighter-rouge">AggregateFunction</code> are required depending on the use case:</strong></p>

<ul>
  <li><code class="highlighter-rouge">retract(...)</code> is required for aggregations on <code class="highlighter-rouge">OVER</code> windows.</li>
  <li><code class="highlighter-rouge">merge(...)</code> is required for many bounded aggregations and session window and hop window aggregations. Besides, this method is also helpful for optimizations. For example, two phase aggregation optimization requires all the <code class="highlighter-rouge">AggregateFunction</code> support <code class="highlighter-rouge">merge</code> method.</li>
</ul>

<p>If the aggregate function can only be applied in an OVER window, this can be declared by returning the
requirement <code class="highlighter-rouge">FunctionRequirement.OVER_WINDOW_ONLY</code> in <code class="highlighter-rouge">getRequirements()</code>.</p>

<p>If an accumulator needs to store large amounts of data, <code class="highlighter-rouge">org.apache.flink.table.api.dataview.ListView</code>
and <code class="highlighter-rouge">org.apache.flink.table.api.dataview.MapView</code> provide advanced features for leveraging Flink’s state
backends in unbounded data scenarios. Please see the docs of the corresponding classes for more information
about this advanced feature.</p>

<p>Since some of the methods are optional, or can be overloaded, the runtime invokes aggregate function
methods via generated code. This means the base class does not always provide a signature to be overridden
by the concrete implementation. Nevertheless, all mentioned methods must be declared publicly, not static,
and named exactly as the names mentioned above to be called.</p>

<p>Detailed documentation for all methods that are not declared in <code class="highlighter-rouge">AggregateFunction</code> and called by generated
code is given below.</p>

<p><strong><code class="highlighter-rouge">accumulate(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Processes the input values and updates the provided accumulator instance. The method
 * accumulate can be overloaded with different custom types and arguments. An aggregate function
 * requires at least one accumulate() method.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">])</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Processes the input values and updates the provided accumulator instance. The method
 * accumulate can be overloaded with different custom types and arguments. An aggregate function
 * requires at least one accumulate() method.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">retract(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Retracts the input values from the accumulator instance. The current design assumes the
 * inputs are the values that have been previously accumulated. The method retract can be
 * overloaded with different custom types and arguments. This method must be implemented for
 * bounded OVER aggregates over unbounded tables.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">])</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Retracts the input values from the accumulator instance. The current design assumes the
 * inputs are the values that have been previously accumulated. The method retract can be
 * overloaded with different custom types and arguments. This method must be implemented for
 * bounded OVER aggregates over unbounded tables.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">merge(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Merges a group of accumulator instances into one accumulator instance. This method must be
 * implemented for unbounded session window grouping aggregates and bounded grouping aggregates.
 *
 * param: accumulator the accumulator which will keep the merged aggregate results. It should
 *                    be noted that the accumulator may contain the previous aggregated
 *                    results. Therefore user should not replace or clean this instance in the
 *                    custom merge method.
 * param: iterable    an java.lang.Iterable pointed to a group of accumulators that will be
 *                    merged.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">iterable</span><span class="o">)</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Merges a group of accumulator instances into one accumulator instance. This method must be
 * implemented for unbounded session window grouping aggregates and bounded grouping aggregates.
 *
 * param: accumulator the accumulator which will keep the merged aggregate results. It should
 *                    be noted that the accumulator may contain the previous aggregated
 *                    results. Therefore user should not replace or clean this instance in the
 *                    custom merge method.
 * param: iterable    an java.lang.Iterable pointed to a group of accumulators that will be
 *                    merged.
 */</span>
<span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">iterable</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p>If you intend to implement or call functions in Python, please refer to the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html#aggregate-functions">Python Aggregate Functions</a> documentation for more details.</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="table-aggregate-functions">Table Aggregate Functions</h2>

<p>A user-defined table aggregate function (<em>UDTAGG</em>) maps scalar values of multiple rows to zero, one,
or multiple rows (or structured types). The returned record may consist of one or more fields. If an
output record consists of only a single field, the structured record can be omitted, and a scalar value
can be emitted that will be implicitly wrapped into a row by the runtime.</p>

<p>Similar to an <a href="#aggregate-functions">aggregate function</a>, the behavior of a table aggregate is centered
around the concept of an accumulator. The accumulator is an intermediate data structure that stores
the aggregated values until a final aggregation result is computed.</p>

<p>For each set of rows that needs to be aggregated, the runtime will create an empty accumulator by calling
<code class="highlighter-rouge">createAccumulator()</code>. Subsequently, the <code class="highlighter-rouge">accumulate(...)</code> method of the function is called for each
input row to update the accumulator. Once all rows have been processed, the <code class="highlighter-rouge">emitValue(...)</code> or <code class="highlighter-rouge">emitUpdateWithRetract(...)</code>
method of the function is called to compute and return the final result.</p>

<p>The following example illustrates the aggregation process:</p>

<center>
<img alt="UDTAGG mechanism" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/fig/udtagg-mechanism.png" width="80%" />
</center>

<p>In the example, we assume a table that contains data about beverages. The table consists of three columns (<code class="highlighter-rouge">id</code>, <code class="highlighter-rouge">name</code>,
and <code class="highlighter-rouge">price</code>) and 5 rows. We would like to find the 2 highest prices of all beverages in the table, i.e.,
perform a <code class="highlighter-rouge">TOP2()</code> table aggregation. We need to consider each of the 5 rows. The result is a table
with the top 2 values.</p>

<p>In order to define a table aggregate function, one has to extend the base class <code class="highlighter-rouge">TableAggregateFunction</code> in
<code class="highlighter-rouge">org.apache.flink.table.functions</code> and implement one or more evaluation methods named <code class="highlighter-rouge">accumulate(...)</code>.
An accumulate method must be declared publicly and not static. Accumulate methods can also be overloaded
by implementing multiple methods named <code class="highlighter-rouge">accumulate</code>.</p>

<p>By default, input, accumulator, and output data types are automatically extracted using reflection. This
includes the generic argument <code class="highlighter-rouge">ACC</code> of the class for determining an accumulator data type and the generic
argument <code class="highlighter-rouge">T</code> for determining an accumulator data type. Input arguments are derived from one or more
<code class="highlighter-rouge">accumulate(...)</code> methods. See the <a href="#implementation-guide">Implementation Guide</a> for more details.</p>

<p>If you intend to implement or call functions in Python, please refer to the <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html">Python Functions</a>
documentation for more details.</p>

<p>The following example shows how to define your own table aggregate function and call it in a query.</p>

<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.api.java.tuple.Tuple2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.util.Collector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// mutable accumulator of structured type for the aggregate function</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2Accumulator</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">first</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">second</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// function that takes (value INT), stores intermediate results in a structured</span>
<span class="c1">// type of Top2Accumulator, and returns the result as a structured type of Tuple2&lt;Integer, Integer&gt;</span>
<span class="c1">// for value and rank</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2</span> <span class="kd">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">Top2Accumulator</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Top2Accumulator</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Top2Accumulator</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Top2Accumulator</span><span class="o">();</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">Top2Accumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="nc">Top2Accumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Top2Accumulator</span><span class="o">&gt;</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Top2Accumulator</span> <span class="n">otherAcc</span> <span class="o">:</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">first</span><span class="o">);</span>
      <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="nc">Top2Accumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// emit the value and rank</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">Top2</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"f0"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"f1"</span><span class="o">));</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="c1">// but use an alias for a better naming of Tuple2's fields</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">Top2</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"rank"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"rank"</span><span class="o">));</span>

<span class="c1">// register function</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"Top2"</span><span class="o">,</span> <span class="nc">Top2</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"Top2"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"rank"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"value"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"rank"</span><span class="o">));</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.lang.Integer</span>
<span class="k">import</span> <span class="nn">org.apache.flink.api.java.tuple.Tuple2</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.util.Collector</span>

<span class="c1">// mutable accumulator of structured type for the aggregate function</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Top2Accumulator</span><span class="o">(</span>
  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span>
  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">Integer</span>
<span class="o">)</span>

<span class="c1">// function that takes (value INT), stores intermediate results in a structured</span>
<span class="c1">// type of Top2Accumulator, and returns the result as a structured type of Tuple2[Integer, Integer]</span>
<span class="c1">// for value and rank</span>
<span class="k">class</span> <span class="nc">Top2</span> <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Integer</span>, <span class="kt">Integer</span><span class="o">]</span>, <span class="kt">Top2Accumulator</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2Accumulator</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">Top2Accumulator</span><span class="o">(</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">,</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span>
    <span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accumulator</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="n">value</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="n">value</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accumulator</span><span class="o">,</span> <span class="n">it</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">Top2Accumulator</span><span class="o">])</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">iter</span> <span class="k">=</span> <span class="nv">it</span><span class="o">.</span><span class="py">iterator</span><span class="o">()</span>
    <span class="nf">while</span> <span class="o">(</span><span class="nv">iter</span><span class="o">.</span><span class="py">hasNext</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">otherAcc</span> <span class="k">=</span> <span class="nv">iter</span><span class="o">.</span><span class="py">next</span><span class="o">()</span>
      <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="nv">otherAcc</span><span class="o">.</span><span class="py">first</span><span class="o">)</span>
      <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="nv">otherAcc</span><span class="o">.</span><span class="py">second</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accumulator</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Integer</span>, <span class="kt">Integer</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// emit the value and rank</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="o">!=</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="o">!=</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">flatAggregate</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Top2</span><span class="o">],</span> <span class="n">$</span><span class="s">"value"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"f0"</span><span class="o">,</span> <span class="n">$</span><span class="s">"f1"</span><span class="o">)</span>

<span class="c1">// call function "inline" without registration in Table API</span>
<span class="c1">// but use an alias for a better naming of Tuple2's fields</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">flatAggregate</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">Top2</span><span class="o">],</span> <span class="n">$</span><span class="s">"value"</span><span class="o">).</span><span class="py">as</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"rank"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"value"</span><span class="o">,</span> <span class="n">$</span><span class="s">"rank"</span><span class="o">)</span>

<span class="c1">// register function</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"Top2"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">Top2</span><span class="o">])</span>

<span class="c1">// call registered function in Table API</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">flatAggregate</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"Top2"</span><span class="o">,</span> <span class="n">$</span><span class="s">"value"</span><span class="o">).</span><span class="py">as</span><span class="o">(</span><span class="s">"value"</span><span class="o">,</span> <span class="s">"rank"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"value"</span><span class="o">,</span> <span class="n">$</span><span class="s">"rank"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>The <code class="highlighter-rouge">accumulate(...)</code> method of our <code class="highlighter-rouge">Top2</code> class takes two inputs. The first one is the accumulator
and the second one is the user-defined input. In order to calculate a result, the accumulator needs to
store the 2 highest values of all the data that has been accumulated. Accumulators are automatically managed
by Flink’s checkpointing mechanism and are restored in case of a failure to ensure exactly-once semantics.
The result values are emitted together with a ranking index.</p>

<h3 id="mandatory-and-optional-methods-1">Mandatory and Optional Methods</h3>

<p><strong>The following methods are mandatory for each <code class="highlighter-rouge">TableAggregateFunction</code>:</strong></p>

<ul>
  <li><code class="highlighter-rouge">createAccumulator()</code></li>
  <li><code class="highlighter-rouge">accumulate(...)</code></li>
  <li><code class="highlighter-rouge">emitValue(...)</code> or <code class="highlighter-rouge">emitUpdateWithRetract(...)</code></li>
</ul>

<p>Additionally, there are a few methods that can be optionally implemented. While some of these methods
allow the system more efficient query execution, others are mandatory for certain use cases. For instance,
the <code class="highlighter-rouge">merge(...)</code> method is mandatory if the aggregation function should be applied in the context of a
session group window (the accumulators of two session windows need to be joined when a row is observed
that “connects” them).</p>

<p><strong>The following methods of <code class="highlighter-rouge">TableAggregateFunction</code> are required depending on the use case:</strong></p>

<ul>
  <li><code class="highlighter-rouge">retract(...)</code> is required for aggregations on <code class="highlighter-rouge">OVER</code> windows.</li>
  <li><code class="highlighter-rouge">merge(...)</code> is required for many bounded aggregations and unbounded session and hop window aggregations.</li>
  <li><code class="highlighter-rouge">emitValue(...)</code> is required for bounded and window aggregations.</li>
</ul>

<p><strong>The following methods of <code class="highlighter-rouge">TableAggregateFunction</code> are used to improve the performance of streaming jobs:</strong></p>

<ul>
  <li><code class="highlighter-rouge">emitUpdateWithRetract(...)</code> is used to emit values that have been updated under retract mode.</li>
</ul>

<p>The <code class="highlighter-rouge">emitValue(...)</code> method always emits the full data according to the accumulator. In unbounded scenarios,
this may bring performance problems. Take a Top N function as an example. The <code class="highlighter-rouge">emitValue(...)</code> would emit
all N values each time. In order to improve the performance, one can implement <code class="highlighter-rouge">emitUpdateWithRetract(...)</code> which
outputs data incrementally in retract mode. In other words, once there is an update, the method can retract
old records before sending new, updated ones. The method will be used in preference to the <code class="highlighter-rouge">emitValue(...)</code>
method.</p>

<p>If the table aggregate function can only be applied in an OVER window, this can be declared by returning the
requirement <code class="highlighter-rouge">FunctionRequirement.OVER_WINDOW_ONLY</code> in <code class="highlighter-rouge">getRequirements()</code>.</p>

<p>If an accumulator needs to store large amounts of data, <code class="highlighter-rouge">org.apache.flink.table.api.dataview.ListView</code>
and <code class="highlighter-rouge">org.apache.flink.table.api.dataview.MapView</code> provide advanced features for leveraging Flink’s state
backends in unbounded data scenarios. Please see the docs of the corresponding classes for more information
about this advanced feature.</p>

<p>Since some of methods are optional or can be overloaded, the methods are called by generated code. The
base class does not always provide a signature to be overridden by the concrete implementation class. Nevertheless,
all mentioned methods must be declared publicly, not static, and named exactly as the names mentioned above
to be called.</p>

<p>Detailed documentation for all methods that are not declared in <code class="highlighter-rouge">TableAggregateFunction</code> and called by generated
code is given below.</p>

<p><strong><code class="highlighter-rouge">accumulate(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Processes the input values and updates the provided accumulator instance. The method
 * accumulate can be overloaded with different custom types and arguments. An aggregate function
 * requires at least one accumulate() method.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">])</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Processes the input values and updates the provided accumulator instance. The method
 * accumulate can be overloaded with different custom types and arguments. An aggregate function
 * requires at least one accumulate() method.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">retract(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Retracts the input values from the accumulator instance. The current design assumes the
 * inputs are the values that have been previously accumulated. The method retract can be
 * overloaded with different custom types and arguments. This method must be implemented for
 * bounded OVER aggregates over unbounded tables.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">])</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Retracts the input values from the accumulator instance. The current design assumes the
 * inputs are the values that have been previously accumulated. The method retract can be
 * overloaded with different custom types and arguments. This method must be implemented for
 * bounded OVER aggregates over unbounded tables.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: [user defined inputs] the input value (usually obtained from new arrived data).
 */</span>
<span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">merge(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Merges a group of accumulator instances into one accumulator instance. This method must be
 * implemented for unbounded session window grouping aggregates and bounded grouping aggregates.
 *
 * param: accumulator the accumulator which will keep the merged aggregate results. It should
 *                    be noted that the accumulator may contain the previous aggregated
 *                    results. Therefore user should not replace or clean this instance in the
 *                    custom merge method.
 * param: iterable    an java.lang.Iterable pointed to a group of accumulators that will be
 *                    merged.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">iterable</span><span class="o">)</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Merges a group of accumulator instances into one accumulator instance. This method must be
 * implemented for unbounded session window grouping aggregates and bounded grouping aggregates.
 *
 * param: accumulator the accumulator which will keep the merged aggregate results. It should
 *                    be noted that the accumulator may contain the previous aggregated
 *                    results. Therefore user should not replace or clean this instance in the
 *                    custom merge method.
 * param: iterable    an java.lang.Iterable pointed to a group of accumulators that will be
 *                    merged.
 */</span>
<span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">iterable</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">emitValue(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Called every time when an aggregation result should be materialized. The returned value could
 * be either an early and incomplete result (periodically emitted as data arrives) or the final
 * result of the aggregation.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: out                   the collector used to output data.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Collector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Called every time when an aggregation result should be materialized. The returned value could
 * be either an early and incomplete result (periodically emitted as data arrives) or the final
 * result of the aggregation.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: out                   the collector used to output data.
 */</span>
<span class="k">def</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">org.apache.flink.util.Collector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>
<p><strong><code class="highlighter-rouge">emitUpdateWithRetract(...)</code></strong></p>
<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/*
 * Called every time when an aggregation result should be materialized. The returned value could
 * be either an early and incomplete result (periodically emitted as data arrives) or the final
 * result of the aggregation.
 *
 * Compared to emitValue(), emitUpdateWithRetract() is used to emit values that have been updated. This method
 * outputs data incrementally in retraction mode (also known as "update before" and "update after"). Once
 * there is an update, we have to retract old records before sending new updated ones. The emitUpdateWithRetract()
 * method will be used in preference to the emitValue() method if both methods are defined in the table aggregate
 * function, because the method is treated to be more efficient than emitValue as it can output
 * values incrementally.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: out                   the retractable collector used to output data. Use the collect() method
 *                              to output(add) records and use retract method to retract(delete)
 *                              records.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/*
 * Called every time when an aggregation result should be materialized. The returned value could
 * be either an early and incomplete result (periodically emitted as data arrives) or the final
 * result of the aggregation.
 *
 * Compared to emitValue(), emitUpdateWithRetract() is used to emit values that have been updated. This method
 * outputs data incrementally in retraction mode (also known as "update before" and "update after"). Once
 * there is an update, we have to retract old records before sending new updated ones. The emitUpdateWithRetract()
 * method will be used in preference to the emitValue() method if both methods are defined in the table aggregate
 * function, because the method is treated to be more efficient than emitValue as it can output
 * values incrementally.
 *
 * param: accumulator           the accumulator which contains the current aggregated results
 * param: out                   the retractable collector used to output data. Use the collect() method
 *                              to output(add) records and use retract method to retract(delete)
 *                              records.
 */</span>
<span class="k">def</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span></code></pre></figure>

  </div>

</div>

<h3 id="retraction-example">Retraction Example</h3>

<p>The following example shows how to use the <code class="highlighter-rouge">emitUpdateWithRetract(...)</code> method to emit only incremental
updates. In order to do so, the accumulator keeps both the old and new top 2 values.</p>

<p>If the N of Top N is big, it might be inefficient to keep both the old and new values. One way to
solve this case is to store only the input record in the accumulator in <code class="highlighter-rouge">accumulate</code> method and then perform
a calculation in <code class="highlighter-rouge">emitUpdateWithRetract</code>.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.api.java.tuple.Tuple2</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2WithRetractAccumulator</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">first</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">second</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">oldFirst</span><span class="o">;</span>
  <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">oldSecond</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2WithRetract</span>
    <span class="kd">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">Top2WithRetractAccumulator</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Top2WithRetractAccumulator</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Top2WithRetractAccumulator</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Top2WithRetractAccumulator</span><span class="o">();</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">Top2WithRetractAccumulator</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span>
      <span class="nc">Top2WithRetractAccumulator</span> <span class="n">acc</span><span class="o">,</span>
      <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract the old value then emit a new value</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract the old value then emit a new value</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
      <span class="o">}</span>
      <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
      <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.api.java.tuple.Tuple2</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction.RetractableCollector</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Top2WithRetractAccumulator</span><span class="o">(</span>
  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span>
  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span>
  <span class="k">var</span> <span class="n">oldFirst</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span>
  <span class="k">var</span> <span class="n">oldSecond</span><span class="k">:</span> <span class="kt">Integer</span>
<span class="o">)</span>

<span class="k">class</span> <span class="nc">Top2WithRetract</span>
    <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Integer</span>, <span class="kt">Integer</span><span class="o">]</span>, <span class="kt">Top2WithRetractAccumulator</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2WithRetractAccumulator</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nc">Top2WithRetractAccumulator</span><span class="o">(</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">,</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">,</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">,</span>
      <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span>
    <span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2WithRetractAccumulator</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="n">value</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="n">value</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span>
      <span class="n">acc</span><span class="k">:</span> <span class="kt">Top2WithRetractAccumulator</span><span class="o">,</span>
      <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">Tuple2</span><span class="o">[</span><span class="kt">Integer</span>, <span class="kt">Integer</span><span class="o">]])</span>
    <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(!</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">.</span><span class="py">equals</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract the old value then emit a new value</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span> <span class="o">!=</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
          <span class="nv">out</span><span class="o">.</span><span class="py">retract</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
    <span class="o">}</span>
    <span class="nf">if</span> <span class="o">(!</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">.</span><span class="py">equals</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract the old value then emit a new value</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span> <span class="o">!=</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
          <span class="nv">out</span><span class="o">.</span><span class="py">retract</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">Tuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>



<div class="footer">
  <a href="https://cwiki.apache.org/confluence/display/FLINK/Flink+Translation+Specifications" target="_blank">
    
      Want to contribute translation?
    
  </a>
</div>


        </div>
      </div>
    </div><!-- /.container -->

    <!-- default code tab -->
    <script>var defaultCodeTab = "";</script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>

    <!-- Disqus -->
    
  </body>
</html>
