<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.12 Documentation: Fraud Detection with the DataStream API</title>
    <link rel="shortcut icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="//ci.apache.org/projects/flink/flink-docs-stable/try-flink/datastream_api.html">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/flink.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/syntax.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/codetabs.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/font-awesome/css/font-awesome.min.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    

    <!-- Main content. -->
    <div class="container">
      
      <div class="row">
        <div class="col-lg-3" id="sidenavcol">
          <div class="sidenav-logo">
  <p><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/"><img class="bottom" alt="Apache Flink" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/img/navbar-brand-logo.jpg"></a> v1.12</p>
</div>
<ul id="sidenav">
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/"><i class="fa fa-home title" aria-hidden="true"></i> Home</a></li><hr class="section-break"></hr>
<li><a href="#collapse-2" data-toggle="collapse"class="active"><i class="fa fa-rocket title appetizer" aria-hidden="true"></i> Try Flink</a><div class="collapse in" id="collapse-2"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/local_installation.html">Local Installation</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/datastream_api.html" class="active">Fraud Detection with the DataStream API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/table_api.html">Real Time Reporting with the Table API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/try-flink/flink-operations-playground.html">Flink Operations Playground</a></li>
</ul></div></li>
<li><a href="#collapse-8" data-toggle="collapse"><i class="fa fa-hand-paper-o title appetizer" aria-hidden="true"></i> Learn Flink<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-8"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/datastream_api.html">Intro to the DataStream API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/etl.html">Data Pipelines & ETL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/streaming_analytics.html">Streaming Analytics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/event_driven.html">Event-driven Applications</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/learn-flink/fault_tolerance.html">Fault Tolerance</a></li>
</ul></div></li>
<li><a href="#collapse-15" data-toggle="collapse"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i> Concepts<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-15"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/index.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/stateful-stream-processing.html">Stateful Stream Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/timely-stream-processing.html">Timely Stream Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/flink-architecture.html">Flink Architecture</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/glossary.html">Glossary</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-21" data-toggle="collapse"><i class="fa fa-code title maindish" aria-hidden="true"></i> Application Development<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-21"><ul>
<li><a href="#collapse-22" data-toggle="collapse">DataStream API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-22"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/datastream_api.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/datastream_execution_mode.html">Execution Mode (Batch/Streaming)</a></li>
<li><a href="#collapse-24" data-toggle="collapse">Event Time<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-24"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_time.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html">Generating Watermarks</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamp_extractors.html">Builtin Watermark Generators</a></li>
</ul></div></li>
<li><a href="#collapse-28" data-toggle="collapse">State & Fault Tolerance<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-28"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/state.html">Working with State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/broadcast_state.html">The Broadcast State Pattern</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/checkpointing.html">Checkpointing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/queryable_state.html">Queryable State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/schema_evolution.html">State Schema Evolution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/custom_serialization.html">Custom State Serialization</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/user_defined_functions.html">User-Defined Functions</a></li>
<li><a href="#collapse-38" data-toggle="collapse">Operators<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-38"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/windows.html">Windows</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/joining.html">Joining</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/process_function.html">Process Function</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/asyncio.html">Async I/O</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/sources.html">Data Sources</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/side_output.html">Side Outputs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/application_parameters.html">Handling Application Parameters</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/testing.html">Testing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/experimental.html">Experimental Features</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/scala_api_extensions.html">Scala API Extensions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/java_lambdas.html">Java Lambda Expressions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/project-configuration.html">Project Configuration</a></li>
</ul></div></li>
<li><a href="#collapse-53" data-toggle="collapse">DataSet API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-53"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/dataset_transformations.html">Transformations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/iterations.html">Iterations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/zip_elements_guide.html">Zipping Elements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/hadoop_compatibility.html">Hadoop Compatibility</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/local_execution.html">Local Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/cluster_execution.html">Cluster Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/examples.html">Batch Examples</a></li>
</ul></div></li>
<li><a href="#collapse-62" data-toggle="collapse">Table API & SQL<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-62"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/common.html">Concepts & Common API</a></li>
<li><a href="#collapse-64" data-toggle="collapse">Streaming Concepts<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-64"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/dynamic_tables.html">Dynamic Tables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/time_attributes.html">Time Attributes</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/joins.html">Joins in Continuous Queries</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/temporal_tables.html">Temporal Tables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/match_recognize.html">Detecting Patterns</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/streaming/query_configuration.html">Query Configuration</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/tableApi.html">Table API</a></li>
<li><a href="#collapse-74" data-toggle="collapse">SQL<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-74"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/queries.html">Queries</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/create.html">CREATE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/drop.html">DROP Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/alter.html">ALTER Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/insert.html">INSERT Statement</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/hints.html">SQL Hints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/describe.html">DESCRIBE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/explain.html">EXPLAIN Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/use.html">USE Statements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sql/show.html">SHOW Statements</a></li>
</ul></div></li>
<li><a href="#collapse-86" data-toggle="collapse">Functions<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-86"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/systemFunctions.html">System (Built-in) Functions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/udfs.html">User-defined Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/modules.html">Modules</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sqlClient.html">SQL Client</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/config.html">Configuration</a></li>
<li><a href="#collapse-94" data-toggle="collapse">Performance Tuning<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-94"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/tuning/streaming_aggregation_optimization.html">Streaming Aggregation</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/sourceSinks.html">User-defined Sources & Sinks</a></li>
</ul></div></li>
<li><a href="#collapse-99" data-toggle="collapse">Python API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-99"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/installation.html">Installation</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table_api_tutorial.html">Table API Tutorial</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream_tutorial.html">DataStream API Tutorial</a></li>
<li><a href="#collapse-103" data-toggle="collapse">Table API User's Guide<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-103"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/intro_to_table_api.html">Intro to the Python Table API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/table_environment.html">TableEnvironment</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/operations.html">Operations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/python_types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/built_in_functions.html">System (Built-in) Functions</a></li>
<li><a href="#collapse-109" data-toggle="collapse">User Defined Functions<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-109"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/python_udfs.html">General User-defined Functions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/udfs/vectorized_python_udfs.html">Vectorized User-defined Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/conversion_of_pandas.html">Conversions between PyFlink Table and Pandas DataFrame</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/dependency_management.html">Dependency Management</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/sql.html">SQL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/metrics.html">Metrics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/table-api-users-guide/python_table_api_connectors.html">Connectors</a></li>
</ul></div></li>
<li><a href="#collapse-120" data-toggle="collapse">DataStream API User's Guide<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-120"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/data_types.html">Data Types</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/operators.html">Operators</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/datastream-api-users-guide/dependency_management.html">Dependency Management</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/python_config.html">Configuration</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/environment_variables.html">Environment Variables</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/python/faq.html">FAQ</a></li>
</ul></div></li>
<li><a href="#collapse-129" data-toggle="collapse">Data Types & Serialization<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-129"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/types_serialization.html">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/custom_serializers.html">Custom Serializers</a></li>
</ul></div></li>
<li><a href="#collapse-132" data-toggle="collapse">Managing Execution<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-132"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/execution_configuration.html">Execution Configuration</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/packaging.html">Program Packaging</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/parallel.html">Parallel Execution</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/execution_plans.html">Execution Plans</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/task_failure_recovery.html">Task Failure Recovery</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/migration.html">API Migration Guides</a></li>
</ul></div></li>
<li><a href="#collapse-141" data-toggle="collapse"><i class="fa fa-book title maindish" aria-hidden="true"></i> Libraries<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-141"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/cep.html">Event Processing (CEP)</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/state_processor_api.html">State Processor API</a></li>
<li><a href="#collapse-144" data-toggle="collapse">Graphs: Gelly<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-144"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_api.html">Graph API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/iterative_graph_processing.html">Iterative Graph Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/library_methods.html">Library Methods</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_algorithms.html">Graph Algorithms</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/graph_generators.html">Graph Generators</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/libs/gelly/bipartite_graph.html">Bipartite Graph</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-153" data-toggle="collapse"><i class="fa fa-random title maindish" aria-hidden="true"></i> Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-153"><ul>
<li><a href="#collapse-154" data-toggle="collapse">DataStream Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-154"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/guarantees.html">Fault Tolerance Guarantees</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/cassandra.html">Cassandra</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/file_sink.html">File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/streamfile_sink.html">Streaming File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/rabbitmq.html">RabbitMQ</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/nifi.html">NiFi</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/pubsub.html">Google Cloud PubSub</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/twitter.html">Twitter</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/connectors/jdbc.html">JDBC</a></li>
</ul></div></li>
<li><a href="#collapse-168" data-toggle="collapse">Table & SQL Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-168"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/">Overview</a></li>
<li><a href="#collapse-169" data-toggle="collapse">Formats<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-169"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/csv.html">CSV</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/json.html">JSON</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/avro-confluent.html">Confluent Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/avro.html">Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/debezium.html">Debezium</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/canal.html">Canal</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/maxwell.html">Maxwell</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/parquet.html">Parquet</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/orc.html">Orc</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/formats/raw.html">Raw</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/upsert-kafka.html">Upsert Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/jdbc.html">JDBC</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/filesystem.html">FileSystem</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hbase.html">HBase</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/datagen.html">DataGen</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/print.html">Print</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/blackhole.html">BlackHole</a></li>
<li><a href="#collapse-191" data-toggle="collapse">Hive<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-191"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_catalog.html">Hive Catalog</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_dialect.html">Hive Dialect</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_read_write.html">Hive Read & Write</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/hive/hive_functions.html">Hive Functions</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/connectors/downloads.html">Download</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/batch/connectors.html">DataSet Connectors</a></li>
</ul></div></li>
<li><a href="#collapse-201" data-toggle="collapse"><i class="fa fa-sliders title maindish" aria-hidden="true"></i> Deployment<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-201"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/">Overview</a></li>
<li><a href="#collapse-202" data-toggle="collapse">Resource Providers<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-202"><ul>
<li><a href="#collapse-203" data-toggle="collapse">Standalone<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-203"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/local.html">Local Cluster</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/docker.html">Docker</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/standalone/kubernetes.html">Kubernetes</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/native_kubernetes.html">Native Kubernetes</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/yarn.html">YARN</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/resource-providers/mesos.html">Mesos</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/config.html">Configuration</a></li>
<li><a href="#collapse-213" data-toggle="collapse">Memory Configuration<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-213"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup.html">Set up Flink's Process Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup_tm.html">Set up TaskManager Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_setup_jobmanager.html">Set up JobManager Memory</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_tuning.html">Memory tuning guide</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_trouble.html">Troubleshooting</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/memory/mem_migration.html">Migration Guide</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/cli.html">Command-Line Interface</a></li>
<li><a href="#collapse-222" data-toggle="collapse">File Systems<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-222"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/common.html">Common Configurations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/s3.html">Amazon S3</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/oss.html">Aliyun OSS</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/azure.html">Azure Blob Storage</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/filesystems/plugins.html">Plugins</a></li>
</ul></div></li>
<li><a href="#collapse-229" data-toggle="collapse">High Availability (HA)<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-229"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/">Overview</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/zookeeper_ha.html">ZooKeeper HA Services</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/ha/kubernetes_ha.html">Kubernetes HA Services</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/metric_reporters.html">Metric Reporters</a></li>
<li><a href="#collapse-234" data-toggle="collapse">Security<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-234"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/security/security-ssl.html">SSL Setup</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/security/security-kerberos.html">Kerberos</a></li>
</ul></div></li>
<li><a href="#collapse-238" data-toggle="collapse">REPLs<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-238"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/repls/python_shell.html">Python REPL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/repls/scala_shell.html">Scala REPL</a></li>
</ul></div></li>
<li><a href="#collapse-242" data-toggle="collapse">Advanced<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-242"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/external_resources.html">External Resources</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/historyserver.html">History Server</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/advanced/logging.html">Logging</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-248" data-toggle="collapse"><i class="fa fa-cogs title maindish" aria-hidden="true"></i> Operations<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-248"><ul>
<li><a href="#collapse-249" data-toggle="collapse">State & Fault Tolerance<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-249"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/checkpoints.html">Checkpoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/savepoints.html">Savepoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/state/large_state_tuning.html">Tuning Checkpoints and Large State</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html">Metrics</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/rest_api.html">REST API</a></li>
<li><a href="#collapse-257" data-toggle="collapse">Debugging<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-257"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/debugging_event_time.html">Debugging Windows & Event Time</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/debugging_classloading.html">Debugging Classloading</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/debugging/application_profiling.html">Application Profiling & Debugging</a></li>
</ul></div></li>
<li><a href="#collapse-262" data-toggle="collapse">Monitoring<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-262"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/monitoring/checkpoint_monitoring.html">Monitoring Checkpointing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/monitoring/back_pressure.html">Monitoring Back Pressure</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/upgrading.html">Upgrading Applications and Flink Versions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/ops/production_ready.html">Production Readiness Checklist</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-269" data-toggle="collapse"><i class="fa fa-cogs title dessert" aria-hidden="true"></i> Flink Development<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-269"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/flinkDev/ide_setup.html">Importing Flink into an IDE</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/flinkDev/building.html">Building Flink from Source</a></li>
</ul></div></li>
<li><a href="#collapse-273" data-toggle="collapse"><i class="fa fa-book title dessert" aria-hidden="true"></i> Internals<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-273"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/job_scheduling.html">Jobs and Scheduling</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/task_lifecycle.html">Task Lifecycle</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/internals/filesystems.html">File Systems</a></li>
</ul></div></li>
  <li class="divider"></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/java"><i class="fa fa-external-link title" aria-hidden="true"></i> Javadocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/scala/index.html#org.apache.flink.api.scala.package"><i class="fa fa-external-link title" aria-hidden="true"></i> Scaladocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/python"><i class="fa fa-external-link title" aria-hidden="true"></i> Pythondocs</a></li>
  <li><a href="http://flink.apache.org"><i class="fa fa-external-link title" aria-hidden="true"></i> Project Page</a></li>
</ul>

<div class="sidenav-search-box">
  <form class="navbar-form" role="search" action="//ci.apache.org/projects/flink/flink-docs-release-1.12/search-results.html">
    <div class="form-group">
      <input type="text" class="form-control" size="16px" name="q" placeholder="Search">
    </div>
    <button type="submit" class="btn btn-default">Go</button>
  </form>
</div>

<div class="sidenav-versions">
  <div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">Pick Docs Version<span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.11">v1.11</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.10">v1.10</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.9">v1.9</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.8">v1.8</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.7">v1.7</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.6">v1.6</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.5">v1.5</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.4">v1.4</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.3">v1.3</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.2">v1.2</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.1">v1.1</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0">v1.0</a></li>
    </ul>
  </div>
</div>

<div class="sidenav-languages"><!-- link to the Chinese home page when current is blog page -->
    <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/try-flink/datastream_api.html">
      <button type="submit" class="btn btn-default">中文版</button>
    </a>
</div>

        </div>
        <div class="col-lg-9 content" id="contentcol">

          

<ol class="breadcrumb">
  
    <li><i class="fa fa-rocket title appetizer" aria-hidden="true"></i> Try Flink</li>
  
    <li class="active">Fraud Detection with the DataStream API</li>
</ol>

<h1>Fraud Detection with the DataStream API</h1>




<p>Apache Flink offers a DataStream API for building robust, stateful streaming applications.
It provides fine-grained control over state and time, which allows for the implementation of advanced event-driven systems.
In this step-by-step guide you’ll learn how to build a stateful streaming application with Flink’s DataStream API.</p>

<ul id="markdown-toc">
  <li><a href="#what-are-you-building" id="markdown-toc-what-are-you-building">What Are You Building?</a></li>
  <li><a href="#prerequisites" id="markdown-toc-prerequisites">Prerequisites</a></li>
  <li><a href="#help-im-stuck" id="markdown-toc-help-im-stuck">Help, I’m Stuck!</a></li>
  <li><a href="#how-to-follow-along" id="markdown-toc-how-to-follow-along">How to Follow Along</a></li>
  <li><a href="#breaking-down-the-code" id="markdown-toc-breaking-down-the-code">Breaking Down the Code</a></li>
  <li><a href="#writing-a-real-application-v1" id="markdown-toc-writing-a-real-application-v1">Writing a Real Application (v1)</a></li>
  <li><a href="#fraud-detector-v2-state--time--️" id="markdown-toc-fraud-detector-v2-state--time--️">Fraud Detector v2: State + Time = ❤️</a></li>
  <li><a href="#final-application" id="markdown-toc-final-application">Final Application</a>    <ul>
      <li><a href="#expected-output" id="markdown-toc-expected-output">Expected Output</a></li>
    </ul>
  </li>
</ul>

<h2 id="what-are-you-building">What Are You Building?</h2>

<p>Credit card fraud is a growing concern in the digital age.
Criminals steal credit card numbers by running scams or hacking into insecure systems.
Stolen numbers are tested by making one or more small purchases, often for a dollar or less.
If that works, they then make more significant purchases to get items they can sell or keep for themselves.</p>

<p>In this tutorial, you will build a fraud detection system for alerting on suspicious credit card transactions.
Using a simple set of rules, you will see how Flink allows us to implement advanced business logic and act in real-time.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>This walkthrough assumes that you have some familiarity with Java or Scala, but you should be able to follow along even if you are coming from a different programming language.</p>

<h2 id="help-im-stuck">Help, I’m Stuck!</h2>

<p>If you get stuck, check out the <a href="https://flink.apache.org/gettinghelp.html">community support resources</a>.
In particular, Apache Flink’s <a href="https://flink.apache.org/community.html#mailing-lists">user mailing list</a> is consistently ranked as one of the most active of any Apache project and a great way to get help quickly.</p>

<h2 id="how-to-follow-along">How to Follow Along</h2>

<p>If you want to follow along, you will require a computer with:</p>

<ul>
  <li>Java 8 or 11</li>
  <li>Maven</li>
</ul>

<p>A provided Flink Maven Archetype will create a skeleton project with all the necessary dependencies quickly, so you only need to focus on filling out the business logic.
These dependencies include <code class="highlighter-rouge">flink-streaming-java</code> which is the core dependency for all Flink streaming applications and <code class="highlighter-rouge">flink-walkthrough-common</code> that has data generators and other classes specific to this walkthrough.</p>

<div class="panel panel-default"><div class="panel-body"><strong>Note:</strong> Each code block within this walkthrough may not contain the full surrounding class for brevity. The full code is available <a href="#final-application">at the bottom of the page</a>.</div></div>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mvn archetype:generate <span class="se">\</span>
    <span class="nt">-DarchetypeGroupId</span><span class="o">=</span>org.apache.flink <span class="se">\</span>
    <span class="nt">-DarchetypeArtifactId</span><span class="o">=</span>flink-walkthrough-datastream-java <span class="se">\</span>
    <span class="nt">-DarchetypeVersion</span><span class="o">=</span>1.12.0 <span class="se">\</span>
    <span class="nt">-DgroupId</span><span class="o">=</span>frauddetection <span class="se">\</span>
    <span class="nt">-DartifactId</span><span class="o">=</span>frauddetection <span class="se">\</span>
    <span class="nt">-Dversion</span><span class="o">=</span>0.1 <span class="se">\</span>
    <span class="nt">-Dpackage</span><span class="o">=</span>spendreport <span class="se">\</span>
    <span class="nt">-DinteractiveMode</span><span class="o">=</span><span class="nb">false</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>mvn archetype:generate <span class="se">\</span>
    <span class="nt">-DarchetypeGroupId</span><span class="o">=</span>org.apache.flink <span class="se">\</span>
    <span class="nt">-DarchetypeArtifactId</span><span class="o">=</span>flink-walkthrough-datastream-scala <span class="se">\</span>
    <span class="nt">-DarchetypeVersion</span><span class="o">=</span>1.12.0 <span class="se">\</span>
    <span class="nt">-DgroupId</span><span class="o">=</span>frauddetection <span class="se">\</span>
    <span class="nt">-DartifactId</span><span class="o">=</span>frauddetection <span class="se">\</span>
    <span class="nt">-Dversion</span><span class="o">=</span>0.1 <span class="se">\</span>
    <span class="nt">-Dpackage</span><span class="o">=</span>spendreport <span class="se">\</span>
    <span class="nt">-DinteractiveMode</span><span class="o">=</span><span class="nb">false</span></code></pre></figure>

  </div>
</div>

<p>You can edit the <code class="highlighter-rouge">groupId</code>, <code class="highlighter-rouge">artifactId</code> and <code class="highlighter-rouge">package</code> if you like. With the above parameters,
Maven will create a folder named <code class="highlighter-rouge">frauddetection</code> that contains a project with all the dependencies to complete this tutorial.
After importing the project into your editor, you can find a file <code class="highlighter-rouge">FraudDetectionJob.java</code> (or <code class="highlighter-rouge">FraudDetectionJob.scala</code>) with the following code which you can run directly inside your IDE.
Try setting break points through out the data stream and run the code in DEBUG mode to get a feeling for how everything works.</p>

<div class="codetabs">
  <div data-lang="java">
    <h4 id="frauddetectionjobjava">FraudDetectionJob.java</h4>

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">spendreport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.datastream.DataStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.environment.StreamExecutionEnvironment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.sink.AlertSink</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.source.TransactionSource</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FraudDetectionJob</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span>

        <span class="nc">DataStream</span><span class="o">&lt;</span><span class="nc">Transaction</span><span class="o">&gt;</span> <span class="n">transactions</span> <span class="o">=</span> <span class="n">env</span>
            <span class="o">.</span><span class="na">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">TransactionSource</span><span class="o">())</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"transactions"</span><span class="o">);</span>
        
        <span class="nc">DataStream</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">alerts</span> <span class="o">=</span> <span class="n">transactions</span>
            <span class="o">.</span><span class="na">keyBy</span><span class="o">(</span><span class="nl">Transaction:</span><span class="o">:</span><span class="n">getAccountId</span><span class="o">)</span>
            <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="k">new</span> <span class="nc">FraudDetector</span><span class="o">())</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"fraud-detector"</span><span class="o">);</span>

        <span class="n">alerts</span>
            <span class="o">.</span><span class="na">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">AlertSink</span><span class="o">())</span>
            <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"send-alerts"</span><span class="o">);</span>

        <span class="n">env</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"Fraud Detection"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

    <h4 id="frauddetectorjava">FraudDetector.java</h4>

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">spendreport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.functions.KeyedProcessFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.util.Collector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FraudDetector</span> <span class="kd">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Transaction</span><span class="o">,</span> <span class="nc">Alert</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">SMALL_AMOUNT</span> <span class="o">=</span> <span class="mf">1.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">LARGE_AMOUNT</span> <span class="o">=</span> <span class="mf">500.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">ONE_MINUTE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processElement</span><span class="o">(</span>
            <span class="nc">Transaction</span> <span class="n">transaction</span><span class="o">,</span>
            <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
            <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">collector</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="nc">Alert</span> <span class="n">alert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Alert</span><span class="o">();</span>
        <span class="n">alert</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAccountId</span><span class="o">());</span>

        <span class="n">collector</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">
    <h4 id="frauddetectionjobscala">FraudDetectionJob.scala</h4>

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">spendreport</span>

<span class="k">import</span> <span class="nn">org.apache.flink.streaming.api.scala._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.sink.AlertSink</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.source.TransactionSource</span>

<span class="k">object</span> <span class="nc">FraudDetectionJob</span> <span class="o">{</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">env</span><span class="k">:</span> <span class="kt">StreamExecutionEnvironment</span> <span class="o">=</span> <span class="nv">StreamExecutionEnvironment</span><span class="o">.</span><span class="py">getExecutionEnvironment</span>

    <span class="k">val</span> <span class="nv">transactions</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">Transaction</span><span class="o">]</span> <span class="k">=</span> <span class="n">env</span>
      <span class="o">.</span><span class="py">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">TransactionSource</span><span class="o">)</span>
      <span class="o">.</span><span class="py">name</span><span class="o">(</span><span class="s">"transactions"</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">alerts</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">Alert</span><span class="o">]</span> <span class="k">=</span> <span class="n">transactions</span>
      <span class="o">.</span><span class="py">keyBy</span><span class="o">(</span><span class="n">transaction</span> <span class="k">=&gt;</span> <span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>
      <span class="o">.</span><span class="py">process</span><span class="o">(</span><span class="k">new</span> <span class="nc">FraudDetector</span><span class="o">)</span>
      <span class="o">.</span><span class="py">name</span><span class="o">(</span><span class="s">"fraud-detector"</span><span class="o">)</span>

    <span class="n">alerts</span>
      <span class="o">.</span><span class="py">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">AlertSink</span><span class="o">)</span>
      <span class="o">.</span><span class="py">name</span><span class="o">(</span><span class="s">"send-alerts"</span><span class="o">)</span>

    <span class="nv">env</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="s">"Fraud Detection"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

    <h4 id="frauddetectorscala">FraudDetector.scala</h4>

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">spendreport</span>

<span class="k">import</span> <span class="nn">org.apache.flink.streaming.api.functions.KeyedProcessFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.util.Collector</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span>

<span class="k">object</span> <span class="nc">FraudDetector</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">SMALL_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">1.00</span>
  <span class="k">val</span> <span class="nv">LARGE_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">500.00</span>
  <span class="k">val</span> <span class="nv">ONE_MINUTE</span><span class="k">:</span> <span class="kt">Long</span>     <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span>
<span class="o">}</span>

<span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">FraudDetector</span> <span class="k">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span> <span class="o">{</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">processElement</span><span class="o">(</span>
      <span class="n">transaction</span><span class="k">:</span> <span class="kt">Transaction</span><span class="o">,</span>
      <span class="n">context</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">,</span>
      <span class="n">collector</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="nv">alert</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Alert</span>
    <span class="nv">alert</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>

    <span class="nv">collector</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<h2 id="breaking-down-the-code">Breaking Down the Code</h2>

<p>Let’s walk step-by-step through the code of these two files. The <code class="highlighter-rouge">FraudDetectionJob</code> class defines the data flow of the application and the <code class="highlighter-rouge">FraudDetector</code> class defines the business logic of the function that detects fraudulent transactions.</p>

<p>We start describing how the Job is assembled in the <code class="highlighter-rouge">main</code> method of the <code class="highlighter-rouge">FraudDetectionJob</code> class.</p>

<h4 id="the-execution-environment">The Execution Environment</h4>

<p>The first line sets up your <code class="highlighter-rouge">StreamExecutionEnvironment</code>.
The execution environment is how you set properties for your Job, create your sources, and finally trigger the execution of the Job.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">StreamExecutionEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">getExecutionEnvironment</span><span class="o">();</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="nv">env</span><span class="k">:</span> <span class="kt">StreamExecutionEnvironment</span> <span class="o">=</span> <span class="nv">StreamExecutionEnvironment</span><span class="o">.</span><span class="py">getExecutionEnvironment</span></code></pre></figure>

  </div>
</div>

<h4 id="creating-a-source">Creating a Source</h4>

<p>Sources ingest data from external systems, such as Apache Kafka, Rabbit MQ, or Apache Pulsar, into Flink Jobs.
This walkthrough uses a source that generates an infinite stream of credit card transactions for you to process.
Each transaction contains an account ID (<code class="highlighter-rouge">accountId</code>), timestamp (<code class="highlighter-rouge">timestamp</code>) of when the transaction occurred, and US$ amount (<code class="highlighter-rouge">amount</code>).
The <code class="highlighter-rouge">name</code> attached to the source is just for debugging purposes, so if something goes wrong, we will know where the error originated.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">DataStream</span><span class="o">&lt;</span><span class="nc">Transaction</span><span class="o">&gt;</span> <span class="n">transactions</span> <span class="o">=</span> <span class="n">env</span>
    <span class="o">.</span><span class="na">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">TransactionSource</span><span class="o">())</span>
    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"transactions"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="nv">transactions</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">Transaction</span><span class="o">]</span> <span class="k">=</span> <span class="n">env</span>
  <span class="o">.</span><span class="py">addSource</span><span class="o">(</span><span class="k">new</span> <span class="nc">TransactionSource</span><span class="o">)</span>
  <span class="o">.</span><span class="py">name</span><span class="o">(</span><span class="s">"transactions"</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<h4 id="partitioning-events--detecting-fraud">Partitioning Events &amp; Detecting Fraud</h4>

<p>The <code class="highlighter-rouge">transactions</code> stream contains a lot of transactions from a large number of users, such that it needs to be processed in parallel by multiple fraud detection tasks. Since fraud occurs on a per-account basis, you must ensure that all transactions for the same account are processed by the same parallel task of the fraud detector operator.</p>

<p>To ensure that the same physical task processes all records for a particular key, you can partition a stream using <code class="highlighter-rouge">DataStream#keyBy</code>. 
The <code class="highlighter-rouge">process()</code> call adds an operator that applies a function to each partitioned element in the stream.
It is common to say the operator immediately after a <code class="highlighter-rouge">keyBy</code>, in this case <code class="highlighter-rouge">FraudDetector</code>, is executed within a <em>keyed context</em>.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nc">DataStream</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">alerts</span> <span class="o">=</span> <span class="n">transactions</span>
    <span class="o">.</span><span class="na">keyBy</span><span class="o">(</span><span class="nl">Transaction:</span><span class="o">:</span><span class="n">getAccountId</span><span class="o">)</span>
    <span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="k">new</span> <span class="nc">FraudDetector</span><span class="o">())</span>
    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">"fraud-detector"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">val</span> <span class="nv">alerts</span><span class="k">:</span> <span class="kt">DataStream</span><span class="o">[</span><span class="kt">Alert</span><span class="o">]</span> <span class="k">=</span> <span class="n">transactions</span>
  <span class="o">.</span><span class="py">keyBy</span><span class="o">(</span><span class="n">transaction</span> <span class="k">=&gt;</span> <span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>
  <span class="o">.</span><span class="py">process</span><span class="o">(</span><span class="k">new</span> <span class="nc">FraudDetector</span><span class="o">)</span>
  <span class="o">.</span><span class="py">name</span><span class="o">(</span><span class="s">"fraud-detector"</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<h4 id="outputting-results">Outputting Results</h4>

<p>A sink writes a <code class="highlighter-rouge">DataStream</code> to an external system; such as Apache Kafka, Cassandra, and AWS Kinesis.
The <code class="highlighter-rouge">AlertSink</code> logs each <code class="highlighter-rouge">Alert</code> record with log level <strong>INFO</strong>, instead of writing it to persistent storage, so you can easily see your results.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">alerts</span><span class="o">.</span><span class="na">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">AlertSink</span><span class="o">());</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nv">alerts</span><span class="o">.</span><span class="py">addSink</span><span class="o">(</span><span class="k">new</span> <span class="nc">AlertSink</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<h4 id="executing-the-job">Executing the Job</h4>

<p>Flink applications are built lazily and shipped to the cluster for execution only once fully formed.
Call <code class="highlighter-rouge">StreamExecutionEnvironment#execute</code> to begin the execution of our Job and give it a name.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">env</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">"Fraud Detection"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nv">env</span><span class="o">.</span><span class="py">execute</span><span class="o">(</span><span class="s">"Fraud Detection"</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<h4 id="the-fraud-detector">The Fraud Detector</h4>

<p>The fraud detector is implemented as a <code class="highlighter-rouge">KeyedProcessFunction</code>.
Its method <code class="highlighter-rouge">KeyedProcessFunction#processElement</code> is called for every transaction event.
This first version produces an alert on every transaction, which some may say is overly conservative.</p>

<p>The next steps of this tutorial will guide you to expand the fraud detector with more meaningful business logic.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FraudDetector</span> <span class="kd">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Transaction</span><span class="o">,</span> <span class="nc">Alert</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">SMALL_AMOUNT</span> <span class="o">=</span> <span class="mf">1.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">LARGE_AMOUNT</span> <span class="o">=</span> <span class="mf">500.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">ONE_MINUTE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processElement</span><span class="o">(</span>
            <span class="nc">Transaction</span> <span class="n">transaction</span><span class="o">,</span>
            <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
            <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">collector</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  
        <span class="nc">Alert</span> <span class="n">alert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Alert</span><span class="o">();</span>
        <span class="n">alert</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAccountId</span><span class="o">());</span>

        <span class="n">collector</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">object</span> <span class="nc">FraudDetector</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">SMALL_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">1.00</span>
  <span class="k">val</span> <span class="nv">LARGE_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">500.00</span>
  <span class="k">val</span> <span class="nv">ONE_MINUTE</span><span class="k">:</span> <span class="kt">Long</span>     <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span>
<span class="o">}</span>

<span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">FraudDetector</span> <span class="k">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span> <span class="o">{</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">def</span> <span class="nf">processElement</span><span class="o">(</span>
      <span class="n">transaction</span><span class="k">:</span> <span class="kt">Transaction</span><span class="o">,</span>
      <span class="n">context</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">,</span>
      <span class="n">collector</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="k">val</span> <span class="nv">alert</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Alert</span>
    <span class="nv">alert</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>

    <span class="nv">collector</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<h2 id="writing-a-real-application-v1">Writing a Real Application (v1)</h2>

<p>For the first version, the fraud detector should output an alert for any account that makes a small transaction immediately followed by a large one. Where small is anything less than $1.00 and large is more than $500.
Imagine your fraud detector processes the following stream of transactions for a particular account.</p>

<p class="text-center">
    <img alt="Transactions" width="80%" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/fig/fraud-transactions.svg" />
</p>

<p>Transactions 3 and 4 should be marked as fraudulent because it is a small transaction, $0.09, followed by a large one, $510.
Alternatively, transactions 7, 8, and 9 are not fraud because the small amount of $0.02 is not immediately followed by the large one; instead, there is an intermediate transaction that breaks the pattern.</p>

<p>To do this, the fraud detector must <em>remember</em> information across events; a large transaction is only fraudulent if the previous one was small.
Remembering information across events requires <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/concepts/glossary.html#managed-state">state</a>, and that is why we decided to use a <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/operators/process_function.html">KeyedProcessFunction</a>. 
It provides fine-grained control over both state and time, which will allow us to evolve our algorithm with more complex requirements throughout this walkthrough.</p>

<p>The most straightforward implementation is a boolean flag that is set whenever a small transaction is processed.
When a large transaction comes through, you can simply check if the flag is set for that account.</p>

<p>However, merely implementing the flag as a member variable in the <code class="highlighter-rouge">FraudDetector</code> class will not work. 
Flink processes the transactions of multiple accounts with the same object instance of <code class="highlighter-rouge">FraudDetector</code>, which means if accounts A and B are routed through the same instance of <code class="highlighter-rouge">FraudDetector</code>, a transaction for account A could set the flag to true and then a transaction for account B could set off a false alert. 
We could of course use a data structure like a <code class="highlighter-rouge">Map</code> to keep track of the flags for individual keys, however, a simple member variable would not be fault-tolerant and all its information be lost in case of a failure.
Hence, the fraud detector would possibly miss alerts if the application ever had to restart to recover from a failure.</p>

<p>To address these challenges, Flink provides primitives for fault-tolerant state that are almost as easy to use as regular member variables.</p>

<p>The most basic type of state in Flink is <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/stream/state/state.html#using-managed-keyed-state">ValueState</a>, a data type that adds fault tolerance to any variable it wraps.
<code class="highlighter-rouge">ValueState</code> is a form of <em>keyed state</em>, meaning it is only available in operators that are applied in a <em>keyed context</em>; any operator immediately following <code class="highlighter-rouge">DataStream#keyBy</code>.
A <em>keyed state</em> of an operator is automatically scoped to the key of the record that is currently processed.
In this example, the key is the account id for the current transaction (as declared by <code class="highlighter-rouge">keyBy()</code>), and <code class="highlighter-rouge">FraudDetector</code> maintains an independent state for each account. 
<code class="highlighter-rouge">ValueState</code> is created using a <code class="highlighter-rouge">ValueStateDescriptor</code> which contains metadata about how Flink should manage the variable. The state should be registered before the function starts processing data.
The right hook for this is the <code class="highlighter-rouge">open()</code> method.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FraudDetector</span> <span class="kd">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Transaction</span><span class="o">,</span> <span class="nc">Alert</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValueState</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagState</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">Configuration</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ValueStateDescriptor</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
                <span class="s">"flag"</span><span class="o">,</span>
                <span class="nc">Types</span><span class="o">.</span><span class="na">BOOLEAN</span><span class="o">);</span>
        <span class="n">flagState</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">);</span>
    <span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">FraudDetector</span> <span class="k">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span> <span class="o">{</span>

  <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">flagState</span><span class="k">:</span> <span class="kt">ValueState</span><span class="o">[</span><span class="kt">java.lang.Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">open</span><span class="o">(</span><span class="n">parameters</span><span class="k">:</span> <span class="kt">Configuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">flagDescriptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">(</span><span class="s">"flag"</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">BOOLEAN</span><span class="o">)</span>
    <span class="n">flagState</span> <span class="k">=</span> <span class="nv">getRuntimeContext</span><span class="o">.</span><span class="py">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">)</span>
  <span class="o">}</span></code></pre></figure>

  </div>
</div>

<p><code class="highlighter-rouge">ValueState</code> is a wrapper class, similar to <code class="highlighter-rouge">AtomicReference</code> or <code class="highlighter-rouge">AtomicLong</code> in the Java standard library.
It provides three methods for interacting with its contents; <code class="highlighter-rouge">update</code> sets the state, <code class="highlighter-rouge">value</code> gets the current value, and <code class="highlighter-rouge">clear</code> deletes its contents.
If the state for a particular key is empty, such as at the beginning of an application or after calling <code class="highlighter-rouge">ValueState#clear</code>, then <code class="highlighter-rouge">ValueState#value</code> will return <code class="highlighter-rouge">null</code>.
Modifications to the object returned by <code class="highlighter-rouge">ValueState#value</code> are not guaranteed to be recognized by the system, and so all changes must be performed with <code class="highlighter-rouge">ValueState#update</code>.
Otherwise, fault tolerance is managed automatically by Flink under the hood, and so you can interact with it like with any standard variable.</p>

<p>Below, you can see an example of how you can use a flag state to track potential fraudulent transactions.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">processElement</span><span class="o">(</span>
        <span class="nc">Transaction</span> <span class="n">transaction</span><span class="o">,</span>
        <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
        <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">collector</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="c1">// Get the current state for the current key</span>
    <span class="nc">Boolean</span> <span class="n">lastTransactionWasSmall</span> <span class="o">=</span> <span class="n">flagState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

    <span class="c1">// Check if the flag is set</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lastTransactionWasSmall</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">LARGE_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// Output an alert downstream</span>
            <span class="nc">Alert</span> <span class="n">alert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Alert</span><span class="o">();</span>
            <span class="n">alert</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAccountId</span><span class="o">());</span>

            <span class="n">collector</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">);</span>            
        <span class="o">}</span>

        <span class="c1">// Clean up our state</span>
        <span class="n">flagState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Set the flag to true</span>
        <span class="n">flagState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">override</span> <span class="k">def</span> <span class="nf">processElement</span><span class="o">(</span>
    <span class="n">transaction</span><span class="k">:</span> <span class="kt">Transaction</span><span class="o">,</span>
    <span class="n">context</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">,</span>
    <span class="n">collector</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

  <span class="c1">// Get the current state for the current key</span>
  <span class="k">val</span> <span class="nv">lastTransactionWasSmall</span> <span class="k">=</span> <span class="nv">flagState</span><span class="o">.</span><span class="py">value</span>

  <span class="c1">// Check if the flag is set</span>
  <span class="nf">if</span> <span class="o">(</span><span class="n">lastTransactionWasSmall</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAmount</span> <span class="o">&gt;</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">LARGE_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Output an alert downstream</span>
      <span class="k">val</span> <span class="nv">alert</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Alert</span>
      <span class="nv">alert</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>

      <span class="nv">collector</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="c1">// Clean up our state</span>
    <span class="nv">flagState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="nf">if</span> <span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAmount</span> <span class="o">&lt;</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// set the flag to true</span>
    <span class="nv">flagState</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>For every transaction, the fraud detector checks the state of the flag for that account.
Remember, <code class="highlighter-rouge">ValueState</code> is always scoped to the current key, i.e., account.
If the flag is non-null, then the last transaction seen for that account was small, and so if the amount for this transaction is large, then the detector outputs a fraud alert.</p>

<p>After that check, the flag state is unconditionally cleared.
Either the current transaction caused a fraud alert, and the pattern is over, or the current transaction did not cause an alert, and the pattern is broken and needs to be restarted.</p>

<p>Finally, the transaction amount is checked to see if it is small.
If so, then the flag is set so that it can be checked by the next event.
Notice that <code class="highlighter-rouge">ValueState&lt;Boolean&gt;</code> actually has three states, unset ( <code class="highlighter-rouge">null</code>), <code class="highlighter-rouge">true</code>, and <code class="highlighter-rouge">false</code>, because all <code class="highlighter-rouge">ValueState</code>’s are nullable.
This job only makes use of unset ( <code class="highlighter-rouge">null</code>) and <code class="highlighter-rouge">true</code> to check whether the flag is set or not.</p>

<h2 id="fraud-detector-v2-state--time--️">Fraud Detector v2: State + Time = ❤️</h2>

<p>Scammers don’t wait long to make their large purchase to reduce the chances their test transaction is noticed. 
For example, suppose you wanted to set a 1 minute timeout to your fraud detector; i.e., in the previous example transactions 3 and 4 would only be considered fraud if they occurred within 1 minute of each other.
Flink’s <code class="highlighter-rouge">KeyedProcessFunction</code> allows you to set timers which invoke a callback method at some point in time in the future.</p>

<p>Let’s see how we can modify our Job to comply with our new requirements:</p>

<ul>
  <li>Whenever the flag is set to <code class="highlighter-rouge">true</code>, also set a timer for 1 minute in the future.</li>
  <li>When the timer fires, reset the flag by clearing its state.</li>
  <li>If the flag is ever cleared the timer should be canceled.</li>
</ul>

<p>To cancel a timer, you have to remember what time it is set for, and remembering implies state, so you will begin by creating a timer state along with your flag state.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValueState</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagState</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValueState</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">timerState</span><span class="o">;</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">Configuration</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ValueStateDescriptor</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
            <span class="s">"flag"</span><span class="o">,</span>
            <span class="nc">Types</span><span class="o">.</span><span class="na">BOOLEAN</span><span class="o">);</span>
    <span class="n">flagState</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">);</span>

    <span class="nc">ValueStateDescriptor</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">timerDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
            <span class="s">"timer-state"</span><span class="o">,</span>
            <span class="nc">Types</span><span class="o">.</span><span class="na">LONG</span><span class="o">);</span>
    <span class="n">timerState</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">timerDescriptor</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">FraudDetector</span> <span class="k">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span> <span class="o">{</span>

  <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">flagState</span><span class="k">:</span> <span class="kt">ValueState</span><span class="o">[</span><span class="kt">java.lang.Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>
  <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">timerState</span><span class="k">:</span> <span class="kt">ValueState</span><span class="o">[</span><span class="kt">java.lang.Long</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">open</span><span class="o">(</span><span class="n">parameters</span><span class="k">:</span> <span class="kt">Configuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">flagDescriptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">(</span><span class="s">"flag"</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">BOOLEAN</span><span class="o">)</span>
    <span class="n">flagState</span> <span class="k">=</span> <span class="nv">getRuntimeContext</span><span class="o">.</span><span class="py">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">timerDescriptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">(</span><span class="s">"timer-state"</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">LONG</span><span class="o">)</span>
    <span class="n">timerState</span> <span class="k">=</span> <span class="nv">getRuntimeContext</span><span class="o">.</span><span class="py">getState</span><span class="o">(</span><span class="n">timerDescriptor</span><span class="o">)</span>
  <span class="o">}</span></code></pre></figure>

  </div>
</div>

<p><code class="highlighter-rouge">KeyedProcessFunction#processElement</code> is called with a <code class="highlighter-rouge">Context</code> that contains a timer service.
The timer service can be used to query the current time, register timers, and delete timers.
With this, you can set a timer for 1 minute in the future every time the flag is set and store the timestamp in <code class="highlighter-rouge">timerState</code>.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// set the flag to true</span>
    <span class="n">flagState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="c1">// set the timer and timer state</span>
    <span class="kt">long</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">currentProcessingTime</span><span class="o">()</span> <span class="o">+</span> <span class="no">ONE_MINUTE</span><span class="o">;</span>
    <span class="n">context</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">registerProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>
    <span class="n">timerState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nf">if</span> <span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAmount</span> <span class="o">&lt;</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// set the flag to true</span>
  <span class="nv">flagState</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>

  <span class="c1">// set the timer and timer state</span>
  <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">currentProcessingTime</span> <span class="o">+</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">ONE_MINUTE</span>
  <span class="nv">context</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">registerProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>
  <span class="nv">timerState</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>Processing time is wall clock time, and is determined by the system clock of the machine running the operator.</p>

<p>When a timer fires, it calls <code class="highlighter-rouge">KeyedProcessFunction#onTimer</code>. 
Overriding this method is how you can implement your callback to reset the flag.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTimer</span><span class="o">(</span><span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">OnTimerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// remove flag after 1 minute</span>
    <span class="n">timerState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">flagState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

  </div>
  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">override</span> <span class="k">def</span> <span class="nf">onTimer</span><span class="o">(</span>
    <span class="n">timestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
    <span class="n">ctx</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">OnTimerContext</span><span class="o">,</span>
    <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="c1">// remove flag after 1 minute</span>
  <span class="nv">timerState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
  <span class="nv">flagState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>Finally, to cancel the timer, you need to delete the registered timer and delete the timer state.
You can wrap this in a helper method and call this method instead of <code class="highlighter-rouge">flagState.clear()</code>.</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">cleanUp</span><span class="o">(</span><span class="nc">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// delete timer</span>
    <span class="nc">Long</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">timerState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">deleteProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>

    <span class="c1">// clean up all state</span>
    <span class="n">timerState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">flagState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
<span class="k">private</span> <span class="k">def</span> <span class="nf">cleanUp</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
  <span class="c1">// delete timer</span>
  <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">timerState</span><span class="o">.</span><span class="py">value</span>
  <span class="nv">ctx</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">deleteProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>

  <span class="c1">// clean up all states</span>
  <span class="nv">timerState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
  <span class="nv">flagState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>And that’s it, a fully functional, stateful, distributed streaming application!</p>

<h2 id="final-application">Final Application</h2>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">spendreport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.flink.api.common.state.ValueState</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.api.common.state.ValueStateDescriptor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.api.common.typeinfo.Types</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.configuration.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.streaming.api.functions.KeyedProcessFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.util.Collector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FraudDetector</span> <span class="kd">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Transaction</span><span class="o">,</span> <span class="nc">Alert</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">SMALL_AMOUNT</span> <span class="o">=</span> <span class="mf">1.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">LARGE_AMOUNT</span> <span class="o">=</span> <span class="mf">500.00</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">ONE_MINUTE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValueState</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagState</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">transient</span> <span class="nc">ValueState</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">timerState</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">Configuration</span> <span class="n">parameters</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ValueStateDescriptor</span><span class="o">&lt;</span><span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">flagDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
                <span class="s">"flag"</span><span class="o">,</span>
                <span class="nc">Types</span><span class="o">.</span><span class="na">BOOLEAN</span><span class="o">);</span>
        <span class="n">flagState</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">);</span>

        <span class="nc">ValueStateDescriptor</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">timerDescriptor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">&lt;&gt;(</span>
                <span class="s">"timer-state"</span><span class="o">,</span>
                <span class="nc">Types</span><span class="o">.</span><span class="na">LONG</span><span class="o">);</span>
        <span class="n">timerState</span> <span class="o">=</span> <span class="n">getRuntimeContext</span><span class="o">().</span><span class="na">getState</span><span class="o">(</span><span class="n">timerDescriptor</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processElement</span><span class="o">(</span>
            <span class="nc">Transaction</span> <span class="n">transaction</span><span class="o">,</span>
            <span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
            <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">collector</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">// Get the current state for the current key</span>
        <span class="nc">Boolean</span> <span class="n">lastTransactionWasSmall</span> <span class="o">=</span> <span class="n">flagState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

        <span class="c1">// Check if the flag is set</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lastTransactionWasSmall</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="no">LARGE_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//Output an alert downstream</span>
                <span class="nc">Alert</span> <span class="n">alert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Alert</span><span class="o">();</span>
                <span class="n">alert</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAccountId</span><span class="o">());</span>

                <span class="n">collector</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// Clean up our state</span>
            <span class="n">cleanUp</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">transaction</span><span class="o">.</span><span class="na">getAmount</span><span class="o">()</span> <span class="o">&lt;</span> <span class="no">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// set the flag to true</span>
            <span class="n">flagState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="kt">long</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">currentProcessingTime</span><span class="o">()</span> <span class="o">+</span> <span class="no">ONE_MINUTE</span><span class="o">;</span>
            <span class="n">context</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">registerProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>

            <span class="n">timerState</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTimer</span><span class="o">(</span><span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">OnTimerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Alert</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// remove flag after 1 minute</span>
        <span class="n">timerState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">flagState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">cleanUp</span><span class="o">(</span><span class="nc">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// delete timer</span>
        <span class="nc">Long</span> <span class="n">timer</span> <span class="o">=</span> <span class="n">timerState</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">timerService</span><span class="o">().</span><span class="na">deleteProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">);</span>

        <span class="c1">// clean up all state</span>
        <span class="n">timerState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">flagState</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">package</span> <span class="nn">spendreport</span>

<span class="k">import</span> <span class="nn">org.apache.flink.api.common.state.</span><span class="o">{</span><span class="nc">ValueState</span><span class="o">,</span> <span class="nc">ValueStateDescriptor</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.flink.api.scala.typeutils.Types</span>
<span class="k">import</span> <span class="nn">org.apache.flink.configuration.Configuration</span>
<span class="k">import</span> <span class="nn">org.apache.flink.streaming.api.functions.KeyedProcessFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.util.Collector</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Alert</span>
<span class="k">import</span> <span class="nn">org.apache.flink.walkthrough.common.entity.Transaction</span>

<span class="k">object</span> <span class="nc">FraudDetector</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">SMALL_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">1.00</span>
  <span class="k">val</span> <span class="nv">LARGE_AMOUNT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">500.00</span>
  <span class="k">val</span> <span class="nv">ONE_MINUTE</span><span class="k">:</span> <span class="kt">Long</span>     <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span>
<span class="o">}</span>

<span class="nd">@SerialVersionUID</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
<span class="k">class</span> <span class="nc">FraudDetector</span> <span class="k">extends</span> <span class="nc">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span> <span class="o">{</span>

  <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">flagState</span><span class="k">:</span> <span class="kt">ValueState</span><span class="o">[</span><span class="kt">java.lang.Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>
  <span class="nd">@transient</span> <span class="k">private</span> <span class="k">var</span> <span class="n">timerState</span><span class="k">:</span> <span class="kt">ValueState</span><span class="o">[</span><span class="kt">java.lang.Long</span><span class="o">]</span> <span class="k">=</span> <span class="k">_</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">open</span><span class="o">(</span><span class="n">parameters</span><span class="k">:</span> <span class="kt">Configuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">flagDescriptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">(</span><span class="s">"flag"</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">BOOLEAN</span><span class="o">)</span>
    <span class="n">flagState</span> <span class="k">=</span> <span class="nv">getRuntimeContext</span><span class="o">.</span><span class="py">getState</span><span class="o">(</span><span class="n">flagDescriptor</span><span class="o">)</span>

    <span class="k">val</span> <span class="nv">timerDescriptor</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ValueStateDescriptor</span><span class="o">(</span><span class="s">"timer-state"</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">LONG</span><span class="o">)</span>
    <span class="n">timerState</span> <span class="k">=</span> <span class="nv">getRuntimeContext</span><span class="o">.</span><span class="py">getState</span><span class="o">(</span><span class="n">timerDescriptor</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">processElement</span><span class="o">(</span>
      <span class="n">transaction</span><span class="k">:</span> <span class="kt">Transaction</span><span class="o">,</span>
      <span class="n">context</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">,</span>
      <span class="n">collector</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

    <span class="c1">// Get the current state for the current key</span>
    <span class="k">val</span> <span class="nv">lastTransactionWasSmall</span> <span class="k">=</span> <span class="nv">flagState</span><span class="o">.</span><span class="py">value</span>

    <span class="c1">// Check if the flag is set</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">lastTransactionWasSmall</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAmount</span> <span class="o">&gt;</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">LARGE_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Output an alert downstream</span>
        <span class="k">val</span> <span class="nv">alert</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Alert</span>
        <span class="nv">alert</span><span class="o">.</span><span class="py">setId</span><span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAccountId</span><span class="o">)</span>

        <span class="nv">collector</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="n">alert</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="c1">// Clean up our state</span>
      <span class="nf">cleanUp</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="nf">if</span> <span class="o">(</span><span class="nv">transaction</span><span class="o">.</span><span class="py">getAmount</span> <span class="o">&lt;</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">SMALL_AMOUNT</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// set the flag to true</span>
      <span class="nv">flagState</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
      <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">currentProcessingTime</span> <span class="o">+</span> <span class="nv">FraudDetector</span><span class="o">.</span><span class="py">ONE_MINUTE</span>

      <span class="nv">context</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">registerProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>
      <span class="nv">timerState</span><span class="o">.</span><span class="py">update</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">onTimer</span><span class="o">(</span>
      <span class="n">timestamp</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
      <span class="n">ctx</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">OnTimerContext</span><span class="o">,</span>
      <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">Alert</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// remove flag after 1 minute</span>
    <span class="nv">timerState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
    <span class="nv">flagState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="nd">@throws</span><span class="o">[</span><span class="kt">Exception</span><span class="o">]</span>
  <span class="k">private</span> <span class="k">def</span> <span class="nf">cleanUp</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">KeyedProcessFunction</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">Transaction</span>, <span class="kt">Alert</span><span class="o">]</span><span class="k">#</span><span class="nc">Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// delete timer</span>
    <span class="k">val</span> <span class="nv">timer</span> <span class="k">=</span> <span class="nv">timerState</span><span class="o">.</span><span class="py">value</span>
    <span class="nv">ctx</span><span class="o">.</span><span class="py">timerService</span><span class="o">.</span><span class="py">deleteProcessingTimeTimer</span><span class="o">(</span><span class="n">timer</span><span class="o">)</span>

    <span class="c1">// clean up all states</span>
    <span class="nv">timerState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
    <span class="nv">flagState</span><span class="o">.</span><span class="py">clear</span><span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<h3 id="expected-output">Expected Output</h3>

<p>Running this code with the provided <code class="highlighter-rouge">TransactionSource</code> will emit fraud alerts for account 3.
You should see the following output in your task manager logs:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">2019-08-19 14:22:06,220 INFO  org.apache.flink.walkthrough.common.sink.AlertSink            - Alert<span class="o">{</span><span class="nb">id</span><span class="o">=</span>3<span class="o">}</span>
2019-08-19 14:22:11,383 INFO  org.apache.flink.walkthrough.common.sink.AlertSink            - Alert<span class="o">{</span><span class="nb">id</span><span class="o">=</span>3<span class="o">}</span>
2019-08-19 14:22:16,551 INFO  org.apache.flink.walkthrough.common.sink.AlertSink            - Alert<span class="o">{</span><span class="nb">id</span><span class="o">=</span>3<span class="o">}</span>
2019-08-19 14:22:21,723 INFO  org.apache.flink.walkthrough.common.sink.AlertSink            - Alert<span class="o">{</span><span class="nb">id</span><span class="o">=</span>3<span class="o">}</span>
2019-08-19 14:22:26,896 INFO  org.apache.flink.walkthrough.common.sink.AlertSink            - Alert<span class="o">{</span><span class="nb">id</span><span class="o">=</span>3<span class="o">}</span></code></pre></figure>




<div class="footer">
  <a href="https://cwiki.apache.org/confluence/display/FLINK/Flink+Translation+Specifications" target="_blank">
    
      Want to contribute translation?
    
  </a>
</div>


        </div>
      </div>
    </div><!-- /.container -->

    <!-- default code tab -->
    <script>var defaultCodeTab = "";</script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>

    <!-- Disqus -->
    
  </body>
</html>
