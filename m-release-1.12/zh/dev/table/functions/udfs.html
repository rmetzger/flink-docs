<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Apache Flink 1.12 Documentation: 自定义函数</title>
    <link rel="shortcut icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="icon" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="//ci.apache.org/projects/flink/flink-docs-stable/zh/dev/table/functions/udfs.html">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/flink.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/syntax.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/css/codetabs.css">
    <link rel="stylesheet" href="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/font-awesome/css/font-awesome.min.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    

    <!-- Main content. -->
    <div class="container">
      
      <div class="row">
        <div class="col-lg-3" id="sidenavcol">
          <div class="sidenav-logo">
  <p><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/"><img class="bottom" alt="Apache Flink" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/img/navbar-brand-logo.jpg"></a> v1.12</p>
</div>
<ul id="sidenav">
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/"><i class="fa fa-home title" aria-hidden="true"></i> Home</a></li><hr class="section-break"></hr>
<li><a href="#collapse-2" data-toggle="collapse"><i class="fa fa-rocket title appetizer" aria-hidden="true"></i> Try Flink<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-2"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/try-flink/local_installation.html">本地模式安装</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/try-flink/datastream_api.html">基于 DataStream API 实现欺诈检测</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/try-flink/table_api.html">基于 Table API 实现实时报表</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/try-flink/flink-operations-playground.html">Flink 操作场景</a></li>
</ul></div></li>
<li><a href="#collapse-8" data-toggle="collapse"><i class="fa fa-hand-paper-o title appetizer" aria-hidden="true"></i> 实践练习<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-8"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/datastream_api.html">DataStream API 简介</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/etl.html">数据管道 & ETL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/streaming_analytics.html">流式分析</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/event_driven.html">事件驱动应用</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/learn-flink/fault_tolerance.html">容错处理</a></li>
</ul></div></li>
<li><a href="#collapse-15" data-toggle="collapse"><i class="fa fa-map-o title appetizer" aria-hidden="true"></i> 概念透析<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-15"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/concepts/index.html">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/concepts/stateful-stream-processing.html">有状态流处理</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/concepts/timely-stream-processing.html">及时流处理</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/concepts/flink-architecture.html">Flink 架构</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/concepts/glossary.html">词汇表</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-21" data-toggle="collapse"class="active"><i class="fa fa-code title maindish" aria-hidden="true"></i> 应用开发</a><div class="collapse in" id="collapse-21"><ul>
<li><a href="#collapse-22" data-toggle="collapse">DataStream API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-22"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/datastream_api.html">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/datastream_execution_mode.html">Execution Mode (Batch/Streaming)</a></li>
<li><a href="#collapse-24" data-toggle="collapse">事件时间<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-24"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/event_time.html">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/event_timestamps_watermarks.html">生成 Watermark</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/event_timestamp_extractors.html">内置 Watermark 生成器</a></li>
</ul></div></li>
<li><a href="#collapse-28" data-toggle="collapse">状态与容错<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-28"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/state.html">Working with State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/broadcast_state.html">Broadcast State 模式</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/checkpointing.html">Checkpointing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/queryable_state.html">Queryable State</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/schema_evolution.html">状态数据结构升级</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/state/custom_serialization.html">自定义状态序列化</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/user_defined_functions.html">用户自定义 Functions</a></li>
<li><a href="#collapse-38" data-toggle="collapse">算子<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-38"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/windows.html">窗口</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/joining.html">Joining</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/process_function.html">Process Function</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/operators/asyncio.html">异步 I/O</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/sources.html">Data Sources</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/side_output.html">旁路输出</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/application_parameters.html">Handling Application Parameters</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/testing.html">测试</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/stream/experimental.html">实验功能</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/scala_api_extensions.html">Scala API Extensions</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/java_lambdas.html">Java Lambda 表达式</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/project-configuration.html">Project Configuration</a></li>
</ul></div></li>
<li><a href="#collapse-53" data-toggle="collapse">DataSet API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-53"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/dataset_transformations.html">Transformations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/iterations.html">迭代</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/zip_elements_guide.html">Zipping Elements</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/hadoop_compatibility.html">Hadoop 兼容</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/local_execution.html">本地执行</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/cluster_execution.html">集群执行</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/examples.html">Batch 示例</a></li>
</ul></div></li>
<li><a href="#collapse-62" data-toggle="collapse"class="active">Table API & SQL</a><div class="collapse in" id="collapse-62"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/common.html">概念与通用 API</a></li>
<li><a href="#collapse-64" data-toggle="collapse">流式概念<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-64"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/dynamic_tables.html">动态表 (Dynamic Table)</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/time_attributes.html">时间属性</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/joins.html">流上的 Join</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/temporal_tables.html">时态表（Temporal Tables）</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/match_recognize.html">模式检测</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/streaming/query_configuration.html">Query Configuration</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">数据类型</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/tableApi.html">Table API</a></li>
<li><a href="#collapse-74" data-toggle="collapse">SQL<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-74"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/queries.html">查询语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/create.html">CREATE 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/drop.html">DROP 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/alter.html">ALTER 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/insert.html">INSERT 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/hints.html">SQL Hints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/describe.html">DESCRIBE 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/explain.html">EXPLAIN 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/use.html">USE 语句</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sql/show.html">SHOW 语句</a></li>
</ul></div></li>
<li><a href="#collapse-86" data-toggle="collapse"class="active">函数</a><div class="collapse in" id="collapse-86"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/systemFunctions.html">系统（内置）函数</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/udfs.html" class="active">自定义函数</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/modules.html">模块</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sqlClient.html">SQL 客户端</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/config.html">配置</a></li>
<li><a href="#collapse-94" data-toggle="collapse">Performance Tuning<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-94"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/tuning/streaming_aggregation_optimization.html">流式聚合</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/sourceSinks.html">User-defined Sources & Sinks</a></li>
</ul></div></li>
<li><a href="#collapse-99" data-toggle="collapse">Python API<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-99"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/installation.html">环境安装</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table_api_tutorial.html">Table API 教程</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/datastream_tutorial.html">DataStream API 教程</a></li>
<li><a href="#collapse-103" data-toggle="collapse">Table API用户指南<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-103"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/intro_to_table_api.html">Python Table API 简介</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/table_environment.html">TableEnvironment</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/operations.html">Operations</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/python_types.html">数据类型</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/built_in_functions.html">系统（内置）函数</a></li>
<li><a href="#collapse-109" data-toggle="collapse">自定义函数<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-109"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/udfs/python_udfs.html">普通自定义函数（UDF）</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/udfs/vectorized_python_udfs.html">向量化自定义函数</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/conversion_of_pandas.html">PyFlink Table 和 Pandas DataFrame 互转</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/dependency_management.html">依赖管理</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/sql.html">SQL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/catalogs.html">Catalogs</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/metrics.html">指标</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/python_table_api_connectors.html">连接器</a></li>
</ul></div></li>
<li><a href="#collapse-120" data-toggle="collapse">DataStream API用户指南<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-120"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/datastream-api-users-guide/data_types.html">数据类型</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/datastream-api-users-guide/operators.html">算子</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/datastream-api-users-guide/dependency_management.html">依赖管理</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/python_config.html">配置</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/environment_variables.html">环境变量</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/faq.html">常见问题</a></li>
</ul></div></li>
<li><a href="#collapse-129" data-toggle="collapse">数据类型以及序列化<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-129"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/types_serialization.html">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/custom_serializers.html">自定义序列化器</a></li>
</ul></div></li>
<li><a href="#collapse-132" data-toggle="collapse">管理执行<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-132"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/execution_configuration.html">执行配置</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/packaging.html">程序打包</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/parallel.html">并行执行</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/execution_plans.html">执行计划</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/task_failure_recovery.html">Task 故障恢复</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/migration.html">API 迁移指南</a></li>
</ul></div></li>
<li><a href="#collapse-141" data-toggle="collapse"><i class="fa fa-book title maindish" aria-hidden="true"></i> Libraries<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-141"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/cep.html">事件处理 (CEP)</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/state_processor_api.html">State Processor API</a></li>
<li><a href="#collapse-144" data-toggle="collapse">图计算: Gelly<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-144"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/graph_api.html">Graph API</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/iterative_graph_processing.html">Iterative Graph Processing</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/library_methods.html">Library Methods</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/graph_algorithms.html">Graph Algorithms</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/graph_generators.html">Graph Generators</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/libs/gelly/bipartite_graph.html">Bipartite Graph</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-153" data-toggle="collapse"><i class="fa fa-random title maindish" aria-hidden="true"></i> Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-153"><ul>
<li><a href="#collapse-154" data-toggle="collapse">DataStream Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-154"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/guarantees.html">容错保证</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/cassandra.html">Cassandra</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/file_sink.html">File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/streamfile_sink.html">Streaming File Sink</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/rabbitmq.html">RabbitMQ</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/nifi.html">NiFi</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/pubsub.html">Google Cloud PubSub</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/twitter.html">Twitter</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/connectors/jdbc.html">JDBC</a></li>
</ul></div></li>
<li><a href="#collapse-168" data-toggle="collapse">Table & SQL Connectors<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-168"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/">概览</a></li>
<li><a href="#collapse-169" data-toggle="collapse">Formats<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-169"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/csv.html">CSV</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/json.html">JSON</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/avro-confluent.html">Confluent Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/avro.html">Avro</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/debezium.html">Debezium</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/canal.html">Canal</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/maxwell.html">Maxwell</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/parquet.html">Parquet</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/orc.html">Orc</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/formats/raw.html">Raw</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/kafka.html">Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/upsert-kafka.html">Upsert Kafka</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/kinesis.html">Kinesis</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/jdbc.html">JDBC</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/elasticsearch.html">Elasticsearch</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/filesystem.html">FileSystem</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hbase.html">HBase</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/datagen.html">DataGen</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/print.html">Print</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/blackhole.html">BlackHole</a></li>
<li><a href="#collapse-191" data-toggle="collapse">Hive<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-191"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hive/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hive/hive_catalog.html">Hive Catalog</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hive/hive_dialect.html">Hive 方言</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hive/hive_read_write.html">Hive Read & Write</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/hive/hive_functions.html">Hive 函数</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/connectors/downloads.html">下载</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/batch/connectors.html">DataSet Connectors</a></li>
</ul></div></li>
<li><a href="#collapse-201" data-toggle="collapse"><i class="fa fa-sliders title maindish" aria-hidden="true"></i> Deployment<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-201"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/">概览</a></li>
<li><a href="#collapse-202" data-toggle="collapse">Resource Providers<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-202"><ul>
<li><a href="#collapse-203" data-toggle="collapse">Standalone<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-203"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/standalone/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/standalone/local.html">本地集群</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/standalone/docker.html">Docker</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/standalone/kubernetes.html">Kubernetes</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/native_kubernetes.html">Native Kubernetes</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/yarn.html">YARN</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/resource-providers/mesos.html">Mesos</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/config.html">配置参数</a></li>
<li><a href="#collapse-213" data-toggle="collapse">内存配置<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-213"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_setup.html">配置 Flink 进程的内存</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_setup_tm.html">配置 TaskManager 内存</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_setup_jobmanager.html">配置 JobManager 内存</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_tuning.html">调优指南</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_trouble.html">常见问题</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/memory/mem_migration.html">升级指南</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/cli.html">Command-Line Interface</a></li>
<li><a href="#collapse-222" data-toggle="collapse">文件系统<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-222"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/common.html">通用配置</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/s3.html">Amazon S3</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/oss.html">阿里云 OSS</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/azure.html">Azure Blob 存储</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/filesystems/plugins.html">Plugins</a></li>
</ul></div></li>
<li><a href="#collapse-229" data-toggle="collapse">High Availability (HA)<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-229"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/ha/">概览</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/ha/zookeeper_ha.html">ZooKeeper HA Services</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/ha/kubernetes_ha.html">Kubernetes HA Services</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/metric_reporters.html">Metric Reporters</a></li>
<li><a href="#collapse-234" data-toggle="collapse">Security<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-234"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/security/security-ssl.html">SSL 设置</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/security/security-kerberos.html">Kerberos</a></li>
</ul></div></li>
<li><a href="#collapse-238" data-toggle="collapse">REPLs<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-238"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/repls/python_shell.html">Python REPL</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/repls/scala_shell.html">Scala REPL</a></li>
</ul></div></li>
<li><a href="#collapse-242" data-toggle="collapse">Advanced<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-242"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/advanced/external_resources.html">扩展资源</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/advanced/historyserver.html">History Server</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/deployment/advanced/logging.html">日志</a></li>
</ul></div></li>
</ul></div></li>
<li><a href="#collapse-248" data-toggle="collapse"><i class="fa fa-cogs title maindish" aria-hidden="true"></i> Operations<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-248"><ul>
<li><a href="#collapse-249" data-toggle="collapse">状态与容错<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-249"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/state/checkpoints.html">Checkpoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/state/savepoints.html">Savepoints</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/state/state_backends.html">State Backends</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/state/large_state_tuning.html">大状态与 Checkpoint 调优</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/metrics.html">指标</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/rest_api.html">REST API</a></li>
<li><a href="#collapse-257" data-toggle="collapse">Debugging<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-257"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/debugging/debugging_event_time.html">调试窗口与事件时间</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/debugging/debugging_classloading.html">调试类加载</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/debugging/application_profiling.html">应用程序分析</a></li>
</ul></div></li>
<li><a href="#collapse-262" data-toggle="collapse">Monitoring<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-262"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/monitoring/checkpoint_monitoring.html">监控 Checkpoint</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/monitoring/back_pressure.html">监控反压</a></li>
</ul></div></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/upgrading.html">升级应用程序和 Flink 版本</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/ops/production_ready.html">生产就绪情况核对清单</a></li>
</ul></div></li><hr class="section-break"></hr>
<li><a href="#collapse-269" data-toggle="collapse"><i class="fa fa-cogs title dessert" aria-hidden="true"></i> Flink 开发<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-269"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/flinkDev/ide_setup.html">导入 Flink 到 IDE 中</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/flinkDev/building.html">从源码构建 Flink</a></li>
</ul></div></li>
<li><a href="#collapse-273" data-toggle="collapse"><i class="fa fa-book title dessert" aria-hidden="true"></i> 内幕<i class="fa fa-caret-down pull-right" aria-hidden="true" style="padding-top: 4px"></i></a><div class="collapse" id="collapse-273"><ul>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/internals/job_scheduling.html">作业调度</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/internals/task_lifecycle.html">Task 生命周期</a></li>
<li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/internals/filesystems.html">文件系统</a></li>
</ul></div></li>
  <li class="divider"></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/java"><i class="fa fa-external-link title" aria-hidden="true"></i> Javadocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/scala/index.html#org.apache.flink.api.scala.package"><i class="fa fa-external-link title" aria-hidden="true"></i> Scaladocs</a></li>
  <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/api/python"><i class="fa fa-external-link title" aria-hidden="true"></i> Pythondocs</a></li>
  <li><a href="http://flink.apache.org"><i class="fa fa-external-link title" aria-hidden="true"></i> Project Page</a></li>
</ul>

<div class="sidenav-search-box">
  <form class="navbar-form" role="search" action="//ci.apache.org/projects/flink/flink-docs-release-1.12/search-results.html">
    <div class="form-group">
      <input type="text" class="form-control" size="16px" name="q" placeholder="Search">
    </div>
    <button type="submit" class="btn btn-default">Go</button>
  </form>
</div>

<div class="sidenav-versions">
  <div class="dropdown">
    <button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">选择文档版本<span class="caret"></span></button>
    <ul class="dropdown-menu">
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.11">v1.11</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.10">v1.10</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.9">v1.9</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.8">v1.8</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.7">v1.7</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.6">v1.6</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.5">v1.5</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.4">v1.4</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.3">v1.3</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.2">v1.2</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.1">v1.1</a></li>
      <li><a href="http://ci.apache.org/projects/flink/flink-docs-release-1.0">v1.0</a></li>
    </ul>
  </div>
</div>

<div class="sidenav-languages"><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/dev/table/functions/udfs.html">
      <button type="submit" class="btn btn-default">English</button>
    </a>
</div>

        </div>
        <div class="col-lg-9 content" id="contentcol">

          

<ol class="breadcrumb">
  
    <li><i class="fa fa-code title maindish" aria-hidden="true"></i> 应用开发</li>
  
    <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/">Table API & SQL</a></li>
  
    <li><a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/functions/">函数</a></li>
  
    <li class="active">自定义函数</li>
</ol>

<h1>自定义函数</h1>




<p>自定义函数（UDF）是一种扩展开发机制，可以用来在查询语句里调用难以用其他方式表达的频繁使用或自定义的逻辑。</p>

<p>自定义函数可以用 JVM 语言（例如 Java 或 Scala）或 Python 实现，实现者可以在 UDF 中使用任意第三方库，本文聚焦于使用 JVM 语言开发自定义函数。</p>

<ul id="markdown-toc">
  <li><a href="#概述" id="markdown-toc-概述">概述</a></li>
  <li><a href="#开发指南" id="markdown-toc-开发指南">开发指南</a>    <ul>
      <li><a href="#函数类" id="markdown-toc-函数类">函数类</a></li>
      <li><a href="#求值方法" id="markdown-toc-求值方法">求值方法</a></li>
      <li><a href="#类型推导" id="markdown-toc-类型推导">类型推导</a></li>
      <li><a href="#运行时集成" id="markdown-toc-运行时集成">运行时集成</a></li>
    </ul>
  </li>
  <li><a href="#标量函数" id="markdown-toc-标量函数">标量函数</a></li>
  <li><a href="#表值函数" id="markdown-toc-表值函数">表值函数</a></li>
  <li><a href="#聚合函数" id="markdown-toc-聚合函数">聚合函数</a></li>
  <li><a href="#表值聚合函数" id="markdown-toc-表值聚合函数">表值聚合函数</a></li>
</ul>

<h2 id="概述">概述</h2>

<p>当前 Flink 有如下几种函数：</p>

<ul>
  <li><em>标量函数</em> 将标量值转换成一个新标量值；</li>
  <li><em>表值函数</em> 将标量值转换成新的行数据；</li>
  <li><em>聚合函数</em> 将多行数据里的标量值转换成一个新标量值；</li>
  <li><em>表值聚合函数</em> 将多行数据里的标量值转换成新的行数据；</li>
  <li><em>异步表值函数</em> 是异步查询外部数据系统的特殊函数。</li>
</ul>

<p><span class="label label-danger">注意</span> 标量和表值函数已经使用了新的基于<a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">数据类型</a>的类型系统，聚合函数仍然使用基于 <code class="highlighter-rouge">TypeInformation</code> 的旧类型系统。</p>

<p>以下示例展示了如何创建一个基本的标量函数，以及如何在 Table API 和 SQL 里调用这个函数。</p>

<p>函数用于 SQL 查询前要先经过注册；而在用于 Table API 时，函数可以先注册后调用，也可以 <em>内联</em> 后直接使用。</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// 定义函数逻辑</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// 注册函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="nc">SubstringFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT SubstringFunction(myField, 5, 12) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="c1">// define function logic</span>
<span class="k">class</span> <span class="nc">SubstringFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">end</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// 注册函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SubstringFunction</span><span class="o">])</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT SubstringFunction(myField, 5, 12) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>对于交互式会话，还可以在使用或注册函数之前对其进行参数化，这样可以把函数 <em>实例</em> 而不是函数 <em>类</em> 用作临时函数。</p>

<p>为确保函数实例可应用于集群环境，参数必须是可序列化的。</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="c1">// 定义可参数化的函数逻辑</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SubstringFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SubstringFunction</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">endInclusive</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">endInclusive</span> <span class="o">=</span> <span class="n">endInclusive</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">begin</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span> <span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">end</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">));</span>

<span class="c1">// 注册函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="c1">// 定义可参数化的函数逻辑</span>
<span class="k">class</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="k">val</span> <span class="nv">endInclusive</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">begin</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">end</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">substring</span><span class="o">(</span><span class="n">endInclusive</span> <span class="o">?</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">:</span> <span class="kt">end</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">12</span><span class="o">))</span>

<span class="c1">// 注册函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SubstringFunction"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SubstringFunction</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span></code></pre></figure>

  </div>

</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="开发指南">开发指南</h2>

<p><span class="label label-danger">注意</span>在聚合函数使用新的类型系统前，本节仅适用于标量和表值函数。</p>

<p>所有的自定义函数都遵循一些基本的实现原则。</p>

<h3 id="函数类">函数类</h3>

<p>实现类必须继承自合适的基类之一（例如 <code class="highlighter-rouge">org.apache.flink.table.functions.ScalarFunction</code> ）。</p>

<p>该类必须声明为 <code class="highlighter-rouge">public</code> ，而不是 <code class="highlighter-rouge">abstract</code> ，并且可以被全局访问。不允许使用非静态内部类或匿名类。</p>

<p>为了将自定义函数存储在持久化的 catalog 中，该类必须具有默认构造器，且在运行时可实例化。</p>

<h3 id="求值方法">求值方法</h3>

<p>基类提供了一组可以被重写的方法，例如 <code class="highlighter-rouge">open()</code>、 <code class="highlighter-rouge">close()</code> 或 <code class="highlighter-rouge">isDeterministic()</code> 。</p>

<p>但是，除了上述方法之外，作用于每条传入记录的主要逻辑还必须通过专门的 <em>求值方法</em> 来实现。</p>

<p>根据函数的种类，后台生成的运算符会在运行时调用诸如 <code class="highlighter-rouge">eval()</code>、<code class="highlighter-rouge">accumulate()</code> 或 <code class="highlighter-rouge">retract()</code> 之类的求值方法。</p>

<p>这些方法必须声明为 <code class="highlighter-rouge">public</code> ，并带有一组定义明确的参数。</p>

<p>常规的 JVM 方法调用语义是适用的。因此可以：</p>
<ul>
  <li>实现重载的方法，例如 <code class="highlighter-rouge">eval(Integer)</code> 和 <code class="highlighter-rouge">eval(LocalDateTime)</code>；</li>
  <li>使用变长参数，例如 <code class="highlighter-rouge">eval(Integer...)</code>;</li>
  <li>使用对象继承，例如 <code class="highlighter-rouge">eval(Object)</code> 可接受 <code class="highlighter-rouge">LocalDateTime</code> 和 <code class="highlighter-rouge">Integer</code> 作为参数；</li>
  <li>也可组合使用，例如 <code class="highlighter-rouge">eval(Object...)</code> 可接受所有类型的参数。</li>
</ul>

<p>以下代码片段展示了一个重载函数的示例：</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>

<span class="c1">// 有多个重载求值方法的函数</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SumFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">a</span><span class="o">,</span> <span class="nc">String</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Double</span><span class="o">...</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">double</span> <span class="n">value</span> <span class="o">:</span> <span class="n">d</span><span class="o">)</span>
      <span class="n">result</span> <span class="o">+=</span> <span class="n">value</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
<span class="k">import</span> <span class="nn">scala.annotation.varargs</span>

<span class="c1">// 有多个重载求值方法的函数</span>
<span class="k">class</span> <span class="nc">SumFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Integer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">Integer</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="nv">Integer</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">b</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="nd">@varargs</span> <span class="c1">// generate var-args like Java</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">Double*</span><span class="o">)</span><span class="k">:</span> <span class="kt">Integer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">d</span><span class="o">.</span><span class="py">sum</span><span class="o">.</span><span class="py">toInt</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h3 id="类型推导">类型推导</h3>

<p>Table（类似于 SQL 标准）是一种强类型的 API。因此，函数的参数和返回类型都必须映射到<a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">数据类型</a>。</p>

<p>从逻辑角度看，Planner 需要知道数据类型、精度和小数位数；从 JVM 角度来看，Planner 在调用自定义函数时需要知道如何将内部数据结构表示为 JVM 对象。</p>

<p>术语 <em>类型推导</em> 概括了意在验证输入值、派生出参数/返回值数据类型的逻辑。</p>

<p>Flink 自定义函数实现了自动的类型推导提取，通过反射从函数的类及其求值方法中派生数据类型。如果这种隐式的反射提取方法不成功，则可以通过使用 <code class="highlighter-rouge">@DataTypeHint</code> 和 <code class="highlighter-rouge">@FunctionHint</code> 注解相关参数、类或方法来支持提取过程，下面展示了有关如何注解函数的例子。</p>

<p>如果需要更高级的类型推导逻辑，实现者可以在每个自定义函数中显式重写 <code class="highlighter-rouge">getTypeInference()</code> 方法。但是，建议使用注解方式，因为它可使自定义类型推导逻辑保持在受影响位置附近，而在其他位置则保持默认状态。</p>

<h4 id="自动类型推导">自动类型推导</h4>

<p>自动类型推导会检查函数的类和求值方法，派生出函数参数和结果的数据类型， <code class="highlighter-rouge">@DataTypeHint</code> 和 <code class="highlighter-rouge">@FunctionHint</code> 注解支持自动类型推导。</p>

<p>有关可以隐式映射到数据类型的类的完整列表，请参阅<a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html#数据类型注解">数据类型</a>。</p>

<p><strong><code class="highlighter-rouge">@DataTypeHint</code></strong></p>

<p>在许多情况下，需要支持以 <em>内联</em> 方式自动提取出函数参数、返回值的类型。</p>

<p>以下例子展示了如何使用 <code class="highlighter-rouge">@DataTypeHint</code>，详情可参考该注解类的文档。</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="c1">// 有多个重载求值方法的函数</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// no hint required</span>
  <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">long</span> <span class="n">a</span><span class="o">,</span> <span class="kt">long</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 定义 decimal 的精度和小数位</span>
  <span class="kd">public</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"DECIMAL(12, 3)"</span><span class="o">)</span> <span class="nc">BigDecimal</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">double</span> <span class="n">a</span><span class="o">,</span> <span class="kt">double</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">BigDecimal</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// 定义嵌套数据类型</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, t TIMESTAMP(3) WITH LOCAL TIME ZONE&gt;"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">Row</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// 允许任意类型的符入，并输出序列化定制后的值</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"RAW"</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">ByteBuffer</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">MyUtils</span><span class="o">.</span><span class="na">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>
<span class="k">import</span> <span class="nn">scala.annotation.varargs</span>

<span class="c1">// function with overloaded evaluation methods</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// no hint required</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="o">{</span>
    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
  <span class="o">}</span>

  <span class="c1">// 定义 decimal 的精度和小数位</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"DECIMAL(12, 3)"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">double</span> <span class="n">a</span><span class="o">,</span> <span class="n">double</span> <span class="n">b</span><span class="o">)</span><span class="k">:</span> <span class="kt">BigDecimal</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">java</span><span class="o">.</span><span class="py">lang</span><span class="o">.</span><span class="py">BigDecimal</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// 定义嵌套数据类型</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, t TIMESTAMP(3) WITH LOCAL TIME ZONE&gt;"</span><span class="o">)</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Int</span> <span class="n">i</span><span class="o">)</span><span class="k">:</span> <span class="kt">Row</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">java</span><span class="o">.</span><span class="py">lang</span><span class="o">.</span><span class="py">String</span><span class="o">.</span><span class="py">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">),</span> <span class="nv">java</span><span class="o">.</span><span class="py">time</span><span class="o">.</span><span class="py">Instant</span><span class="o">.</span><span class="py">ofEpochSecond</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
  <span class="o">}</span>

  <span class="c1">// 允许任意类型的符入，并输出定制序列化后的值</span>
  <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">value</span> <span class="k">=</span> <span class="s">"RAW"</span><span class="o">,</span> <span class="n">bridgedTo</span> <span class="k">=</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">java.nio.ByteBuffer</span><span class="o">])</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nv">InputGroup</span><span class="o">.</span><span class="py">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span><span class="k">:</span> <span class="kt">java.nio.ByteBuffer</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">MyUtils</span><span class="o">.</span><span class="py">serializeToByteBuffer</span><span class="o">(</span><span class="n">o</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<p><strong><code class="highlighter-rouge">@FunctionHint</code></strong></p>

<p>有时我们希望一种求值方法可以同时处理多种数据类型，有时又要求对重载的多个求值方法仅声明一次通用的结果类型。</p>

<p><code class="highlighter-rouge">@FunctionHint</code> 注解可以提供从入参数据类型到结果数据类型的映射，它可以在整个函数类或求值方法上注解输入、累加器和结果的数据类型。可以在类顶部声明一个或多个注解，也可以为类的所有求值方法分别声明一个或多个注解。所有的 hint 参数都是可选的，如果未定义参数，则使用默认的基于反射的类型提取。在函数类顶部定义的 hint 参数被所有求值方法继承。</p>

<p>以下例子展示了如何使用 <code class="highlighter-rouge">@FunctionHint</code>，详情可参考该注解类的文档。</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="c1">// 为函数类的所有求值方法指定同一个输出类型</span>
<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, i INT&gt;"</span><span class="o">))</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Sum"</span><span class="o">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="c1">// overloading of arguments is still possible</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"Empty args"</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 解耦类型推导与求值方法，类型推导完全取决于 FunctionHint</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">),</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="o">=</span> <span class="o">[],</span>
  <span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"BOOLEAN"</span><span class="o">)</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OverloadedFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="c1">// an implementer just needs to make sure that a method exists</span>
  <span class="c1">// that can be called by the JVM</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">collect</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">collect</span><span class="o">(</span><span class="n">o</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>

<span class="c1">// 为函数类的所有求值方法指定同一个输出类型</span>
<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;s STRING, i INT&gt;"</span><span class="o">))</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"Sum"</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)))</span>
  <span class="o">}</span>

  <span class="c1">// overloading of arguments is still possible</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">()</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="s">"Empty args"</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(-</span><span class="mi">1</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 解耦类型推导与求值方法，类型推导完全取决于 @FunctionHint</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"INT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(</span><span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BIGINT"</span><span class="o">)</span>
<span class="o">)</span>
<span class="nd">@FunctionHint</span><span class="o">(</span>
  <span class="n">input</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">(),</span>
  <span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"BOOLEAN"</span><span class="o">)</span>
<span class="o">)</span>
<span class="k">class</span> <span class="nc">OverloadedFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">AnyRef</span><span class="o">]</span> <span class="o">{</span>

  <span class="c1">// an implementer just needs to make sure that a method exists</span>
  <span class="c1">// that can be called by the JVM</span>
  <span class="nd">@varargs</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef*</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">o</span><span class="o">.</span><span class="py">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="nf">collect</span><span class="o">(</span><span class="nv">Boolean</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="kc">false</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="nf">collect</span><span class="o">(</span><span class="nf">o</span><span class="o">(</span><span class="mi">0</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h4 id="定制类型推导">定制类型推导</h4>

<p>在大多数情况下，<code class="highlighter-rouge">@DataTypeHint</code> 和 <code class="highlighter-rouge">@FunctionHint</code> 足以构建自定义函数，然而通过重写 <code class="highlighter-rouge">getTypeInference()</code> 定制自动类型推导逻辑，实现者可以创建任意像系统内置函数那样有用的函数。</p>

<p>以下用 Java 实现的例子展示了定制类型推导的潜力，它根据字符串参数来确定函数的结果类型。该函数带有两个字符串参数：第一个参数表示要分析的字符串，第二个参数表示目标类型。</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.DataTypes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.catalog.DataTypeFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.types.inference.TypeInference</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LiteralFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">,</span> <span class="nc">String</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">"INT"</span><span class="o">:</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="k">case</span> <span class="s">"DOUBLE"</span><span class="o">:</span>
        <span class="k">return</span> <span class="nc">Double</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="k">case</span> <span class="s">"STRING"</span><span class="o">:</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// 禁用自动的反射式类型推导，使用如下逻辑进行类型推导</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">TypeInference</span> <span class="nf">getTypeInference</span><span class="o">(</span><span class="nc">DataTypeFactory</span> <span class="n">typeFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">TypeInference</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
      <span class="c1">// 指定输入参数的类型，必要时参数会被隐式转换</span>
      <span class="o">.</span><span class="na">typedArguments</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">(),</span> <span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">())</span>
      <span class="c1">// specify a strategy for the result data type of the function</span>
      <span class="o">.</span><span class="na">outputTypeStrategy</span><span class="o">(</span><span class="n">callContext</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentLiteral</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">||</span> <span class="n">callContext</span><span class="o">.</span><span class="na">isArgumentNull</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">callContext</span><span class="o">.</span><span class="na">newValidationError</span><span class="o">(</span><span class="s">"Literal expected for second argument."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 基于字符串值返回数据类型</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">literal</span> <span class="o">=</span> <span class="n">callContext</span><span class="o">.</span><span class="na">getArgumentValue</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="s">"STRING"</span><span class="o">);</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">literal</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="s">"INT"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">INT</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
          <span class="k">case</span> <span class="s">"DOUBLE"</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">DOUBLE</span><span class="o">().</span><span class="na">notNull</span><span class="o">());</span>
          <span class="k">case</span> <span class="s">"STRING"</span><span class="o">:</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">DataTypes</span><span class="o">.</span><span class="na">STRING</span><span class="o">());</span>
        <span class="o">}</span>
      <span class="o">})</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

</div>

<h3 id="运行时集成">运行时集成</h3>
<hr />

<p>有时候自定义函数需要获取一些全局信息，或者在真正被调用之前做一些配置（setup）/清理（clean-up）的工作。自定义函数也提供了 <code class="highlighter-rouge">open()</code> 和 <code class="highlighter-rouge">close()</code> 方法，你可以重写这两个方法做到类似于 DataStream API 中 <code class="highlighter-rouge">RichFunction</code> 的功能。</p>

<p>open() 方法在求值方法被调用之前先调用。close() 方法在求值方法调用完之后被调用。</p>

<p>open() 方法提供了一个 FunctionContext，它包含了一些自定义函数被执行时的上下文信息，比如 metric group、分布式文件缓存，或者是全局的作业参数等。</p>

<p>下面的信息可以通过调用 <code class="highlighter-rouge">FunctionContext</code> 的对应的方法来获得：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">方法</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getMetricGroup()</code></td>
      <td style="text-align: left">执行该函数的 subtask 的 Metric Group。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getCachedFile(name)</code></td>
      <td style="text-align: left">分布式文件缓存的本地临时文件副本。</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="highlighter-rouge">getJobParameter(name, defaultValue)</code></td>
      <td style="text-align: left">跟对应的 key 关联的全局参数值。</td>
    </tr>
  </tbody>
</table>

<p>下面的例子展示了如何在一个标量函数中通过 FunctionContext 来获取一个全局的任务参数：</p>

<div class="codetabs">

  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashCodeFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">factor</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">open</span><span class="o">(</span><span class="nc">FunctionContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取参数 "hashcode_factor"</span>
        <span class="c1">// 如果不存在，则使用默认值 "12"</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"12"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()</span> <span class="o">*</span> <span class="n">factor</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// 设置任务参数</span>
<span class="n">env</span><span class="o">.</span><span class="na">getConfig</span><span class="o">().</span><span class="na">addJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"31"</span><span class="o">);</span>

<span class="c1">// 注册函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">,</span> <span class="nc">HashCodeFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 调用函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT myField, hashCode(myField) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.FunctionContext</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="k">class</span> <span class="nc">HashCodeFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">factor</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">open</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">FunctionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// 获取参数 "hashcode_factor"</span>
    <span class="c1">// 如果不存在，则使用默认值 "12"</span>
    <span class="n">factor</span> <span class="k">=</span> <span class="nv">context</span><span class="o">.</span><span class="py">getJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"12"</span><span class="o">).</span><span class="py">toInt</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">s</span><span class="o">.</span><span class="py">hashCode</span> <span class="o">*</span> <span class="n">factor</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// 设置任务参数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">getConfig</span><span class="o">.</span><span class="py">addJobParameter</span><span class="o">(</span><span class="s">"hashcode_factor"</span><span class="o">,</span> <span class="s">"31"</span><span class="o">)</span>

<span class="c1">// 注册函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashCodeFunction</span><span class="o">])</span>

<span class="c1">// 调用函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT myField, hashCode(myField) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="标量函数">标量函数</h2>

<p>自定义标量函数可以把 0 到多个标量值映射成 1 个标量值，<a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/table/types.html">数据类型</a>里列出的任何数据类型都可作为求值方法的参数和返回值类型。</p>

<p>想要实现自定义标量函数，你需要扩展 <code class="highlighter-rouge">org.apache.flink.table.functions</code> 里面的 <code class="highlighter-rouge">ScalarFunction</code> 并且实现一个或者多个求值方法。标量函数的行为取决于你写的求值方法。求值方法必须是 <code class="highlighter-rouge">public</code> 的，而且名字必须是 <code class="highlighter-rouge">eval</code>。</p>

<p>下面的例子展示了如何实现一个求哈希值的函数并在查询里调用它，详情可参考<a href="#开发指南">开发指南</a>：</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HashFunction</span> <span class="kd">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// 接受任意类型输入，返回 INT 型输出</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="o">=</span> <span class="nc">InputGroup</span><span class="o">.</span><span class="na">ANY</span><span class="o">)</span> <span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">o</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)));</span>

<span class="c1">// 注册函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="nc">HashFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="na">select</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)));</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT HashFunction(myField) FROM MyTable"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.InputGroup</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.ScalarFunction</span>

<span class="k">class</span> <span class="nc">HashFunction</span> <span class="k">extends</span> <span class="nc">ScalarFunction</span> <span class="o">{</span>

  <span class="c1">// 接受任意类型输入，返回 INT 型输出</span>
  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="nd">@DataTypeHint</span><span class="o">(</span><span class="n">inputGroup</span> <span class="k">=</span> <span class="nv">InputGroup</span><span class="o">.</span><span class="py">ANY</span><span class="o">)</span> <span class="n">o</span><span class="k">:</span> <span class="kt">AnyRef</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">{</span>
    <span class="kt">return</span> <span class="kt">o.hashCode</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>

<span class="c1">// 注册函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">HashFunction</span><span class="o">])</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">).</span><span class="py">select</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"HashFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT HashFunction(myField) FROM MyTable"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>如果你打算使用 Python 实现或调用标量函数，详情可参考 <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/udfs/python_udfs.html#scalar-functions">Python 标量函数</a>。</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="表值函数">表值函数</h2>

<p>跟自定义标量函数一样，自定义表值函数的输入参数也可以是 0 到多个标量。但是跟标量函数只能返回一个值不同的是，它可以返回任意多行。返回的每一行可以包含 1 到多列，如果输出行只包含 1 列，会省略结构化信息并生成标量值，这个标量值在运行阶段会隐式地包装进行里。</p>

<p>要定义一个表值函数，你需要扩展 <code class="highlighter-rouge">org.apache.flink.table.functions</code> 下的 <code class="highlighter-rouge">TableFunction</code>，可以通过实现多个名为 <code class="highlighter-rouge">eval</code> 的方法对求值方法进行重载。像其他函数一样，输入和输出类型也可以通过反射自动提取出来。表值函数返回的表的类型取决于 <code class="highlighter-rouge">TableFunction</code> 类的泛型参数 <code class="highlighter-rouge">T</code>，不同于标量函数，表值函数的求值方法本身不包含返回类型，而是通过 <code class="highlighter-rouge">collect(T)</code> 方法来发送要输出的行。</p>

<p>在 Table API 中，表值函数是通过 <code class="highlighter-rouge">.joinLateral(...)</code> 或者 <code class="highlighter-rouge">.leftOuterJoinLateral(...)</code> 来使用的。<code class="highlighter-rouge">joinLateral</code> 算子会把外表（算子左侧的表）的每一行跟跟表值函数返回的所有行（位于算子右侧）进行 （cross）join。<code class="highlighter-rouge">leftOuterJoinLateral</code> 算子也是把外表（算子左侧的表）的每一行跟表值函数返回的所有行（位于算子右侧）进行（cross）join，并且如果表值函数返回 0 行也会保留外表的这一行。</p>

<p>在 SQL 里面用 <code class="highlighter-rouge">JOIN</code> 或者 以 <code class="highlighter-rouge">ON TRUE</code> 为条件的 <code class="highlighter-rouge">LEFT JOIN</code> 来配合 <code class="highlighter-rouge">LATERAL TABLE(&lt;TableFunction&gt;)</code> 的使用。</p>

<p>下面的例子展示了如何实现一个分隔函数并在查询里调用它，详情可参考<a href="#开发指南">开发指南</a>：</p>

<div class="codetabs">

  <div data-lang="Java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.api.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.flink.types.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Expressions</span><span class="o">.*;</span>

<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="o">=</span> <span class="nd">@DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;word STRING, length INT&gt;"</span><span class="o">))</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SplitFunction</span> <span class="kd">extends</span> <span class="nc">TableFunction</span><span class="o">&lt;</span><span class="nc">Row</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eval</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">str</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">" "</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// use collect(...) to emit a row</span>
      <span class="n">collect</span><span class="o">(</span><span class="nc">Row</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nc">TableEnvironment</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">TableEnvironment</span><span class="o">.</span><span class="na">create</span><span class="o">(...);</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>

<span class="c1">// 在 Table API 里重命名函数字段</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)).</span><span class="na">as</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">,</span> <span class="s">"newLength"</span><span class="o">))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"newLength"</span><span class="o">));</span>

<span class="c1">// 注册函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="nc">SplitFunction</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">joinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>
<span class="n">env</span>
  <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">leftOuterJoinLateral</span><span class="o">(</span><span class="n">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">)))</span>
  <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="err">$</span><span class="o">(</span><span class="s">"myField"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"word"</span><span class="o">),</span> <span class="err">$</span><span class="o">(</span><span class="s">"length"</span><span class="o">));</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable, LATERAL TABLE(SplitFunction(myField))"</span><span class="o">);</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE"</span><span class="o">);</span>

<span class="c1">// 在 SQL 里重命名函数字段</span>
<span class="n">env</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, newWord, newLength "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="Scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.DataTypeHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.annotation.FunctionHint</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api._</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableFunction</span>
<span class="k">import</span> <span class="nn">org.apache.flink.types.Row</span>

<span class="nd">@FunctionHint</span><span class="o">(</span><span class="n">output</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DataTypeHint</span><span class="o">(</span><span class="s">"ROW&lt;word STRING, length INT&gt;"</span><span class="o">))</span>
<span class="k">class</span> <span class="nc">SplitFunction</span> <span class="k">extends</span> <span class="nc">TableFunction</span><span class="o">[</span><span class="kt">Row</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// use collect(...) to emit a row</span>
    <span class="nv">str</span><span class="o">.</span><span class="py">split</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="py">foreach</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nf">collect</span><span class="o">(</span><span class="nv">Row</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="nv">Int</span><span class="o">.</span><span class="py">box</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">length</span><span class="o">))))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="nv">env</span> <span class="k">=</span> <span class="nv">TableEnvironment</span><span class="o">.</span><span class="py">create</span><span class="o">(...)</span>

<span class="c1">// 在 Table API 里不经注册直接“内联”调用函数</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">joinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>

<span class="c1">// 在 Table API 里重命名函数字段</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">],</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">).</span><span class="py">as</span><span class="o">(</span><span class="s">"newWord"</span><span class="o">,</span> <span class="s">"newLength"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"newWord"</span><span class="o">,</span> <span class="n">$</span><span class="s">"newLength"</span><span class="o">)</span>

<span class="c1">// 注册函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">createTemporarySystemFunction</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">classOf</span><span class="o">[</span><span class="kt">SplitFunction</span><span class="o">])</span>

<span class="c1">// 在 Table API 里调用注册好的函数</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">joinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>
<span class="n">env</span>
  <span class="o">.</span><span class="py">from</span><span class="o">(</span><span class="s">"MyTable"</span><span class="o">)</span>
  <span class="o">.</span><span class="py">leftOuterJoinLateral</span><span class="o">(</span><span class="nf">call</span><span class="o">(</span><span class="s">"SplitFunction"</span><span class="o">,</span> <span class="n">$</span><span class="s">"myField"</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="n">$</span><span class="s">"myField"</span><span class="o">,</span> <span class="n">$</span><span class="s">"word"</span><span class="o">,</span> <span class="n">$</span><span class="s">"length"</span><span class="o">)</span>

<span class="c1">// 在 SQL 里调用注册好的函数</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable, LATERAL TABLE(SplitFunction(myField))"</span><span class="o">);</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, word, length "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) ON TRUE"</span><span class="o">)</span>

<span class="c1">// 在 SQL 里重命名函数字段</span>
<span class="nv">env</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span>
  <span class="s">"SELECT myField, newWord, newLength "</span> <span class="o">+</span>
  <span class="s">"FROM MyTable "</span> <span class="o">+</span>
  <span class="s">"LEFT JOIN LATERAL TABLE(SplitFunction(myField)) AS T(newWord, newLength) ON TRUE"</span><span class="o">)</span></code></pre></figure>

  </div>

</div>

<p>如果你打算使用 Scala，不要把表值函数声明为 Scala <code class="highlighter-rouge">object</code>，Scala <code class="highlighter-rouge">object</code> 是单例对象，将导致并发问题。</p>

<p>如果你打算使用 Python 实现或调用表值函数，详情可参考 <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/udfs/python_udfs.html#table-functions">Python 表值函数</a>。</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="聚合函数">聚合函数</h2>

<p>自定义聚合函数（UDAGG）是把一个表（一行或者多行，每行可以有一列或者多列）聚合成一个标量值。</p>

<center>
<img alt="UDAGG mechanism" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/fig/udagg-mechanism.png" width="80%" />
</center>

<p>上面的图片展示了一个聚合的例子。假设你有一个关于饮料的表。表里面有三个字段，分别是 <code class="highlighter-rouge">id</code>、<code class="highlighter-rouge">name</code>、<code class="highlighter-rouge">price</code>，表里有 5 行数据。假设你需要找到所有饮料里最贵的饮料的价格，即执行一个 <code class="highlighter-rouge">max()</code> 聚合。你需要遍历所有 5 行数据，而结果就只有一个数值。</p>

<p>自定义聚合函数是通过扩展 <code class="highlighter-rouge">AggregateFunction</code> 来实现的。<code class="highlighter-rouge">AggregateFunction</code> 的工作过程如下。首先，它需要一个 <code class="highlighter-rouge">accumulator</code>，它是一个数据结构，存储了聚合的中间结果。通过调用 <code class="highlighter-rouge">AggregateFunction</code> 的 <code class="highlighter-rouge">createAccumulator()</code> 方法创建一个空的 accumulator。接下来，对于每一行数据，会调用 <code class="highlighter-rouge">accumulate()</code> 方法来更新 accumulator。当所有的数据都处理完了之后，通过调用 <code class="highlighter-rouge">getValue</code> 方法来计算和返回最终的结果。</p>

<p><strong>下面几个方法是每个 <code class="highlighter-rouge">AggregateFunction</code> 必须要实现的：</strong></p>

<ul>
  <li><code class="highlighter-rouge">createAccumulator()</code></li>
  <li><code class="highlighter-rouge">accumulate()</code></li>
  <li><code class="highlighter-rouge">getValue()</code></li>
</ul>

<p>Flink 的类型推导在遇到复杂类型的时候可能会推导出错误的结果，比如那些非基本类型和普通的 POJO 类型的复杂类型。所以跟 <code class="highlighter-rouge">ScalarFunction</code> 和 <code class="highlighter-rouge">TableFunction</code> 一样，<code class="highlighter-rouge">AggregateFunction</code> 也提供了 <code class="highlighter-rouge">AggregateFunction#getResultType()</code> 和 <code class="highlighter-rouge">AggregateFunction#getAccumulatorType()</code> 来分别指定返回值类型和 accumulator 的类型，两个函数的返回值类型也都是 <code class="highlighter-rouge">TypeInformation</code>。</p>

<p>除了上面的方法，还有几个方法可以选择实现。这些方法有些可以让查询更加高效，而有些是在某些特定场景下必须要实现的。例如，如果聚合函数用在会话窗口（当两个会话窗口合并的时候需要 merge 他们的 accumulator）的话，<code class="highlighter-rouge">merge()</code> 方法就是必须要实现的。</p>

<p><strong><code class="highlighter-rouge">AggregateFunction</code> 的以下方法在某些场景下是必须实现的：</strong></p>

<ul>
  <li><code class="highlighter-rouge">retract()</code> 在 bounded <code class="highlighter-rouge">OVER</code> 窗口中是必须实现的。</li>
  <li><code class="highlighter-rouge">merge()</code> 在许多批式聚合和会话以及滚动窗口聚合中是必须实现的。除此之外，这个方法对于优化也很多帮助。例如，两阶段聚合优化就需要所有的 <code class="highlighter-rouge">AggregateFunction</code> 都实现 <code class="highlighter-rouge">merge</code> 方法。</li>
  <li><code class="highlighter-rouge">resetAccumulator()</code> 在许多批式聚合中是必须实现的。</li>
</ul>

<p><code class="highlighter-rouge">AggregateFunction</code> 的所有方法都必须是 <code class="highlighter-rouge">public</code> 的，不能是 <code class="highlighter-rouge">static</code> 的，而且名字必须跟上面写的一样。<code class="highlighter-rouge">createAccumulator</code>、<code class="highlighter-rouge">getValue</code>、<code class="highlighter-rouge">getResultType</code> 以及 <code class="highlighter-rouge">getAccumulatorType</code> 这几个函数是在抽象类 <code class="highlighter-rouge">AggregateFunction</code> 中定义的，而其他函数都是约定的方法。如果要定义一个聚合函数，你需要扩展 <code class="highlighter-rouge">org.apache.flink.table.functions.AggregateFunction</code>，并且实现一个（或者多个）<code class="highlighter-rouge">accumulate</code> 方法。<code class="highlighter-rouge">accumulate</code> 方法可以重载，每个方法的参数类型不同，并且支持变长参数。</p>

<p><code class="highlighter-rouge">AggregateFunction</code> 的所有方法的详细文档如下。</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
  * Base class for user-defined aggregates and table aggregates.
  *
  * @param &lt;T&gt;   the type of the aggregation result.
  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>

  <span class="cm">/**
    * Creates and init the Accumulator for this (table)aggregate function.
    *
    * @return the accumulator with the initial value
    */</span>
  <span class="kd">public</span> <span class="no">ACC</span> <span class="nf">createAccumulator</span><span class="o">();</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's result.
    *
    * @return The TypeInformation of the (table)aggregate function's result or null if the result
    *         type should be automatically inferred.
    */</span>
  <span class="kd">public</span> <span class="nc">TypeInformation</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">getResultType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's accumulator.
    *
    * @return The TypeInformation of the (table)aggregate function's accumulator or null if the
    *         accumulator type should be automatically inferred.
    */</span>
  <span class="kd">public</span> <span class="nc">TypeInformation</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">getAccumulatorType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span>

<span class="cm">/**
  * Base class for aggregation functions.
  *
  * @param &lt;T&gt;   the type of the aggregation result
  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  *             AggregateFunction represents its state using accumulator, thereby the state of the
  *             AggregateFunction must be put into the accumulator.
  */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="cm">/** Processes the input values and update the provided accumulator instance. The method
    * accumulate can be overloaded with different custom types and arguments. An AggregateFunction
    * requires at least one accumulate() method.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Retracts the input values from the accumulator instance. The current design assumes the
    * inputs are the values that have been previously accumulated. The method retract can be
    * overloaded with different custom types and arguments. This function must be implemented for
    * datastream bounded over aggregate.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Merges a group of accumulator instances into one accumulator instance. This function must be
    * implemented for datastream session window grouping aggregate and dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
    *                     be noted that the accumulator may contain the previous aggregated
    *                     results. Therefore user should not replace or clean this instance in the
    *                     custom merge method.
    * @param its          an {@link java.lang.Iterable} pointed to a group of accumulators that will be
    *                     merged.
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">its</span><span class="o">);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized.
    * The returned value could be either an early and incomplete result
    * (periodically emitted as data arrive) or the final result of the
    * aggregation.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @return the aggregation result
    */</span>
  <span class="kd">public</span> <span class="no">T</span> <span class="nf">getValue</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">);</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Resets the accumulator for this [[AggregateFunction]]. This function must be implemented for
    * dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which needs to be reset
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Returns true if this AggregateFunction can only be applied in an OVER window.
    *
    * @return true if the AggregateFunction requires an OVER window, false otherwise.
    */</span>
  <span class="kd">public</span> <span class="nc">Boolean</span> <span class="n">requiresOver</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/**
  * Base class for user-defined aggregates and table aggregates.
  *
  * @tparam T   the type of the aggregation result.
  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  */</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>

  <span class="cm">/**
    * Creates and init the Accumulator for this (table)aggregate function.
    *
    * @return the accumulator with the initial value
    */</span>
  <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">ACC</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's result.
    *
    * @return The TypeInformation of the (table)aggregate function's result or null if the result
    *         type should be automatically inferred.
    */</span>
  <span class="k">def</span> <span class="nf">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's accumulator.
    *
    * @return The TypeInformation of the (table)aggregate function's accumulator or null if the
    *         accumulator type should be automatically inferred.
    */</span>
  <span class="k">def</span> <span class="nf">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">ACC</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span>

<span class="cm">/**
  * Base class for aggregation functions.
  *
  * @tparam T   the type of the aggregation result
  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  *             AggregateFunction represents its state using accumulator, thereby the state of the
  *             AggregateFunction must be put into the accumulator.
  */</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="o">{</span>

  <span class="cm">/**
    * Processes the input values and update the provided accumulator instance. The method
    * accumulate can be overloaded with different custom types and arguments. An AggregateFunction
    * requires at least one accumulate() method.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Retracts the input values from the accumulator instance. The current design assumes the
    * inputs are the values that have been previously accumulated. The method retract can be
    * overloaded with different custom types and arguments. This function must be implemented for
    * datastream bounded over aggregate.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Merges a group of accumulator instances into one accumulator instance. This function must be
    * implemented for datastream session window grouping aggregate and dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
    *                     be noted that the accumulator may contain the previous aggregated
    *                     results. Therefore user should not replace or clean this instance in the
    *                     custom merge method.
    * @param its          an [[java.lang.Iterable]] pointed to a group of accumulators that will be
    *                     merged.
    */</span>
  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized.
    * The returned value could be either an early and incomplete result
    * (periodically emitted as data arrive) or the final result of the
    * aggregation.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @return the aggregation result
    */</span>
  <span class="k">def</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Resets the accumulator for this [[AggregateFunction]]. This function must be implemented for
    * dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which needs to be reset
    */</span>
  <span class="k">def</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Returns true if this AggregateFunction can only be applied in an OVER window.
    *
    * @return true if the AggregateFunction requires an OVER window, false otherwise.
    */</span>
  <span class="k">def</span> <span class="nf">requiresOver</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>下面的例子展示了如何：</p>

<ul>
  <li>定义一个聚合函数来计算某一列的加权平均，</li>
  <li>在 <code class="highlighter-rouge">TableEnvironment</code> 中注册函数，</li>
  <li>在查询中使用函数。</li>
</ul>

<p>为了计算加权平均值，accumulator 需要存储加权总和以及数据的条数。在我们的例子里，我们定义了一个类 <code class="highlighter-rouge">WeightedAvgAccum</code> 来作为 accumulator。Flink 的 checkpoint 机制会自动保存 accumulator，在失败时进行恢复，以此来保证精确一次的语义。</p>

<p>我们的 <code class="highlighter-rouge">WeightedAvg</code>（聚合函数）的 <code class="highlighter-rouge">accumulate</code> 方法有三个输入参数。第一个是 <code class="highlighter-rouge">WeightedAvgAccum</code> accumulator，另外两个是用户自定义的输入：输入的值 <code class="highlighter-rouge">ivalue</code> 和 输入的权重 <code class="highlighter-rouge">iweight</code>。尽管 <code class="highlighter-rouge">retract()</code>、<code class="highlighter-rouge">merge()</code>、<code class="highlighter-rouge">resetAccumulator()</code> 这几个方法在大多数聚合类型中都不是必须实现的，我们也在样例中提供了他们的实现。请注意我们在 Scala 样例中也是用的是 Java 的基础类型，并且定义了 <code class="highlighter-rouge">getResultType()</code> 和 <code class="highlighter-rouge">getAccumulatorType()</code>，因为 Flink 的类型推导对于 Scala 的类型推导做的不是很好。</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * Accumulator for WeightedAvg.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvgAccum</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Weighted Average user-defined aggregate function.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">WeightedAvg</span> <span class="kd">extends</span> <span class="nc">AggregateFunction</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">WeightedAvgAccum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">WeightedAvgAccum</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getValue</span><span class="o">(</span><span class="nc">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">/</span> <span class="n">acc</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="kt">long</span> <span class="n">iValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">iWeight</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="nc">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="kt">long</span> <span class="n">iValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">iWeight</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">-=</span> <span class="n">iWeight</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="nc">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="n">it</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">WeightedAvgAccum</span><span class="o">&gt;</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iter</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">WeightedAvgAccum</span> <span class="n">a</span> <span class="o">=</span> <span class="n">iter</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">count</span><span class="o">;</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">+=</span> <span class="n">a</span><span class="o">.</span><span class="na">sum</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="nc">WeightedAvgAccum</span> <span class="n">acc</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">sum</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 注册函数</span>
<span class="nc">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">"wAvg"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WeightedAvg</span><span class="o">());</span>

<span class="c1">// 使用函数</span>
<span class="n">tEnv</span><span class="o">.</span><span class="na">sqlQuery</span><span class="o">(</span><span class="s">"SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Long</span> <span class="k">=&gt;</span> <span class="nc">JLong</span><span class="o">,</span> <span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.flink.api.java.tuple.</span><span class="o">{</span><span class="nc">Tuple1</span> <span class="k">=&gt;</span> <span class="nc">JTuple1</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.flink.api.java.typeutils.TupleTypeInfo</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.AggregateFunction</span>

<span class="cm">/**
 * Accumulator for WeightedAvg.
 */</span>
<span class="k">class</span> <span class="nc">WeightedAvgAccum</span> <span class="k">extends</span> <span class="nc">JTuple1</span><span class="o">[</span><span class="kt">JLong</span>, <span class="kt">JInteger</span><span class="o">]</span> <span class="o">{</span>
  <span class="n">sum</span> <span class="k">=</span> <span class="mi">0L</span>
  <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span>
<span class="o">}</span>

<span class="cm">/**
 * Weighted Average user-defined aggregate function.
 */</span>
<span class="k">class</span> <span class="nc">WeightedAvg</span> <span class="k">extends</span> <span class="nc">AggregateFunction</span><span class="o">[</span><span class="kt">JLong</span>, <span class="kt">CountAccumulator</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">WeightedAvgAccum</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">)</span><span class="k">:</span> <span class="kt">JLong</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kc">null</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">/</span> <span class="nv">acc</span><span class="o">.</span><span class="py">count</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">JLong</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">JInteger</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">+=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">+=</span> <span class="n">iWeight</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">iValue</span><span class="k">:</span> <span class="kt">JLong</span><span class="o">,</span> <span class="n">iWeight</span><span class="k">:</span> <span class="kt">JInteger</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">-=</span> <span class="n">iValue</span> <span class="o">*</span> <span class="n">iWeight</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">-=</span> <span class="n">iWeight</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">,</span> <span class="n">it</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">iter</span> <span class="k">=</span> <span class="nv">it</span><span class="o">.</span><span class="py">iterator</span><span class="o">()</span>
    <span class="nf">while</span> <span class="o">(</span><span class="nv">iter</span><span class="o">.</span><span class="py">hasNext</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">a</span> <span class="k">=</span> <span class="nv">iter</span><span class="o">.</span><span class="py">next</span><span class="o">()</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="o">+=</span> <span class="nv">a</span><span class="o">.</span><span class="py">count</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="o">+=</span> <span class="nv">a</span><span class="o">.</span><span class="py">sum</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">resetAccumulator</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">WeightedAvgAccum</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">count</span> <span class="k">=</span> <span class="mi">0</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">sum</span> <span class="k">=</span> <span class="mi">0L</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nc">TupleTypeInfo</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">WeightedAvgAccum</span><span class="o">],</span> <span class="nv">Types</span><span class="o">.</span><span class="py">LONG</span><span class="o">,</span> <span class="nv">Types</span><span class="o">.</span><span class="py">INT</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">JLong</span><span class="o">]</span> <span class="k">=</span> <span class="nv">Types</span><span class="o">.</span><span class="py">LONG</span>
<span class="o">}</span>

<span class="c1">// 注册函数</span>
<span class="k">val</span> <span class="nv">tEnv</span><span class="k">:</span> <span class="kt">StreamTableEnvironment</span> <span class="o">=</span> <span class="o">???</span>
<span class="nv">tEnv</span><span class="o">.</span><span class="py">registerFunction</span><span class="o">(</span><span class="s">"wAvg"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">WeightedAvg</span><span class="o">())</span>

<span class="c1">// 使用函数</span>
<span class="nv">tEnv</span><span class="o">.</span><span class="py">sqlQuery</span><span class="o">(</span><span class="s">"SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user"</span><span class="o">)</span></code></pre></figure>

  </div>

  <div data-lang="python">

    <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="s">'''
Java code:

/**
 * Accumulator for WeightedAvg.
 */
public static class WeightedAvgAccum {
    public long sum = 0;
    public int count = 0;
}

// The java class must have a public no-argument constructor and can be founded in current java classloader.
// Java 类必须有一个 public 的无参构造函数，并且可以在当前类加载器中加载到。

/**
 * Weighted Average user-defined aggregate function.
 */
public static class WeightedAvg extends AggregateFunction&lt;Long, WeightedAvgAccum&gt; {

    @Override
    public WeightedAvgAccum createAccumulator() {
        return new WeightedAvgAccum();
    }

    @Override
    public Long getValue(WeightedAvgAccum acc) {
        if (acc.count == 0) {
            return null;
        } else {
            return acc.sum / acc.count;
        }
    }

    public void accumulate(WeightedAvgAccum acc, long iValue, int iWeight) {
        acc.sum += iValue * iWeight;
        acc.count += iWeight;
    }

    public void retract(WeightedAvgAccum acc, long iValue, int iWeight) {
        acc.sum -= iValue * iWeight;
        acc.count -= iWeight;
    }

    public void merge(WeightedAvgAccum acc, Iterable&lt;WeightedAvgAccum&gt; it) {
        Iterator&lt;WeightedAvgAccum&gt; iter = it.iterator();
        while (iter.hasNext()) {
            WeightedAvgAccum a = iter.next();
            acc.count += a.count;
            acc.sum += a.sum;
        }
    }

    public void resetAccumulator(WeightedAvgAccum acc) {
        acc.count = 0;
        acc.sum = 0L;
    }
}
'''</span>

<span class="c1"># 注册函数
</span><span class="n">t_env</span> <span class="o">=</span> <span class="p">...</span>  <span class="c1"># type: StreamTableEnvironment
</span><span class="n">t_env</span><span class="p">.</span><span class="n">register_java_function</span><span class="p">(</span><span class="s">"wAvg"</span><span class="p">,</span> <span class="s">"my.java.function.WeightedAvg"</span><span class="p">)</span>

<span class="c1"># 使用函数
</span><span class="n">t_env</span><span class="p">.</span><span class="n">sql_query</span><span class="p">(</span><span class="s">"SELECT user, wAvg(points, level) AS avgPoints FROM userScores GROUP BY user"</span><span class="p">)</span></code></pre></figure>

  </div>
</div>

<p>如果你打算使用 Python 实现或调用聚合函数，详情可参考 <a href="//ci.apache.org/projects/flink/flink-docs-release-1.12/zh/dev/python/table-api-users-guide/udfs/python_udfs.html#aggregate-functions">Python 聚合函数</a>。</p>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>

<h2 id="表值聚合函数">表值聚合函数</h2>

<p>自定义表值聚合函数（UDTAGG）可以把一个表（一行或者多行，每行有一列或者多列）聚合成另一张表，结果中可以有多行多列。</p>

<center>
<img alt="UDAGG mechanism" src="//ci.apache.org/projects/flink/flink-docs-release-1.12/fig/udtagg-mechanism.png" width="80%" />
</center>

<p>上图展示了一个表值聚合函数的例子。假设你有一个饮料的表，这个表有 3 列，分别是 <code class="highlighter-rouge">id</code>、<code class="highlighter-rouge">name</code> 和 <code class="highlighter-rouge">price</code>，一共有 5 行。假设你需要找到价格最高的两个饮料，类似于 <code class="highlighter-rouge">top2()</code> 表值聚合函数。你需要遍历所有 5 行数据，结果是有 2 行数据的一个表。</p>

<p>用户自定义表值聚合函数是通过扩展 <code class="highlighter-rouge">TableAggregateFunction</code> 类来实现的。一个 <code class="highlighter-rouge">TableAggregateFunction</code> 的工作过程如下。首先，它需要一个 <code class="highlighter-rouge">accumulator</code>，这个 <code class="highlighter-rouge">accumulator</code> 负责存储聚合的中间结果。 通过调用 <code class="highlighter-rouge">TableAggregateFunction</code> 的 <code class="highlighter-rouge">createAccumulator</code> 方法来构造一个空的 accumulator。接下来，对于每一行数据，会调用 <code class="highlighter-rouge">accumulate</code> 方法来更新 accumulator。当所有数据都处理完之后，调用 <code class="highlighter-rouge">emitValue</code> 方法来计算和返回最终的结果。</p>

<p><strong>下面几个 <code class="highlighter-rouge">TableAggregateFunction</code> 的方法是必须要实现的：</strong></p>

<ul>
  <li><code class="highlighter-rouge">createAccumulator()</code></li>
  <li><code class="highlighter-rouge">accumulate()</code></li>
</ul>

<p>Flink 的类型推导在遇到复杂类型的时候可能会推导出错误的结果，比如那些非基本类型和普通的 POJO 类型的复杂类型。所以类似于 <code class="highlighter-rouge">ScalarFunction</code> 和 <code class="highlighter-rouge">TableFunction</code>，<code class="highlighter-rouge">TableAggregateFunction</code> 也提供了 <code class="highlighter-rouge">TableAggregateFunction#getResultType()</code> 和 <code class="highlighter-rouge">TableAggregateFunction#getAccumulatorType()</code> 方法来指定返回值类型和 accumulator 的类型，这两个方法都需要返回 <code class="highlighter-rouge">TypeInformation</code>。</p>

<p>除了上面的方法，还有几个其他的方法可以选择性的实现。有些方法可以让查询更加高效，而有些方法对于某些特定场景是必须要实现的。比如，在会话窗口（当两个会话窗口合并时会合并两个 accumulator）中使用聚合函数时，必须要实现<code class="highlighter-rouge">merge()</code> 方法。</p>

<p><strong>下面几个 <code class="highlighter-rouge">TableAggregateFunction</code> 的方法在某些特定场景下是必须要实现的：</strong></p>

<ul>
  <li><code class="highlighter-rouge">retract()</code> 在 bounded <code class="highlighter-rouge">OVER</code> 窗口中的聚合函数必须要实现。</li>
  <li><code class="highlighter-rouge">merge()</code> 在许多批式聚合和以及流式会话和滑动窗口聚合中是必须要实现的。</li>
  <li><code class="highlighter-rouge">resetAccumulator()</code> 在许多批式聚合中是必须要实现的。</li>
  <li><code class="highlighter-rouge">emitValue()</code> 在批式聚合以及窗口聚合中是必须要实现的。</li>
</ul>

<p><strong>下面的 <code class="highlighter-rouge">TableAggregateFunction</code> 的方法可以提升流式任务的效率：</strong></p>

<ul>
  <li><code class="highlighter-rouge">emitUpdateWithRetract()</code> 在 retract 模式下，该方法负责发送被更新的值。</li>
</ul>

<p><code class="highlighter-rouge">emitValue</code> 方法会发送所有 accumulator 给出的结果。拿 TopN 来说，<code class="highlighter-rouge">emitValue</code> 每次都会发送所有的最大的 n 个值。这在流式任务中可能会有一些性能问题。为了提升性能，用户可以实现 <code class="highlighter-rouge">emitUpdateWithRetract</code> 方法。这个方法在 retract 模式下会增量的输出结果，比如有数据更新了，我们必须要撤回老的数据，然后再发送新的数据。如果定义了 <code class="highlighter-rouge">emitUpdateWithRetract</code> 方法，那它会优先于 <code class="highlighter-rouge">emitValue</code> 方法被使用，因为一般认为 <code class="highlighter-rouge">emitUpdateWithRetract</code> 会更加高效，因为它的输出是增量的。</p>

<p><code class="highlighter-rouge">TableAggregateFunction</code> 的所有方法都必须是 <code class="highlighter-rouge">public</code> 的、非 <code class="highlighter-rouge">static</code> 的，而且名字必须跟上面提到的一样。<code class="highlighter-rouge">createAccumulator</code>、<code class="highlighter-rouge">getResultType</code> 和 <code class="highlighter-rouge">getAccumulatorType</code> 这三个方法是在抽象父类 <code class="highlighter-rouge">TableAggregateFunction</code> 中定义的，而其他的方法都是约定的方法。要实现一个表值聚合函数，你必须扩展 <code class="highlighter-rouge">org.apache.flink.table.functions.TableAggregateFunction</code>，并且实现一个（或者多个）<code class="highlighter-rouge">accumulate</code> 方法。<code class="highlighter-rouge">accumulate</code> 方法可以有多个重载的方法，也可以支持变长参数。</p>

<p><code class="highlighter-rouge">TableAggregateFunction</code> 的所有方法的详细文档如下。</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
  * Base class for user-defined aggregates and table aggregates.
  *
  * @param &lt;T&gt;   the type of the aggregation result.
  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>

  <span class="cm">/**
    * Creates and init the Accumulator for this (table)aggregate function.
    *
    * @return the accumulator with the initial value
    */</span>
  <span class="kd">public</span> <span class="no">ACC</span> <span class="nf">createAccumulator</span><span class="o">();</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's result.
    *
    * @return The TypeInformation of the (table)aggregate function's result or null if the result
    *         type should be automatically inferred.
    */</span>
  <span class="kd">public</span> <span class="nc">TypeInformation</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">getResultType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's accumulator.
    *
    * @return The TypeInformation of the (table)aggregate function's accumulator or null if the
    *         accumulator type should be automatically inferred.
    */</span>
  <span class="kd">public</span> <span class="nc">TypeInformation</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">getAccumulatorType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span>

<span class="cm">/**
  * Base class for table aggregation functions.
  *
  * @param &lt;T&gt;   the type of the aggregation result
  * @param &lt;ACC&gt; the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute a table aggregation result.
  *             TableAggregateFunction represents its state using accumulator, thereby the state of
  *             the TableAggregateFunction must be put into the accumulator.
  */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">&lt;</span><span class="no">T</span><span class="o">,</span> <span class="no">ACC</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="cm">/** Processes the input values and update the provided accumulator instance. The method
    * accumulate can be overloaded with different custom types and arguments. A TableAggregateFunction
    * requires at least one accumulate() method.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Retracts the input values from the accumulator instance. The current design assumes the
    * inputs are the values that have been previously accumulated. The method retract can be
    * overloaded with different custom types and arguments. This function must be implemented for
    * datastream bounded over aggregate.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="o">[</span><span class="n">user</span> <span class="n">defined</span> <span class="n">inputs</span><span class="o">]);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Merges a group of accumulator instances into one accumulator instance. This function must be
    * implemented for datastream session window grouping aggregate and dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
    *                     be noted that the accumulator may contain the previous aggregated
    *                     results. Therefore user should not replace or clean this instance in the
    *                     custom merge method.
    * @param its          an {@link java.lang.Iterable} pointed to a group of accumulators that will be
    *                     merged.
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="no">ACC</span><span class="o">&gt;</span> <span class="n">its</span><span class="o">);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized. The returned value
    * could be either an early and incomplete result  (periodically emitted as data arrive) or
    * the final result of the  aggregation.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @param out         the collector used to output data
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized. The returned value
    * could be either an early and incomplete result (periodically emitted as data arrive) or
    * the final result of the aggregation.
    *
    * Different from emitValue, emitUpdateWithRetract is used to emit values that have been updated.
    * This method outputs data incrementally in retract mode, i.e., once there is an update, we
    * have to retract old records before sending new updated ones. The emitUpdateWithRetract
    * method will be used in preference to the emitValue method if both methods are defined in the
    * table aggregate function, because the method is treated to be more efficient than emitValue
    * as it can outputvalues incrementally.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @param out         the retractable collector used to output data. Use collect method
    *                    to output(add) records and use retract method to retract(delete)
    *                    records.
    */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="no">ACC</span> <span class="n">accumulator</span><span class="o">,</span> <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">);</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Collects a record and forwards it. The collector can output retract messages with the retract
    * method. Note: only use it in {@code emitRetractValueIncrementally}.
    */</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

      <span class="cm">/**
        * Retract a record.
        *
        * @param record The record to retract.
        */</span>
      <span class="kt">void</span> <span class="nf">retract</span><span class="o">(</span><span class="no">T</span> <span class="n">record</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="cm">/**
  * Base class for user-defined aggregates and table aggregates.
  *
  * @tparam T   the type of the aggregation result.
  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  */</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedFunction</span> <span class="o">{</span>

  <span class="cm">/**
    * Creates and init the Accumulator for this (table)aggregate function.
    *
    * @return the accumulator with the initial value
    */</span>
  <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">ACC</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's result.
    *
    * @return The TypeInformation of the (table)aggregate function's result or null if the result
    *         type should be automatically inferred.
    */</span>
  <span class="k">def</span> <span class="nf">getResultType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED</span>

  <span class="cm">/**
    * Returns the TypeInformation of the (table)aggregate function's accumulator.
    *
    * @return The TypeInformation of the (table)aggregate function's accumulator or null if the
    *         accumulator type should be automatically inferred.
    */</span>
  <span class="k">def</span> <span class="nf">getAccumulatorType</span><span class="k">:</span> <span class="kt">TypeInformation</span><span class="o">[</span><span class="kt">ACC</span><span class="o">]</span> <span class="k">=</span> <span class="kc">null</span> <span class="c1">// PRE-DEFINED</span>
<span class="o">}</span>

<span class="cm">/**
  * Base class for table aggregation functions.
  *
  * @tparam T   the type of the aggregation result
  * @tparam ACC the type of the aggregation accumulator. The accumulator is used to keep the
  *             aggregated values which are needed to compute an aggregation result.
  *             TableAggregateFunction represents its state using accumulator, thereby the state of
  *             the TableAggregateFunction must be put into the accumulator.
  */</span>
<span class="k">abstract</span> <span class="k">class</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">UserDefinedAggregateFunction</span><span class="o">[</span><span class="kt">T</span>, <span class="kt">ACC</span><span class="o">]</span> <span class="o">{</span>

  <span class="cm">/**
    * Processes the input values and update the provided accumulator instance. The method
    * accumulate can be overloaded with different custom types and arguments. A TableAggregateFunction
    * requires at least one accumulate() method.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// MANDATORY</span>

  <span class="cm">/**
    * Retracts the input values from the accumulator instance. The current design assumes the
    * inputs are the values that have been previously accumulated. The method retract can be
    * overloaded with different custom types and arguments. This function must be implemented for
    * datastream bounded over aggregate.
    *
    * @param accumulator           the accumulator which contains the current aggregated results
    * @param [user defined inputs] the input value (usually obtained from a new arrived data).
    */</span>
  <span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="o">[</span><span class="kt">user</span> <span class="kt">defined</span> <span class="kt">inputs</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Merges a group of accumulator instances into one accumulator instance. This function must be
    * implemented for datastream session window grouping aggregate and dataset grouping aggregate.
    *
    * @param accumulator  the accumulator which will keep the merged aggregate results. It should
    *                     be noted that the accumulator may contain the previous aggregated
    *                     results. Therefore user should not replace or clean this instance in the
    *                     custom merge method.
    * @param its          an [[java.lang.Iterable]] pointed to a group of accumulators that will be
    *                     merged.
    */</span>
  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">java.lang.Iterable</span><span class="o">[</span><span class="kt">ACC</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized. The returned value
    * could be either an early and incomplete result  (periodically emitted as data arrive) or
    * the final result of the  aggregation.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @param out         the collector used to output data
    */</span>
  <span class="k">def</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Called every time when an aggregation result should be materialized. The returned value
    * could be either an early and incomplete result (periodically emitted as data arrive) or
    * the final result of the aggregation.
    *
    * Different from emitValue, emitUpdateWithRetract is used to emit values that have been updated.
    * This method outputs data incrementally in retract mode, i.e., once there is an update, we
    * have to retract old records before sending new updated ones. The emitUpdateWithRetract
    * method will be used in preference to the emitValue method if both methods are defined in the
    * table aggregate function, because the method is treated to be more efficient than emitValue
    * as it can outputvalues incrementally.
    *
    * @param accumulator the accumulator which contains the current
    *                    aggregated results
    * @param out         the retractable collector used to output data. Use collect method
    *                    to output(add) records and use retract method to retract(delete)
    *                    records.
    */</span>
  <span class="k">def</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="n">accumulator</span><span class="k">:</span> <span class="kt">ACC</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="c1">// OPTIONAL</span>

  <span class="cm">/**
    * Collects a record and forwards it. The collector can output retract messages with the retract
    * method. Note: only use it in `emitRetractValueIncrementally`.
    */</span>
  <span class="k">trait</span> <span class="nc">RetractableCollector</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Collector</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>

    <span class="cm">/**
      * Retract a record.
      *
      * @param record The record to retract.
      */</span>
    <span class="k">def</span> <span class="nf">retract</span><span class="o">(</span><span class="n">record</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

  </div>
</div>

<p>下面的例子展示了如何</p>

<ul>
  <li>定义一个 <code class="highlighter-rouge">TableAggregateFunction</code> 来计算给定列的最大的 2 个值，</li>
  <li>在 <code class="highlighter-rouge">TableEnvironment</code> 中注册函数，</li>
  <li>在 Table API 查询中使用函数（当前只在 Table API 中支持 TableAggregateFunction）。</li>
</ul>

<p>为了计算最大的 2 个值，accumulator 需要保存当前看到的最大的 2 个值。在我们的例子中，我们定义了类 <code class="highlighter-rouge">Top2Accum</code> 来作为 accumulator。Flink 的 checkpoint 机制会自动保存 accumulator，并且在失败时进行恢复，来保证精确一次的语义。</p>

<p>我们的 <code class="highlighter-rouge">Top2</code> 表值聚合函数（<code class="highlighter-rouge">TableAggregateFunction</code>）的 <code class="highlighter-rouge">accumulate()</code> 方法有两个输入，第一个是 <code class="highlighter-rouge">Top2Accum</code> accumulator，另一个是用户定义的输入：输入的值 <code class="highlighter-rouge">v</code>。尽管 <code class="highlighter-rouge">merge()</code> 方法在大多数聚合类型中不是必须的，我们也在样例中提供了它的实现。请注意，我们在 Scala 样例中也使用的是 Java 的基础类型，并且定义了 <code class="highlighter-rouge">getResultType()</code> 和 <code class="highlighter-rouge">getAccumulatorType()</code> 方法，因为 Flink 的类型推导对于 Scala 的类型推导支持的不是很好。</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * Accumulator for Top2.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">first</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">second</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * The top2 user-defined table aggregate function.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2</span> <span class="kd">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">Top2Accum</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Top2Accum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Top2Accum</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span><span class="o">();</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">merge</span><span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Iterable</span><span class="o">&lt;</span><span class="nc">Top2Accum</span><span class="o">&gt;</span> <span class="n">iterable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">otherAcc</span> <span class="o">:</span> <span class="n">iterable</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">first</span><span class="o">);</span>
            <span class="n">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">otherAcc</span><span class="o">.</span><span class="na">second</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitValue</span><span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Collector</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// emit the value and rank</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 注册函数</span>
<span class="nc">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">"top2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Top2</span><span class="o">());</span>

<span class="c1">// 初始化表</span>
<span class="nc">Table</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">...;</span>

<span class="c1">// 使用函数</span>
<span class="n">tab</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"key"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="s">"top2(a) as (v, rank)"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">"key, v, rank"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>

<span class="cm">/**
 * Accumulator for top2.
 */</span>
<span class="k">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
<span class="o">}</span>

<span class="cm">/**
 * The top2 user-defined table aggregate function.
 */</span>
<span class="k">class</span> <span class="nc">Top2</span> <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]</span>, <span class="kt">Top2Accum</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2Accum</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">acc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="n">acc</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="n">v</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="n">v</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">merge</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">its</span><span class="k">:</span> <span class="kt">JIterable</span><span class="o">[</span><span class="kt">Top2Accum</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">iter</span> <span class="k">=</span> <span class="nv">its</span><span class="o">.</span><span class="py">iterator</span><span class="o">()</span>
    <span class="nf">while</span> <span class="o">(</span><span class="nv">iter</span><span class="o">.</span><span class="py">hasNext</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">top2</span> <span class="k">=</span> <span class="nv">iter</span><span class="o">.</span><span class="py">next</span><span class="o">()</span>
      <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="nv">top2</span><span class="o">.</span><span class="py">first</span><span class="o">)</span>
      <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="nv">top2</span><span class="o">.</span><span class="py">second</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">emitValue</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">out</span><span class="k">:</span> <span class="kt">Collector</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// emit the value and rank</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="o">!=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">}</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="o">!=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 初始化表</span>
<span class="k">val</span> <span class="nv">tab</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// 使用函数</span>
<span class="n">tab</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="ss">'key</span><span class="o">)</span>
  <span class="o">.</span><span class="py">flatAggregate</span><span class="o">(</span><span class="nf">top2</span><span class="o">(</span><span class="ss">'a</span><span class="o">)</span> <span class="nf">as</span> <span class="o">(</span><span class="ss">'v</span><span class="o">,</span> <span class="ss">'rank</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="ss">'key</span><span class="o">,</span> <span class="ss">'v</span><span class="o">,</span> <span class="ss">'rank</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<p>下面的例子展示了如何使用 <code class="highlighter-rouge">emitUpdateWithRetract</code> 方法来只发送更新的数据。为了只发送更新的结果，accumulator 保存了上一次的最大的2个值，也保存了当前最大的2个值。注意：如果 TopN 中的 n 非常大，这种既保存上次的结果，也保存当前的结果的方式不太高效。一种解决这种问题的方式是把输入数据直接存储到 <code class="highlighter-rouge">accumulator</code> 中，然后在调用 <code class="highlighter-rouge">emitUpdateWithRetract</code> 方法时再进行计算。</p>

<div class="codetabs">
  <div data-lang="java">

    <figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="cm">/**
 * Accumulator for Top2.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">first</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">second</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">oldFirst</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="n">oldSecond</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * The top2 user-defined table aggregate function.
 */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Top2</span> <span class="kd">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;,</span> <span class="nc">Top2Accum</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Top2Accum</span> <span class="nf">createAccumulator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Top2Accum</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span><span class="o">();</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">acc</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">accumulate</span><span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">Integer</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">second</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span><span class="nc">Top2Accum</span> <span class="n">acc</span><span class="o">,</span> <span class="nc">RetractableCollector</span><span class="o">&lt;</span><span class="nc">Tuple2</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// if there is an update, retract old value then emit new value.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">oldFirst</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// if there is an update, retract old value then emit new value.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">!=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">out</span><span class="o">.</span><span class="na">retract</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">out</span><span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Tuple2</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
            <span class="n">acc</span><span class="o">.</span><span class="na">oldSecond</span> <span class="o">=</span> <span class="n">acc</span><span class="o">.</span><span class="na">second</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 注册函数</span>
<span class="nc">StreamTableEnvironment</span> <span class="n">tEnv</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">tEnv</span><span class="o">.</span><span class="na">registerFunction</span><span class="o">(</span><span class="s">"top2"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Top2</span><span class="o">());</span>

<span class="c1">// 初始化表</span>
<span class="nc">Table</span> <span class="n">tab</span> <span class="o">=</span> <span class="o">...;</span>

<span class="c1">// 使用函数</span>
<span class="n">tab</span><span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="s">"key"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">flatAggregate</span><span class="o">(</span><span class="s">"top2(a) as (v, rank)"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="s">"key, v, rank"</span><span class="o">);</span></code></pre></figure>

  </div>

  <div data-lang="scala">

    <figure class="highlight"><pre><code class="language-scala" data-lang="scala"><span class="k">import</span> <span class="nn">java.lang.</span><span class="o">{</span><span class="nc">Integer</span> <span class="k">=&gt;</span> <span class="nc">JInteger</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.api.Types</span>
<span class="k">import</span> <span class="nn">org.apache.flink.table.functions.TableAggregateFunction</span>

<span class="cm">/**
 * Accumulator for top2.
 */</span>
<span class="k">class</span> <span class="nc">Top2Accum</span> <span class="o">{</span>
  <span class="k">var</span> <span class="n">first</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
  <span class="k">var</span> <span class="n">second</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
  <span class="k">var</span> <span class="n">oldFirst</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
  <span class="k">var</span> <span class="n">oldSecond</span><span class="k">:</span> <span class="kt">JInteger</span> <span class="o">=</span> <span class="k">_</span>
<span class="o">}</span>

<span class="cm">/**
 * The top2 user-defined table aggregate function.
 */</span>
<span class="k">class</span> <span class="nc">Top2</span> <span class="k">extends</span> <span class="nc">TableAggregateFunction</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]</span>, <span class="kt">Top2Accum</span><span class="o">]</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">createAccumulator</span><span class="o">()</span><span class="k">:</span> <span class="kt">Top2Accum</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">acc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Top2Accum</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span> <span class="k">=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span>
    <span class="n">acc</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">accumulate</span><span class="o">(</span><span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span> <span class="n">v</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="k">=</span> <span class="n">v</span>
    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">)</span> <span class="o">{</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="k">=</span> <span class="n">v</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="nf">emitUpdateWithRetract</span><span class="o">(</span>
    <span class="n">acc</span><span class="k">:</span> <span class="kt">Top2Accum</span><span class="o">,</span>
    <span class="n">out</span><span class="k">:</span> <span class="kt">RetractableCollector</span><span class="o">[</span><span class="kt">JTuple2</span><span class="o">[</span><span class="kt">JInteger</span>, <span class="kt">JInteger</span><span class="o">]])</span>
  <span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span> <span class="o">!=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract old value then emit new value.</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span> <span class="o">!=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">out</span><span class="o">.</span><span class="py">retract</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">first</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">oldFirst</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">first</span>
    <span class="o">}</span>
    <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span> <span class="o">!=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// if there is an update, retract old value then emit new value.</span>
      <span class="nf">if</span> <span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span> <span class="o">!=</span> <span class="nv">Int</span><span class="o">.</span><span class="py">MinValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="nv">out</span><span class="o">.</span><span class="py">retract</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
      <span class="o">}</span>
      <span class="nv">out</span><span class="o">.</span><span class="py">collect</span><span class="o">(</span><span class="nv">JTuple2</span><span class="o">.</span><span class="py">of</span><span class="o">(</span><span class="nv">acc</span><span class="o">.</span><span class="py">second</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
      <span class="nv">acc</span><span class="o">.</span><span class="py">oldSecond</span> <span class="k">=</span> <span class="nv">acc</span><span class="o">.</span><span class="py">second</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 初始化表</span>
<span class="k">val</span> <span class="nv">tab</span> <span class="k">=</span> <span class="o">...</span>

<span class="c1">// 使用函数</span>
<span class="n">tab</span>
  <span class="o">.</span><span class="py">groupBy</span><span class="o">(</span><span class="ss">'key</span><span class="o">)</span>
  <span class="o">.</span><span class="py">flatAggregate</span><span class="o">(</span><span class="nf">top2</span><span class="o">(</span><span class="ss">'a</span><span class="o">)</span> <span class="nf">as</span> <span class="o">(</span><span class="ss">'v</span><span class="o">,</span> <span class="ss">'rank</span><span class="o">))</span>
  <span class="o">.</span><span class="py">select</span><span class="o">(</span><span class="ss">'key</span><span class="o">,</span> <span class="ss">'v</span><span class="o">,</span> <span class="ss">'rank</span><span class="o">)</span></code></pre></figure>

  </div>
</div>

<p><a href="#top" class="top pull-right"><span class="glyphicon glyphicon-chevron-up"></span> Back to top</a></p>



<div class="footer">
  <a href="https://cwiki.apache.org/confluence/display/FLINK/Flink+Translation+Specifications" target="_blank">
    
      想参与贡献翻译？
    
  </a>
</div>


        </div>
      </div>
    </div><!-- /.container -->

    <!-- default code tab -->
    <script>var defaultCodeTab = "";</script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="//ci.apache.org/projects/flink/flink-docs-release-1.12/page/js/flink.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script>

    <!-- Disqus -->
    
  </body>
</html>
